<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: #f8f9fa;
            font-size: 13px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .scan-button, .apply-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .scan-button {
            background: #0066ff;
            color: white;
        }

        .scan-button:hover {
            background: #0052cc;
        }

        .apply-button {
            background: #00aa00;
            color: white;
        }

        .apply-button:hover {
            background: #008800;
        }

        .apply-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mapping-item {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .layer-name {
            font-weight: 500;
            color: #1a1a1a;
        }

        .layer-count {
            color: #666;
            font-size: 12px;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .data-type-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .category-select, .type-select {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .type-select:disabled {
            background: #f8f9fa;
            color: #666;
        }

        .status-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .mappings-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* Progress Screen Styles */
        .progress-screen {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 600px;
            flex-direction: column;
            gap: 20px;
            background-color: #f8f9fa;
        }

        .progress-screen.active {
            display: flex;
        }

        .progress-content {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 320px;
            width: 90%;
        }

        .progress-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e1e5e9;
            border-top: 4px solid #0066ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .progress-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .progress-warning {
            font-size: 12px;
            color: #ff6600;
            background: #fff3e0;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ffcc80;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            margin: 16px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0066ff, #00aa00);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Scan Section -->
        <div class="section">
            <div class="section-title">üîç Scan Layers</div>
            <button id="scan-button" class="scan-button">
                <span id="scan-text">Scan for % layers</span>
                <div id="scan-loading" class="loading-spinner" style="display: none;"></div>
            </button>
        </div>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Mappings Section -->
        <div class="section">
            <div class="section-title">üìù Layer Mappings</div>
            <div id="mappings-container" class="mappings-container">
                <div class="empty-state">
                    Click "Scan for % layers" to find layers that need data
                </div>
            </div>
        </div>

        <!-- Apply Section -->
        <div class="section">
            <div class="section-title">‚ú® Apply Data</div>
            <button id="apply-button" class="apply-button" disabled>
                <span id="apply-text">Apply Data to Layers</span>
                <div id="apply-loading" class="loading-spinner" style="display: none;"></div>
            </button>
        </div>

    </div>

    <!-- Progress Screen -->
    <div id="progress-screen" class="progress-screen">
        <div class="progress-content">
            <div class="progress-spinner"></div>
            <div class="progress-title">Applying Data to Layers</div>
            <div id="progress-status" class="progress-status">Preparing...</div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div class="progress-warning">‚ö†Ô∏è Do not close the plugin</div>
        </div>
    </div>

    <!-- Embedded Faker.js Implementation for Figma Plugin -->
    <script>
        console.log('üöÄ Loading embedded Faker.js implementation...');
        
        // Create a minimal but functional Faker.js implementation
        window.faker = {
            person: {
                fullName: function() {
                    var firstNames = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra'];
                    var lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson'];
                    return firstNames[Math.floor(Math.random() * firstNames.length)] + ' ' + lastNames[Math.floor(Math.random() * lastNames.length)];
                },
                firstName: function() {
                    var names = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra'];
                    return names[Math.floor(Math.random() * names.length)];
                },
                lastName: function() {
                    var names = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson'];
                    return names[Math.floor(Math.random() * names.length)];
                }
            },
            location: {
                city: function() {
                    var cities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose', 'Austin', 'Jacksonville', 'Fort Worth', 'Columbus', 'Charlotte', 'San Francisco', 'Indianapolis', 'Seattle', 'Denver', 'Washington', 'Boston', 'El Paso', 'Nashville', 'Detroit', 'Oklahoma City', 'Portland', 'Las Vegas', 'Memphis', 'Louisville', 'Baltimore'];
                    return cities[Math.floor(Math.random() * cities.length)];
                },
                country: function() {
                    var countries = ['United States', 'Canada', 'Mexico', 'Brazil', 'Argentina', 'United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Russia', 'China', 'Japan', 'India', 'Australia', 'South Africa', 'Egypt', 'Nigeria', 'Kenya', 'Morocco', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Poland', 'Greece'];
                    return countries[Math.floor(Math.random() * countries.length)];
                },
                streetAddress: function() {
                    var streets = ['Main Street', 'First Street', 'Second Street', 'Third Street', 'Park Avenue', 'Oak Street', 'Pine Street', 'Maple Avenue', 'Cedar Street', 'Elm Street', 'Washington Street', 'Lake Street', 'Hill Street', 'Church Street', 'Sunset Boulevard', 'Broadway', 'Fifth Avenue', 'Madison Avenue', 'Lincoln Street', 'Jefferson Avenue'];
                    var number = Math.floor(Math.random() * 9999) + 1;
                    return number + ' ' + streets[Math.floor(Math.random() * streets.length)];
                }
            },
            internet: {
                email: function() {
                    var domains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'company.com', 'example.com', 'test.com', 'mail.com', 'email.com', 'service.com'];
                    var names = ['john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'mark', 'anna', 'chris', 'emma', 'alex', 'maria', 'james', 'laura', 'robert', 'helen', 'paul', 'kate', 'steve', 'amy'];
                    return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 999) + '@' + domains[Math.floor(Math.random() * domains.length)];
                },
                userName: function() {
                    var names = ['user', 'admin', 'guest', 'john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'mark', 'anna', 'chris', 'emma', 'alex', 'maria', 'james', 'laura', 'robert', 'helen', 'paul'];
                    return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 9999);
                }
            },
            company: {
                name: function() {
                    var companies = ['TechCorp', 'InnovateLtd', 'GlobalSolutions', 'DataSystems', 'CloudTech', 'DigitalWorks', 'SmartSolutions', 'TechVision', 'FutureWorks', 'NextGen', 'ProTech', 'EliteServices', 'PrimeTech', 'CoreSystems', 'MegaCorp', 'UltraTech', 'PowerSolutions', 'SpeedTech', 'FlexiCorp', 'DynamicSystems'];
                    return companies[Math.floor(Math.random() * companies.length)];
                }
            },
            commerce: {
                productName: function() {
                    var products = ['Smartphone', 'Laptop', 'Tablet', 'Headphones', 'Camera', 'Watch', 'Speaker', 'Monitor', 'Keyboard', 'Mouse', 'Printer', 'Scanner', 'Router', 'Hard Drive', 'Memory Card', 'Cable', 'Charger', 'Case', 'Stand', 'Dock'];
                    var adjectives = ['Smart', 'Pro', 'Ultra', 'Premium', 'Advanced', 'Digital', 'Wireless', 'Portable', 'Compact', 'High-Tech'];
                    return adjectives[Math.floor(Math.random() * adjectives.length)] + ' ' + products[Math.floor(Math.random() * products.length)];
                }
            },
            lorem: {
                sentence: function() {
                    var sentences = [
                        'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
                        'Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',
                        'Ut enim ad minim veniam, quis nostrud exercitation ullamco.',
                        'Duis aute irure dolor in reprehenderit in voluptate velit esse.',
                        'Excepteur sint occaecat cupidatat non proident, sunt in culpa.',
                        'Nulla facilisi morbi tempus iaculis urna id volutpat lacus.',
                        'Pellentesque habitant morbi tristique senectus et netus.',
                        'Mauris blandit aliquet elit, eget tincidunt nibh pulvinar.',
                        'Vestibulum ante ipsum primis in faucibus orci luctus.',
                        'Curabitur pretium tincidunt lacus nulla gravida orci.'
                    ];
                    return sentences[Math.floor(Math.random() * sentences.length)];
                },
                paragraph: function() {
                    var paragraphs = [
                        'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.',
                        'Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
                        'Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.',
                        'Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt neque porro quisquam est.',
                        'At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.'
                    ];
                    return paragraphs[Math.floor(Math.random() * paragraphs.length)];
                },
                words: function() {
                    var words = ['lorem', 'ipsum', 'dolor', 'sit', 'amet', 'consectetur', 'adipiscing', 'elit', 'sed', 'eiusmod', 'tempor', 'incididunt', 'labore', 'dolore', 'magna', 'aliqua', 'enim', 'minim', 'veniam', 'nostrud'];
                    var count = Math.floor(Math.random() * 5) + 3; // 3-7 words
                    var result = [];
                    for (var i = 0; i < count; i++) {
                        result.push(words[Math.floor(Math.random() * words.length)]);
                    }
                    return result.join(' ');
                }
            },
            number: {
                int: function(options) {
                    var min = (options && options.min !== undefined) ? options.min : 0;
                    var max = (options && options.max !== undefined) ? options.max : 100;
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                },
                float: function(options) {
                    var min = (options && options.min !== undefined) ? options.min : 0;
                    var max = (options && options.max !== undefined) ? options.max : 100;
                    var fractionDigits = (options && options.fractionDigits !== undefined) ? options.fractionDigits : 2;
                    var value = Math.random() * (max - min) + min;
                    return parseFloat(value.toFixed(fractionDigits));
                }
            },
            date: {
                anytime: function() {
                    var now = new Date();
                    var pastDays = Math.floor(Math.random() * 365 * 2); // Random date within 2 years
                    return new Date(now.getTime() - (pastDays * 24 * 60 * 60 * 1000));
                },
                recent: function() {
                    var now = new Date();
                    var daysAgo = Math.floor(Math.random() * 30);
                    return new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
                }
            },
            phone: {
                number: function() {
                    var formats = [
                        function() { return '+1-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return '(' + (Math.floor(Math.random() * 900) + 100) + ') ' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return (Math.floor(Math.random() * 900) + 100) + '.' + (Math.floor(Math.random() * 900) + 100) + '.' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return '+44 ' + (Math.floor(Math.random() * 9000) + 1000) + ' ' + (Math.floor(Math.random() * 900000) + 100000); },
                        function() { return '+33 ' + (Math.floor(Math.random() * 9) + 1) + ' ' + (Math.floor(Math.random() * 90000000) + 10000000); },
                        function() { return '+49 ' + (Math.floor(Math.random() * 900) + 100) + ' ' + (Math.floor(Math.random() * 9000000) + 1000000); },
                        function() { return '+61 ' + (Math.floor(Math.random() * 9) + 1) + ' ' + (Math.floor(Math.random() * 90000000) + 10000000); }
                    ];
                    return formats[Math.floor(Math.random() * formats.length)]();
                }
            },
            finance: {
                amount: function() {
                    return (Math.random() * 999 + 1).toFixed(2);
                }
            }
        };
        
        // Set the loaded flag
        window.fakerLoaded = true;
        
        console.log('‚úÖ Embedded Faker.js successfully loaded!');
        console.log('Available modules:', Object.keys(window.faker));
        console.log('Sample test:', window.faker.person.fullName());
        
        // Emit ready event
        window.dispatchEvent(new CustomEvent('fakerReady', { detail: { faker: window.faker } }));
    </script>

    <script>
// Global variables
var currentMappings = [];
var scanButton = document.getElementById('scan-button');
var scanText = document.getElementById('scan-text');
var scanLoading = document.getElementById('scan-loading');
var applyButton = document.getElementById('apply-button');
var applyText = document.getElementById('apply-text');
var applyLoading = document.getElementById('apply-loading');
var mappingsContainer = document.getElementById('mappings-container');
var statusContainer = document.getElementById('status-container');
var progressScreen = document.getElementById('progress-screen');
var mainContainer = document.querySelector('.container');
var progressStatus = document.getElementById('progress-status');
var progressBar = document.getElementById('progress-bar');

// Enhanced data type configurations with options
var dataTypes = {
    // For TEXT/MIXED layers
    numbers: [
        { id: 'custom', label: 'üî¢ Custom', description: 'Custom numbers with range and formatting', hasOptions: true },
        { id: 'percentage', label: 'üìä Percentage', description: 'Random percentages (0-100%)', hasOptions: true },
        { id: 'phone', label: 'üìû Phone', description: 'Phone numbers with format options', hasOptions: true },
        { id: 'date', label: 'üìÖ Date', description: 'Dates with multiple format options', hasOptions: true },
        { id: 'finances', label: 'üí∞ Finances', description: 'Financial data (cards, accounts, etc.)', hasOptions: true }
    ],
    text: [
        { id: 'person', label: 'üë§ Person', description: 'Names, usernames, job titles, etc.', hasOptions: true },
        { id: 'email', label: 'üìß Email', description: 'Email addresses with provider options', hasOptions: true },
        { id: 'website', label: 'üåê Website', description: 'Website URLs with domain options', hasOptions: true },
        { id: 'location', label: 'üó∫Ô∏è Location', description: 'Cities, addresses, coordinates, etc.', hasOptions: true },
        { id: 'title', label: 'üì∞ Title', description: 'Post titles, company names, products, etc.', hasOptions: true },
        { id: 'long_text', label: 'üìñ Long text', description: 'Paragraphs by category', hasOptions: true }
    ],
         // For OTHER layers
     media: [
         { id: 'avatar', label: 'üë§ Avatar', description: 'Profile pictures and avatars', hasOptions: true },
         { id: 'image', label: 'üñºÔ∏è Image', description: 'Images by category', hasOptions: true },
         { id: 'color', label: 'üé® Color', description: 'Solid colors or gradients', hasOptions: true }
     ]
};

// Event listeners
scanButton.addEventListener('click', function() {
    setLoadingState(scanButton, scanText, scanLoading, true);
    parent.postMessage({ pluginMessage: { type: 'scan-layers' } }, '*');
});

applyButton.addEventListener('click', function() {
    if (currentMappings.length === 0) {
        showStatusMessage('No mappings to apply', 'error');
        return;
    }
    
    // Reset batch tracking for new operation
    resetBatchTracking();
    
    // Collect mappings with selected data types
    var mappingsToApply = [];
    for (var i = 0; i < currentMappings.length; i++) {
        var mapping = currentMappings[i];
        if (mapping.dataTypeId) {
            mappingsToApply.push({
                layerName: mapping.layerName,
                dataTypeId: mapping.dataTypeId
            });
        }
    }
    
    if (mappingsToApply.length === 0) {
        showStatusMessage('Please select data types for at least one mapping', 'error');
        return;
    }
    
    // Calculate total individual layers for progress tracking
    var totalLayers = 0;
    for (var i = 0; i < currentMappings.length; i++) {
        var mapping = currentMappings[i];
        if (mapping.dataTypeId) {
            totalLayers += mapping.count; // mapping.count is the number of individual layers
        }
    }
    
    // Show progress screen immediately
    showProgressScreen(totalLayers);
    
    setLoadingState(applyButton, applyText, applyLoading, true);
    parent.postMessage({ 
        pluginMessage: { 
            type: 'apply-data', 
            mappings: mappingsToApply 
        } 
    }, '*');
});

// Utility functions
function setLoadingState(button, textElement, loadingElement, isLoading) {
    if (isLoading) {
        textElement.style.display = 'none';
        loadingElement.style.display = 'block';
        button.disabled = true;
    } else {
        textElement.style.display = 'block';
        loadingElement.style.display = 'none';
        button.disabled = false;
    }
}

function showStatusMessage(message, type) {
    var messageDiv = document.createElement('div');
    messageDiv.className = 'status-message status-' + (type || 'success');
    messageDiv.textContent = message;
    
    statusContainer.innerHTML = '';
    statusContainer.appendChild(messageDiv);
    
    setTimeout(function() {
        if (statusContainer.contains(messageDiv)) {
            statusContainer.removeChild(messageDiv);
        }
    }, 5000);
}

// Progress screen functions
function showProgressScreen(totalLayers) {
    mainContainer.style.display = 'none';
    progressScreen.classList.add('active');
    updateProgress(0, totalLayers);
}

function hideProgressScreen() {
    progressScreen.classList.remove('active');
    mainContainer.style.display = 'block';
    resetProgress();
}

function updateProgress(completed, total) {
    var percentage = Math.round((completed / total) * 100);
    progressBar.style.width = percentage + '%';
    progressStatus.textContent = 'Applying data to ' + completed + '/' + total + ' layers';
}

function resetProgress() {
    progressBar.style.width = '0%';
    progressStatus.textContent = 'Preparing...';
}

// Get available categories based on layer type
function getAvailableCategoriesForLayerType(layerType) {
    switch (layerType) {
        case 'TEXT':
            return ['numbers', 'text']; // Text layers get numbers and text options
        case 'OTHER':
            return ['media']; // Non-text layers get media options
        case 'MIXED':
            return ['numbers', 'text', 'media']; // Mixed layers get all options
        default:
            return ['numbers', 'text']; // Default fallback for text layers
    }
}

// Auto-populate a mapping with saved configuration
function autoPopulateMapping(layerName, dataTypeId, layerType) {
    // Find the mapping item in DOM
    var mappingItems = document.querySelectorAll('.mapping-item');
    var targetItem = null;
    
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            targetItem = item;
            break;
        }
    }
    
    if (!targetItem) return;
    
    // Determine which category this dataTypeId belongs to
    var category = null;
    for (var cat in dataTypes) {
        for (var j = 0; j < dataTypes[cat].length; j++) {
            if (dataTypes[cat][j].id === dataTypeId) {
                category = cat;
                break;
            }
        }
        if (category) break;
    }
    
    if (!category) return;
    
    // Set the category dropdown
    var categorySelect = targetItem.querySelector('.category-select');
    if (categorySelect) {
        categorySelect.value = category;
        
        // Trigger the category change to populate type dropdown
        handleCategoryChange(layerName, category);
        
        // Set the type dropdown
        setTimeout(function() {
            var typeSelect = targetItem.querySelector('.type-select');
            if (typeSelect) {
                typeSelect.value = dataTypeId;
                handleTypeChange(layerName, dataTypeId);
                
                // Show integer controls if this is an integer type
                if (dataTypeId === 'integer') {
                    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
                    var integerControls = document.getElementById('integer-controls-' + cleanLayerName);
                    if (integerControls) {
                        integerControls.style.display = 'block';
                        
                        // Populate controls with saved settings if available
                        setTimeout(function() {
                            populateIntegerControlsFromSettings();
                        }, 100);
                    }
                }
            }
        }, 50); // Small delay to ensure category change has processed
    }
}

function renderMappings(mappings, savedConfigurations) {
    currentMappings = mappings;
    savedConfigurations = savedConfigurations || {};
    
    if (mappings.length === 0) {
        mappingsContainer.innerHTML = '<div class="empty-state">No layers with % prefixes found</div>';
        applyButton.disabled = true;
        return;
    }
    
    var html = '';
    for (var i = 0; i < mappings.length; i++) {
        var mapping = mappings[i];
        
        // Get available categories for this layer type
        var availableCategories = getAvailableCategoriesForLayerType(mapping.layerType);
        
        // Build category options HTML based on layer type
        var categoryOptionsHTML = '<option value="">Select Category</option>';
        for (var j = 0; j < availableCategories.length; j++) {
            var cat = availableCategories[j];
            switch (cat) {
                case 'numbers':
                    categoryOptionsHTML += '<option value="numbers">üî¢ Numbers</option>';
                    break;
                case 'text':
                    categoryOptionsHTML += '<option value="text">üìù Text</option>';
                    break;
                case 'media':
                    categoryOptionsHTML += '<option value="media">üñºÔ∏è Media</option>';
                    break;
            }
        }
        
        // Add layer type indicator
        var layerTypeIndicator = '';
        switch (mapping.layerType) {
            case 'TEXT':
                layerTypeIndicator = '<div style="color: #0066ff; font-size: 11px; margin-bottom: 6px;">üìù Text layers</div>';
                break;
            case 'OTHER':
                layerTypeIndicator = '<div style="color: #ff6600; font-size: 11px; margin-bottom: 6px;">üñºÔ∏è Image layers</div>';
                break;
            case 'MIXED':
                layerTypeIndicator = '<div style="color: #9933cc; font-size: 11px; margin-bottom: 6px;">üéØ Mixed layers</div>';
                break;
        }
        
        // Add saved configuration indicator
        var savedConfigIndicator = '';
        if (mapping.isPreConfigured) {
            savedConfigIndicator = '<div style="color: #00aa00; font-size: 11px; margin-bottom: 6px;">üíæ Previously configured</div>';
        }
        
        html += '<div class="mapping-item">';
        html += '<div class="mapping-header">';
        html += '<div>';
        html += '<div class="layer-name">' + mapping.layerName + '</div>';
        html += '<div class="layer-count">' + mapping.count + ' layer' + (mapping.count > 1 ? 's' : '') + '</div>';
        html += '</div>';
        html += '<button class="remove-btn" onclick="handleRemoveMapping(\'' + mapping.layerName + '\')">Remove</button>';
        html += '</div>';
        html += layerTypeIndicator;
        html += savedConfigIndicator;
        html += '<div class="data-type-selector">';
        
        // Category selector with filtered options
        html += '<select class="category-select" onchange="handleCategoryChange(\'' + mapping.layerName + '\', this.value)">';
        html += categoryOptionsHTML;
        html += '</select>';
        
        // Type selector
        html += '<select class="type-select" disabled onchange="handleTypeChange(\'' + mapping.layerName + '\', this.value)">';
        html += '<option value="">Select Type</option>';
        html += '</select>';
        
        html += '</div>';
        
        // Configuration panel (initially hidden, will be shown when a data type with options is selected)
        var cleanLayerName = mapping.layerName.replace(/[^a-zA-Z0-9]/g, '');
        html += '<div class="config-panel" id="config-panel-' + cleanLayerName + '" style="display: none; margin-top: 12px; padding: 12px; background: #f0f4f8; border-radius: 6px; border: 1px solid #e1e8ed;">';
        html += '<div class="config-content" id="config-content-' + cleanLayerName + '"></div>';
        html += '</div>';
        html += '</div>';
    }
    
    mappingsContainer.innerHTML = html;
    
    // Auto-populate saved configurations
    for (var i = 0; i < mappings.length; i++) {
        var mapping = mappings[i];
        if (mapping.dataTypeId) {
            autoPopulateMapping(mapping.layerName, mapping.dataTypeId, mapping.layerType);
        }
    }
    
    applyButton.disabled = false;
    
    // Load integer settings after rendering
    loadIntegerSettings();
}

function handleRemoveMapping(layerName) {
    parent.postMessage({ 
        pluginMessage: { 
            type: 'remove-mapping', 
            layerName: layerName 
        } 
    }, '*');
}

function handleCategoryChange(layerName, category) {
    var mappingItem = document.querySelector('[data-layer="' + layerName + '"]');
    if (!mappingItem) {
        // Find by layer name in the DOM
        var mappingItems = document.querySelectorAll('.mapping-item');
        for (var i = 0; i < mappingItems.length; i++) {
            var item = mappingItems[i];
            var nameElement = item.querySelector('.layer-name');
            if (nameElement && nameElement.textContent === layerName) {
                mappingItem = item;
                break;
            }
        }
    }
    
    if (!mappingItem) return;
    
    var typeSelect = mappingItem.querySelector('.type-select');
    
    // Clear and populate type select
    typeSelect.innerHTML = '<option value="">Select Type</option>';
    
    if (category && dataTypes[category]) {
        typeSelect.disabled = false;
        var types = dataTypes[category];
        for (var i = 0; i < types.length; i++) {
            var type = types[i];
            var option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.label;
            typeSelect.appendChild(option);
        }
    } else {
        typeSelect.disabled = true;
    }
    
    // Update mapping
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            currentMappings[i].dataTypeId = null;
            break;
        }
    }
}

function handleTypeChange(layerName, dataTypeId) {
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            currentMappings[i].dataTypeId = dataTypeId;
            break;
        }
    }
    
    // Show/hide configuration panel based on selection
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var configPanel = document.getElementById('config-panel-' + cleanLayerName);
    var configContent = document.getElementById('config-content-' + cleanLayerName);
    
    if (!configPanel || !configContent) return;
    
    // Find the data type configuration
    var dataType = null;
    for (var category in dataTypes) {
        for (var j = 0; j < dataTypes[category].length; j++) {
            if (dataTypes[category][j].id === dataTypeId) {
                dataType = dataTypes[category][j];
                break;
            }
        }
        if (dataType) break;
    }
    
    if (dataType && dataType.hasOptions) {
        configPanel.style.display = 'block';
        configContent.innerHTML = generateConfigHTML(dataTypeId, layerName);
        
        // Set up preview for custom numbers
        if (dataTypeId === 'custom') {
            setupCustomNumberPreview(layerName);
        }
    } else {
        configPanel.style.display = 'none';
        configContent.innerHTML = '';
    }
}

// Generate configuration HTML for data types with options
function generateConfigHTML(dataTypeId, layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var html = '';
    
    switch (dataTypeId) {
        case 'custom':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üî¢ Custom Number Settings</div>';
            
            // Range inputs
            html += '<div style="display: flex; gap: 12px; margin-bottom: 12px;">';
            html += '<div style="flex: 1;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Min Value</label>';
            html += '<input type="number" id="min-' + cleanLayerName + '" value="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Max Value</label>';
            html += '<input type="number" id="max-' + cleanLayerName + '" value="1000" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '</div>';
            
            // Checkboxes
            html += '<div style="display: flex; gap: 16px; margin-bottom: 12px;">';
            html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">';
            html += '<input type="checkbox" id="decimals-' + cleanLayerName + '">';
            html += '<span style="font-size: 12px;">Include 2 decimals</span>';
            html += '</label>';
            html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">';
            html += '<input type="checkbox" id="format-' + cleanLayerName + '">';
            html += '<span style="font-size: 12px;">Format with commas</span>';
            html += '</label>';
            html += '</div>';
            
            // Prefix and sorting
            html += '<div style="display: flex; gap: 12px; margin-bottom: 12px;">';
            html += '<div style="flex: 1;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Prefix</label>';
            html += '<input type="text" id="prefix-' + cleanLayerName + '" placeholder="e.g., $, #" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="ascending">Ascending</option>';
            html += '<option value="descending">Descending</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            
            // Preview
            html += '<div style="padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; color: #666;">';
            html += '<span style="font-weight: 500;">Preview:</span> <span id="preview-' + cleanLayerName + '">1,234</span>';
            html += '</div>';
            
            // Store the layer name for later event listener setup
            if (!window.customNumberLayers) {
                window.customNumberLayers = [];
            }
            window.customNumberLayers.push(cleanLayerName);
            break;
            
        case 'percentage':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üìä Percentage Settings</div>';
            html += '<div style="display: flex; gap: 16px; margin-bottom: 12px;">';
            html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">';
            html += '<input type="checkbox" id="decimals-' + cleanLayerName + '">';
            html += '<span style="font-size: 12px;">Include 2 decimals</span>';
            html += '</label>';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="ascending">Ascending</option>';
            html += '<option value="descending">Descending</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'phone':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üìû Phone Settings</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Format</label>';
            html += '<select id="phoneFormat-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="human">Human Readable</option>';
            html += '<option value="national">National Format</option>';
            html += '<option value="international">International Format</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'date':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üìÖ Date Settings</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Format</label>';
            html += '<select id="dateFormat-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="MM/DD/YYYY">MM/DD/YYYY</option>';
            html += '<option value="DD/MM/YYYY">DD/MM/YYYY</option>';
            html += '<option value="YYYY/MM/DD">YYYY/MM/DD</option>';
            html += '<option value="year">Year only</option>';
            html += '<option value="month">Month only</option>';
            html += '<option value="weekday">Weekday only</option>';
            html += '</select>';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="recent">Most Recent</option>';
            html += '<option value="oldest">Oldest</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'finances':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üí∞ Finance Settings</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Type</label>';
            html += '<select id="financeType-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="credit-card">Credit Card Number</option>';
            html += '<option value="account-number">Account Number</option>';
            html += '<option value="bitcoin">Bitcoin Address</option>';
            html += '<option value="iban">IBAN</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'person':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üë§ Person Settings</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Type</label>';
            html += '<select id="personType-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="full-name">Full Name</option>';
            html += '<option value="first-name">First Name</option>';
            html += '<option value="last-name">Last Name</option>';
            html += '<option value="username">Username</option>';
            html += '<option value="gender">Gender</option>';
            html += '<option value="job-title">Job Title</option>';
            html += '<option value="password">Password</option>';
            html += '</select>';
            html += '</div>';
            html += '<div style="display: flex; gap: 12px; margin-bottom: 12px;">';
            html += '<div style="flex: 1;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Prefix</label>';
            html += '<input type="text" id="customPrefix-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Suffix</label>';
            html += '<input type="text" id="customSuffix-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'email':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üìß Email Settings</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Provider (optional)</label>';
            html += '<input type="text" id="provider-' + cleanLayerName + '" placeholder="e.g., gmail.com" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'website':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üåê Website Settings</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Domain Suffix (optional)</label>';
            html += '<input type="text" id="domain-' + cleanLayerName + '" placeholder="e.g., .com, .org" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">';
            html += '<input type="checkbox" id="includeProtocol-' + cleanLayerName + '" checked>';
            html += '<span style="font-size: 12px;">Include https://</span>';
            html += '</label>';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'location':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üó∫Ô∏è Location Settings</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Type</label>';
            html += '<select id="locationType-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="city">City</option>';
            html += '<option value="country">Country</option>';
            html += '<option value="full-address">Full Address</option>';
            html += '<option value="street-address">Street Address</option>';
            html += '<option value="zip-code">ZIP Code</option>';
            html += '<option value="country-code">Country Code</option>';
            html += '<option value="coordinates">Coordinates</option>';
            html += '</select>';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'title':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üì∞ Title Settings</div>';
            html += '<div style="margin-bottom: 12px;">';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Type</label>';
            html += '<select id="titleType-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="post-title">Post Title</option>';
            html += '<option value="company-name">Company Name</option>';
            html += '<option value="product-name">Product Name</option>';
            html += '<option value="food">Food</option>';
            html += '<option value="animal">Animal</option>';
            html += '<option value="song-title">Song Title</option>';
            html += '<option value="music-artist">Music Artist</option>';
            html += '<option value="random-word">Random Word</option>';
            html += '</select>';
            html += '</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
            html += '<select id="sort-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'long_text':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üìñ Long Text Settings</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Category</label>';
            html += '<select id="textCategory-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="any">Any Category</option>';
            html += '<option value="technology">Technology</option>';
            html += '<option value="biography">Biography</option>';
            html += '<option value="history">History</option>';
            html += '<option value="nature">Nature</option>';
            html += '<option value="medicine">Medicine</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'avatar':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üë§ Avatar Settings</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Type</label>';
            html += '<select id="avatarType-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="any">Any Avatar</option>';
            html += '<option value="real-people">Real People</option>';
            html += '<option value="male">Only Male</option>';
            html += '<option value="female">Only Female</option>';
            html += '<option value="robots">Robots</option>';
            html += '<option value="cartoon">Cartoon</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'image':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üñºÔ∏è Image Settings</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Category</label>';
            html += '<select id="imageCategory-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="any">Any Category</option>';
            html += '<option value="products">Products</option>';
            html += '<option value="landscapes">Landscapes</option>';
            html += '</select>';
            html += '</div>';
            break;
            
        case 'color':
            html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üé® Color Settings</div>';
            html += '<div>';
            html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Type</label>';
            html += '<select id="colorType-' + cleanLayerName + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">';
            html += '<option value="solid">Solid Color</option>';
            html += '<option value="gradient">Gradient</option>';
            html += '</select>';
            html += '</div>';
            break;
    }
    
    return html;
}

// Store configuration settings for each mapping
var configSettings = {};

// Configuration storage key for integer settings
var INTEGER_SETTINGS_STORAGE_KEY = 'integerSettings';

// Store integer generation context
var currentIntegerGenerationContext = {
    layerName: null,
    count: 0,
    generatedNumbers: []
};

// Batch-level anti-repetition system - prevents repetition within current operation
var currentBatchUsedContent = {};

// Function to get non-repeated content from an array within current batch
function getUniqueFromBatch(contentArray, categoryKey) {
    if (!contentArray || contentArray.length === 0) {
        return null;
    }
    
    // Initialize tracking for this category if not exists
    if (!currentBatchUsedContent[categoryKey]) {
        currentBatchUsedContent[categoryKey] = [];
    }
    
    var usedInBatch = currentBatchUsedContent[categoryKey];
    
    // Find available (not used in this batch) items
    var availableItems = contentArray.filter(function(item) {
        return usedInBatch.indexOf(item) === -1;
    });
    
    // If no available items, reset batch tracking for this category
    if (availableItems.length === 0) {
        currentBatchUsedContent[categoryKey] = [];
        availableItems = contentArray;
    }
    
    // Select from available items
    var selectedItem = availableItems[Math.floor(Math.random() * availableItems.length)];
    
    // Track this selection in current batch
    currentBatchUsedContent[categoryKey].push(selectedItem);
    
    return selectedItem;
}

// Reset batch tracking when starting a new operation
function resetBatchTracking() {
    currentBatchUsedContent = {};
}

function generateCustomIntegerArray(count, layerName) {
    // Get settings for the layer
    var settings = integerSettings[layerName] || {
        includeDecimals: false,
        formatWithCommas: false,
        minValue: 1,
        maxValue: 1000,
        prefix: '',
        sortOrder: 'none'
    };
    
    var minVal = settings.minValue;
    var maxVal = settings.maxValue;
    
    // Ensure min is less than max
    if (minVal >= maxVal) {
        maxVal = minVal + 1000;
    }
    
    var numbers = [];
    var generatedSet = new Set();
    var maxAttempts = Math.min(1000, (maxVal - minVal + 1) * 2); // Reasonable limit for unique attempts
    
    // Generate the required number of values
    for (var i = 0; i < count; i++) {
        var number;
        var attempts = 0;
        
        // Try to generate a unique number
        do {
            if (settings.includeDecimals) {
                // Generate with 2 decimal places
                var baseNumber = Math.random() * (maxVal - minVal) + minVal;
                number = Math.round(baseNumber * 100) / 100;
            } else {
                // Generate integer
                number = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
            }
            attempts++;
        } while (generatedSet.has(number) && attempts < maxAttempts);
        
        // Add to set to track uniqueness
        generatedSet.add(number);
        numbers.push(number);
    }
    
    // Apply sorting if specified
    if (settings.sortOrder === 'ascending') {
        numbers.sort(function(a, b) { return a - b; });
    } else if (settings.sortOrder === 'descending') {
        numbers.sort(function(a, b) { return b - a; });
    }
    // 'none' means no sorting - keep random order
    
    // Format all numbers
    var formattedNumbers = numbers.map(function(number) {
        var formattedNumber = number.toString();
        
        if (settings.formatWithCommas && !settings.includeDecimals) {
            // Add comma formatting for integers
            formattedNumber = number.toLocaleString();
        } else if (settings.formatWithCommas && settings.includeDecimals) {
            // Add comma formatting for decimals (ensure 2 decimal places)
            formattedNumber = number.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } else if (settings.includeDecimals) {
            // Ensure 2 decimal places without comma formatting
            formattedNumber = number.toFixed(2);
        }
        
        // Add prefix if specified
        if (settings.prefix) {
            formattedNumber = settings.prefix + formattedNumber;
        }
        
        return formattedNumber;
    });
    
    return formattedNumbers;
}

// Legacy function for single number generation (fallback)
function generateCustomInteger() {
    // This function is kept for backwards compatibility but shouldn't be used
    // in the new array-based generation approach
    console.warn('‚ö†Ô∏è Using legacy single integer generation - should use array generation instead');
    var settings = integerSettings[currentIntegerGenerationContext.layerName] || {
        includeDecimals: false,
        formatWithCommas: false,
        minValue: 1,
        maxValue: 1000,
        prefix: '',
        sortOrder: 'none'
    };
    
    var minVal = settings.minValue;
    var maxVal = settings.maxValue;
    
    if (minVal >= maxVal) {
        maxVal = minVal + 1000;
    }
    
    var number;
    if (settings.includeDecimals) {
        var baseNumber = Math.random() * (maxVal - minVal) + minVal;
        number = Math.round(baseNumber * 100) / 100;
    } else {
        number = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
    }
    
    var formattedNumber = number.toString();
    
    if (settings.formatWithCommas && !settings.includeDecimals) {
        formattedNumber = number.toLocaleString();
    } else if (settings.formatWithCommas && settings.includeDecimals) {
        formattedNumber = number.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } else if (settings.includeDecimals) {
        formattedNumber = number.toFixed(2);
    }
    
    if (settings.prefix) {
        formattedNumber = settings.prefix + formattedNumber;
    }
    
    return formattedNumber;
}

function updateIntegerSettings(layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    var decimalsCheckbox = document.getElementById('decimals-' + cleanLayerName);
    var formatCheckbox = document.getElementById('format-' + cleanLayerName);
    var minInput = document.getElementById('min-' + cleanLayerName);
    var maxInput = document.getElementById('max-' + cleanLayerName);
    var prefixInput = document.getElementById('prefix-' + cleanLayerName);
    var sortSelect = document.getElementById('sort-' + cleanLayerName);
    
    if (!integerSettings[layerName]) {
        integerSettings[layerName] = {};
    }
    
    integerSettings[layerName] = {
        includeDecimals: decimalsCheckbox ? decimalsCheckbox.checked : false,
        formatWithCommas: formatCheckbox ? formatCheckbox.checked : false,
        minValue: minInput ? parseInt(minInput.value) || 1 : 1,
        maxValue: maxInput ? parseInt(maxInput.value) || 1000 : 1000,
        prefix: prefixInput ? prefixInput.value || '' : '',
        sortOrder: sortSelect ? sortSelect.value || 'none' : 'none'
    };
    
    console.log('Updated integer settings for', layerName, ':', integerSettings[layerName]);
    
    // Auto-save integer settings
    saveIntegerSettings();
}

// Save integer settings to storage
function saveIntegerSettings() {
    try {
        parent.postMessage({
            pluginMessage: {
                type: 'store-integer-settings',
                data: integerSettings
            }
        }, '*');
        console.log('üíæ Integer settings saved');
    } catch (error) {
        console.error('Error saving integer settings:', error);
    }
}

// Load integer settings from storage  
function loadIntegerSettings() {
    try {
        parent.postMessage({
            pluginMessage: {
                type: 'load-integer-settings'
            }
        }, '*');
    } catch (error) {
        console.error('Error loading integer settings:', error);
    }
}

// Populate integer controls with loaded settings
function populateIntegerControlsFromSettings() {
    // Go through all current mappings and populate integer controls
    for (var layerName in integerSettings) {
        var settings = integerSettings[layerName];
        var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
        
        // Check if controls exist for this layer
        var decimalsCheckbox = document.getElementById('decimals-' + cleanLayerName);
        if (decimalsCheckbox) {
            decimalsCheckbox.checked = settings.includeDecimals || false;
        }
        
        var formatCheckbox = document.getElementById('format-' + cleanLayerName);
        if (formatCheckbox) {
            formatCheckbox.checked = settings.formatWithCommas || false;
        }
        
        var minInput = document.getElementById('min-' + cleanLayerName);
        if (minInput) {
            minInput.value = settings.minValue || 1;
        }
        
        var maxInput = document.getElementById('max-' + cleanLayerName);
        if (maxInput) {
            maxInput.value = settings.maxValue || 1000;
        }
        
        var prefixInput = document.getElementById('prefix-' + cleanLayerName);
        if (prefixInput) {
            prefixInput.value = settings.prefix || '';
        }
        
        var sortSelect = document.getElementById('sort-' + cleanLayerName);
        if (sortSelect) {
            sortSelect.value = settings.sortOrder || 'none';
        }
        
        console.log('üîß Populated integer controls for', layerName, 'with settings:', settings);
    }
}

// Enhanced data generation function
function generateData(dataTypeId, count, layerName) {
    console.log('üîÑ Generating data for:', dataTypeId, 'count:', count, 'layer:', layerName);
    
    // Handle special external API types first
    if (dataTypeId === 'avatar_randomuser') {
        return fetchRandomUserPhotos(count);
    }
    
    if (dataTypeId === 'avatar_randomuser_male') {
        return fetchRandomUserPhotos(count, 'male');
    }
    
    if (dataTypeId === 'avatar_randomuser_female') {
        return fetchRandomUserPhotos(count, 'female');
    }
    
    if (dataTypeId === 'avatar_pravatar') {
        return fetchPravatarPhotos(count);
    }
    
    if (dataTypeId === 'avatar_multiavatar') {
        return fetchMultiavatarPhotos(count);
    }
    
    if (dataTypeId === 'avatar_robohash') {
        return fetchRobohashPhotos(count);
    }
    
    if (dataTypeId === 'user_api') {
        return fetch('https://randomuser.me/api/?results=' + count)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                return data.results.map(function(user) {
                    return user.name.first + ' ' + user.name.last;
                });
            })
            .catch(function(error) {
                console.error('RandomUser API failed:', error);
                return Array(count).fill('API Error');
            });
    }
    
    if (dataTypeId === 'product_api') {
        return fetch('https://dummyjson.com/products?limit=' + Math.min(count, 100))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var results = [];
                for (var i = 0; i < count; i++) {
                    results.push(data.products[i % data.products.length].title);
                }
                return results;
            })
            .catch(function(error) {
                console.error('DummyJSON API failed:', error);
                return Array(count).fill('API Error');
            });
    }
    
    if (dataTypeId === 'product_image') {
        return fetch('https://dummyjson.com/products?limit=' + Math.min(count, 100))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var images = data.products.map(function(product) {
                    return product.thumbnail;
                });
                var result = [];
                for (var i = 0; i < count; i++) {
                    result.push(images[i % images.length]);
                }
                return result;
            })
            .catch(function(error) {
                console.error('DummyJSON API failed:', error);
                var fallback = [];
                for (var i = 0; i < count; i++) {
                    fallback.push('https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000));
                }
                return fallback;
            });
    }
    
    // Handle new enhanced data types
    if (window.fakerLoaded && window.faker) {
        console.log('üé≤ Using enhanced Faker.js generation for:', dataTypeId);
        
        var results = [];
        for (var i = 0; i < count; i++) {
            var value = generateSingleValue(dataTypeId, layerName);
            results.push(String(value));
        }
        
        // Apply sorting if configured
        var config = getConfigForLayer(dataTypeId, layerName);
        if (config && config.sorting && config.sorting !== 'random') {
            results = applySorting(results, config.sorting, dataTypeId);
        }
        
        console.log('‚úÖ Generated', results.length, 'items for:', dataTypeId);
        console.log('Sample data:', results.slice(0, 3));
        return Promise.resolve(results);
    }
    
    // Fallback if Faker.js is not loaded
    return Promise.resolve(generateDataFallback(dataTypeId, count, layerName));
}

// Generate a single value based on data type ID and layer configuration
function generateSingleValue(dataTypeId, layerName) {
    // Get configuration for this layer if available
    var config = getConfigForLayer(dataTypeId, layerName);
    
    switch (dataTypeId) {
        // NUMBERS
        case 'custom':
            var min = config.min || 1;
            var max = config.max || 1000;
            var decimals = config.decimals || false;
            var format = config.format || false;
            var prefix = config.prefix || '';
            
            var value = Math.random() * (max - min) + min;
            
            if (!decimals) {
                value = Math.floor(value);
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            var result = value.toString();
            
            if (format && value >= 1000) {
                result = value.toLocaleString();
            }
            
            if (decimals && !result.includes('.')) {
                result += '.00';
            }
            
            return prefix + result;
            
        case 'percentage':
            var decimals = config.decimals || false;
            var value = Math.random() * 100;
            
            if (!decimals) {
                value = Math.floor(value);
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            return value + '%';
            
        case 'phone':
            var format = config.phoneFormat || 'human';
            
            switch (format) {
                case 'national':
                    return window.faker.phone.number('###-###-####');
                case 'international':
                    return window.faker.phone.number('+1-###-###-####');
                default: // human
                    return window.faker.phone.number();
            }
            
        case 'date':
            var format = config.dateFormat || 'MM/DD/YYYY';
            var date = window.faker.date.anytime();
            
            switch (format) {
                case 'DD/MM/YYYY':
                    return date.toLocaleDateString('en-GB');
                case 'YYYY/MM/DD':
                    return date.toISOString().split('T')[0];
                case 'year':
                    return date.getFullYear().toString();
                case 'month':
                    return date.toLocaleDateString('en-US', { month: 'long' });
                case 'weekday':
                    return date.toLocaleDateString('en-US', { weekday: 'long' });
                default: // MM/DD/YYYY
                    return date.toLocaleDateString('en-US');
            }
            
        case 'finances':
            var type = config.financeType || 'credit-card';
            
            switch (type) {
                case 'account-number':
                    // Use fallback if function doesn't exist
                    if (window.faker.finance.accountNumber) {
                        return window.faker.finance.accountNumber();
                    } else {
                        // Generate simple account number fallback
                        return Math.floor(Math.random() * 900000000) + 100000000;
                    }
                case 'bitcoin':
                    // Use fallback if function doesn't exist
                    if (window.faker.finance.bitcoinAddress) {
                        return window.faker.finance.bitcoinAddress();
                    } else {
                        // Generate simple Bitcoin address fallback
                        var chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
                        var result = '1';
                        for (var i = 0; i < 33; i++) {
                            result += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return result;
                    }
                case 'iban':
                    // Use fallback if function doesn't exist
                    if (window.faker.finance.iban) {
                        return window.faker.finance.iban();
                    } else {
                        // Generate simple IBAN fallback
                        var countryCode = ['DE', 'FR', 'ES', 'IT', 'GB'][Math.floor(Math.random() * 5)];
                        var checkDigits = Math.floor(Math.random() * 90) + 10;
                        var bankCode = Math.floor(Math.random() * 90000000) + 10000000;
                        return countryCode + checkDigits + bankCode;
                    }
                default: // credit-card
                    // Use fallback if function doesn't exist
                    var cardNumber;
                    if (window.faker.finance.creditCardNumber) {
                        cardNumber = window.faker.finance.creditCardNumber();
                    } else {
                        // Generate simple credit card number fallback
                        var prefixes = ['4', '5', '37', '6'];
                        var prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
                        cardNumber = prefix;
                        while (cardNumber.length < 16) {
                            cardNumber += Math.floor(Math.random() * 10);
                        }
                        cardNumber = cardNumber.substring(0, 16);
                    }
                    
                    // Format credit card number with spaces every 4 digits
                    return cardNumber.replace(/(.{4})/g, '$1 ').trim();
            }
            
        // TEXT
        case 'person':
            var type = config.personType || 'full-name';
            var prefix = config.customPrefix || '';
            var suffix = config.customSuffix || '';
            
            var result = '';
            
            switch (type) {
                case 'first-name':
                    result = window.faker.person.firstName();
                    break;
                case 'last-name':
                    result = window.faker.person.lastName();
                    break;
                case 'username':
                    result = window.faker.internet.userName();
                    break;
                case 'gender':
                    result = window.faker.person.gender();
                    break;
                case 'job-title':
                    result = window.faker.person.jobTitle();
                    break;
                case 'password':
                    result = window.faker.internet.password();
                    break;
                default: // full-name
                    result = window.faker.person.fullName();
            }
            
            return prefix + result + suffix;
            
        case 'email':
            var provider = config.provider;
            
            if (provider) {
                return window.faker.internet.email({ provider });
            }
            
            return window.faker.internet.email();
            
        case 'website':
            var domain = config.domain;
            var includeProtocol = config.includeProtocol !== false; // Default to true if not specified
            
            try {
                var generatedUrl;
                
                if (domain) {
                    // Get a base URL and replace the domain
                    var baseUrl = window.faker.internet.url();
                    // Replace the existing domain with the custom one
                    var urlParts = baseUrl.split('://');
                    var protocol = urlParts[0];
                    var domainPart = urlParts[1].split('/')[0];
                    var path = urlParts[1].substring(domainPart.length);
                    
                    if (includeProtocol) {
                        generatedUrl = protocol + '://' + window.faker.internet.domainWord() + domain + path;
                    } else {
                        generatedUrl = window.faker.internet.domainWord() + domain + path;
                    }
                } else {
                    var baseUrl = window.faker.internet.url();
                    if (includeProtocol) {
                        generatedUrl = baseUrl;
                    } else {
                        // Remove protocol from URL
                        generatedUrl = baseUrl.replace(/^https?:\/\//, '');
                    }
                }
                
                return generatedUrl;
            } catch (error) {
                // Fallback website generation
                var domains = ['.com', '.org', '.net', '.io', '.co'];
                var subdomains = ['www', 'app', 'blog', 'shop', 'store', 'news'];
                var words = ['tech', 'digital', 'creative', 'smart', 'future', 'global', 'rapid', 'blue', 'green', 'nova'];
                
                var subdomain = subdomains[Math.floor(Math.random() * subdomains.length)];
                var word = words[Math.floor(Math.random() * words.length)];
                var domainExt = domain || domains[Math.floor(Math.random() * domains.length)];
                
                var websiteUrl = subdomain + '.' + word + domainExt;
                
                if (includeProtocol) {
                    return 'https://' + websiteUrl;
                } else {
                    return websiteUrl;
                }
            }
            
        case 'location':
            var type = config.locationType || 'city';
            
            switch (type) {
                case 'country':
                    return window.faker.location.country();
                case 'full-address':
                    // Create full address with fallbacks
                    try {
                        return window.faker.location.streetAddress() + ', ' + window.faker.location.city() + ', ' + window.faker.location.state();
                    } catch (error) {
                        var streetNumbers = [123, 456, 789, 1001, 2345];
                        var streetNames = ['Main St', 'Oak Ave', 'First St', 'Park Dr', 'Elm St', 'Maple Ave', 'Cedar Ln', 'Pine St'];
                        var cities = ['Springfield', 'Franklin', 'Georgetown', 'Madison', 'Riverside'];
                        var states = ['CA', 'NY', 'TX', 'FL', 'IL'];
                        
                        var streetNum = streetNumbers[Math.floor(Math.random() * streetNumbers.length)];
                        var streetName = streetNames[Math.floor(Math.random() * streetNames.length)];
                        var city = cities[Math.floor(Math.random() * cities.length)];
                        var state = states[Math.floor(Math.random() * states.length)];
                        
                        return streetNum + ' ' + streetName + ', ' + city + ', ' + state;
                    }
                case 'street-address':
                    // Create street address with fallback
                    try {
                        return window.faker.location.streetAddress();
                    } catch (error) {
                        var streetNumbers = [123, 456, 789, 1001, 2345, 567, 890, 1234];
                        var streetNames = ['Main St', 'Oak Ave', 'First St', 'Park Dr', 'Elm St', 'Maple Ave', 'Cedar Ln', 'Pine St', 'Broad St', 'Church St'];
                        
                        var streetNum = streetNumbers[Math.floor(Math.random() * streetNumbers.length)];
                        var streetName = streetNames[Math.floor(Math.random() * streetNames.length)];
                        
                        return streetNum + ' ' + streetName;
                    }
                case 'zip-code':
                    // Create ZIP code with fallback
                    try {
                        return window.faker.location.zipCode();
                    } catch (error) {
                        var zip1 = Math.floor(Math.random() * 90000) + 10000; // 5-digit ZIP
                        return zip1.toString();
                    }
                case 'country-code':
                    // Create country code with fallback
                    try {
                        return window.faker.location.countryCode();
                    } catch (error) {
                        var countryCodes = ['US', 'CA', 'UK', 'DE', 'FR', 'IT', 'ES', 'JP', 'AU', 'BR', 'IN', 'CN', 'MX', 'AR', 'NL'];
                        return countryCodes[Math.floor(Math.random() * countryCodes.length)];
                    }
                case 'coordinates':
                    // Create coordinates with fallback
                    try {
                        return window.faker.location.latitude() + ', ' + window.faker.location.longitude();
                    } catch (error) {
                        var lat = (Math.random() * 180 - 90).toFixed(6); // -90 to 90
                        var lon = (Math.random() * 360 - 180).toFixed(6); // -180 to 180
                        return lat + ', ' + lon;
                    }
                default: // city
                    return window.faker.location.city();
            }
            
        case 'title':
            var type = config.titleType || 'post-title';
            
            switch (type) {
                case 'company-name':
                    return window.faker.company.name();
                case 'product-name':
                    return window.faker.commerce.productName();
                case 'food':
                    // Generate food names
                    var foods = ['Pizza Margherita', 'Chicken Caesar Salad', 'Beef Tacos', 'Salmon Teriyaki', 'Mushroom Risotto', 'Thai Green Curry', 'BBQ Pulled Pork', 'Vegetable Stir Fry', 'Chocolate Brownies', 'Apple Pie', 'Greek Gyros', 'Spaghetti Carbonara', 'Fish and Chips', 'Chicken Tikka Masala', 'French Onion Soup'];
                    return foods[Math.floor(Math.random() * foods.length)];
                case 'animal':
                    // Generate animal names with fallback
                    if (window.faker.animal && window.faker.animal.type) {
                        return window.faker.animal.type();
                    } else {
                        var animals = ['Lion', 'Tiger', 'Elephant', 'Giraffe', 'Zebra', 'Panda', 'Kangaroo', 'Dolphin', 'Eagle', 'Wolf', 'Bear', 'Fox', 'Rabbit', 'Deer', 'Monkey'];
                        return animals[Math.floor(Math.random() * animals.length)];
                    }
                case 'song-title':
                    // Generate song titles with a better format
                    var songTitles = ['Dancing in the Moonlight', 'Electric Dreams', 'Sunset Boulevard', 'City of Stars', 'Wild Horses', 'Purple Rain', 'Golden Hour', 'Sweet Caroline', 'Bohemian Rhapsody', 'Imagine Dragons', 'Perfect Storm', 'Counting Stars', 'Rolling in the Deep', 'Someone Like You', 'Shape of You'];
                    return songTitles[Math.floor(Math.random() * songTitles.length)];
                case 'music-artist':
                    // Generate music artist names
                    var artists = ['The Midnight Stars', 'Luna Echo', 'Electric Pulse', 'Neon Dreams', 'Acoustic Soul', 'Digital Symphony', 'Velvet Storm', 'Crystal Waters', 'Iron Mountain', 'Silver Moon', 'Golden Wave', 'Red Horizon', 'Blue Thunder', 'Green Valley', 'Purple Sky'];
                    return artists[Math.floor(Math.random() * artists.length)];
                case 'random-word':
                    // Generate random words
                    if (window.faker.lorem && window.faker.lorem.word) {
                        return window.faker.lorem.word();
                    } else {
                        var words = ['Innovation', 'Discovery', 'Adventure', 'Journey', 'Harmony', 'Serenity', 'Courage', 'Wisdom', 'Freedom', 'Balance', 'Energy', 'Passion', 'Growth', 'Success', 'Wonder'];
                        return words[Math.floor(Math.random() * words.length)];
                    }
                default: // post-title
                    // Use post titles from cached longTexts data
                    if (window.longTextsData && window.longTextsData.post_titles) {
                        return getUniqueFromBatch(window.longTextsData.post_titles, 'post-title');
                    }
                    // Fallback to simple titles
                    return window.faker.lorem.sentence();
            }
            
        case 'long_text':
            var category = config.textCategory || 'any';
            
            // Load data from longTexts.json via cached data
            if (window.longTextsData) {
                // Use cached data
                var longTexts = window.longTextsData;
                
                if (category === 'any') {
                    // Exclude post_titles from "any category" - they should only be used for Title > Post title
                    var longTextCategories = ['technology', 'biography', 'history', 'nature', 'medicine'];
                    var allTexts = [];
                    for (var i = 0; i < longTextCategories.length; i++) {
                        var cat = longTextCategories[i];
                        if (longTexts[cat]) {
                            allTexts = allTexts.concat(longTexts[cat]);
                        }
                    }
                    return getUniqueFromBatch(allTexts, 'any');
                }
                
                var categoryTexts = longTexts[category];
                if (categoryTexts) {
                    return getUniqueFromBatch(categoryTexts, category);
                }
            }
            
            // Fallback if no data available
            return window.faker.lorem.paragraphs(2);
            
        // MEDIA
        case 'avatar':
            var type = config.avatarType || 'any';
            
            switch (type) {
                case 'real-people':
                    // Use existing RandomUser function logic
                    var gender = Math.random() > 0.5 ? 'men' : 'women';
                    var id = Math.floor(Math.random() * 99) + 1;
                    return 'https://randomuser.me/api/portraits/' + gender + '/' + id + '.jpg';
                case 'male':
                    var id = Math.floor(Math.random() * 99) + 1;
                    return 'https://randomuser.me/api/portraits/men/' + id + '.jpg';
                case 'female':
                    var id = Math.floor(Math.random() * 99) + 1;
                    return 'https://randomuser.me/api/portraits/women/' + id + '.jpg';
                case 'robots':
                    var seed = Math.random().toString(36).substring(7);
                    return 'https://robohash.org/' + seed + '.png?size=200x200&set=set1';
                case 'cartoon':
                    var seed = Math.random().toString(36).substring(7);
                    return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + seed + '&size=200&backgroundColor=transparent';
                default: // any
                    var types = ['real-people', 'robots', 'cartoon'];
                    var randomType = types[Math.floor(Math.random() * types.length)];
                    // Directly generate based on type to avoid recursion
                    switch (randomType) {
                        case 'real-people':
                            var gender = Math.random() > 0.5 ? 'men' : 'women';
                            var id = Math.floor(Math.random() * 99) + 1;
                            return 'https://randomuser.me/api/portraits/' + gender + '/' + id + '.jpg';
                        case 'robots':
                            var seed = Math.random().toString(36).substring(7);
                            return 'https://robohash.org/' + seed + '.png?size=200x200&set=set1';
                        case 'cartoon':
                            var seed = Math.random().toString(36).substring(7);
                            return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + seed + '&size=200&backgroundColor=transparent';
                    }
            }
            
        case 'image':
            var category = config.imageCategory || 'any';
            
            switch (category) {
                case 'products':
                    return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
                case 'landscapes':
                    return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
                default: // any
                    return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
            }
            
        case 'color':
            var type = config.colorType || 'solid';
            
            // Generate random RGB color manually since faker.color.rgb() might not be available
            function generateRandomColor() {
                var r = Math.floor(Math.random() * 256);
                var g = Math.floor(Math.random() * 256);
                var b = Math.floor(Math.random() * 256);
                return 'rgb(' + r + ', ' + g + ', ' + b + ')';
            }
            
            if (type === 'gradient') {
                var color1 = generateRandomColor();
                var color2 = generateRandomColor();
                return 'linear-gradient(45deg, ' + color1 + ', ' + color2 + ')';
            }
            
            return generateRandomColor();
            
        // Legacy data types for backward compatibility
        case 'name':
            return window.faker.person.fullName();
        case 'username':
            return window.faker.internet.userName();
        case 'city':
            return window.faker.location.city();
        case 'country':
            return window.faker.location.country();
        case 'company':
            return window.faker.company.name();
        case 'email':
            return window.faker.internet.email();
        case 'product_name':
            return window.faker.commerce.productName();
        case 'post_title':
            return window.faker.lorem.sentence();
        case 'description':
            return window.faker.lorem.paragraph();
        case 'lorem':
            return window.faker.lorem.words();
        case 'integer':
            return generateCustomInteger();
        case 'decimal':
            return window.faker.number.float({ min: 0, max: 100, fractionDigits: 2 });
        case 'currency':
            return '$' + window.faker.finance.amount();
        case 'date':
            return window.faker.date.anytime().toLocaleDateString();
        case 'phone':
            return window.faker.phone.number();
        case 'percentage':
            return window.faker.number.int({ min: 0, max: 100 }) + '%';
        case 'avatar_dicebear':
            return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + window.faker.string.uuid() + '&size=200&backgroundColor=transparent';
        case 'image_picsum':
            return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
            
        default:
            return 'Data type not supported: ' + dataTypeId;
    }
}

// Apply sorting to data array based on sorting type and data type
function applySorting(data, sortingType, dataTypeId) {
    if (sortingType === 'random' || !sortingType) {
        return data; // Already random
    }
    
    var sortedData = data.slice(); // Create a copy
    
    switch (sortingType) {
        case 'ascending':
            sortedData.sort(function(a, b) {
                // Check if values are numbers
                var numA = parseFloat(a.replace(/[^0-9.-]/g, ''));
                var numB = parseFloat(b.replace(/[^0-9.-]/g, ''));
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                
                // Text comparison
                return a.localeCompare(b);
            });
            break;
            
        case 'descending':
            sortedData.sort(function(a, b) {
                // Check if values are numbers
                var numA = parseFloat(a.replace(/[^0-9.-]/g, ''));
                var numB = parseFloat(b.replace(/[^0-9.-]/g, ''));
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numB - numA;
                }
                
                // Text comparison
                return b.localeCompare(a);
            });
            break;
            
        case 'a-z':
            sortedData.sort(function(a, b) {
                return a.localeCompare(b);
            });
            break;
            
        case 'z-a':
            sortedData.sort(function(a, b) {
                return b.localeCompare(a);
            });
            break;
            
        case 'recent':
            // For dates, sort by most recent
            if (dataTypeId === 'date') {
                sortedData.sort(function(a, b) {
                    // Check if it's a month name
                    var months = ['january', 'february', 'march', 'april', 'may', 'june', 
                                  'july', 'august', 'september', 'october', 'november', 'december'];
                    var monthsShort = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 
                                      'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    
                    var aLower = a.toLowerCase();
                    var bLower = b.toLowerCase();
                    
                    // Check for month names (December to January order for "recent")
                    var aMonthIndex = months.indexOf(aLower);
                    var bMonthIndex = months.indexOf(bLower);
                    if (aMonthIndex === -1) aMonthIndex = monthsShort.indexOf(aLower);
                    if (bMonthIndex === -1) bMonthIndex = monthsShort.indexOf(bLower);
                    
                    if (aMonthIndex !== -1 && bMonthIndex !== -1) {
                        // For months, recent = December to January (reverse month order)
                        return (11 - bMonthIndex) - (11 - aMonthIndex);
                    }
                    
                    // Check for weekday names
                    var weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    var weekdaysShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                    
                    var aWeekIndex = weekdays.indexOf(aLower);
                    var bWeekIndex = weekdays.indexOf(bLower);
                    if (aWeekIndex === -1) aWeekIndex = weekdaysShort.indexOf(aLower);
                    if (bWeekIndex === -1) bWeekIndex = weekdaysShort.indexOf(bLower);
                    
                    if (aWeekIndex !== -1 && bWeekIndex !== -1) {
                        // For weekdays, recent = Sunday to Monday (normal order)
                        return aWeekIndex - bWeekIndex;
                    }
                    
                    // For full dates, parse and sort newest to oldest
                    var dateA = new Date(a);
                    var dateB = new Date(b);
                    if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                        return dateB - dateA; // Newest first
                    }
                    
                    // For year strings, sort highest to lowest
                    var yearA = parseInt(a);
                    var yearB = parseInt(b);
                    if (!isNaN(yearA) && !isNaN(yearB)) {
                        return yearB - yearA;
                    }
                    
                    return 0;
                });
            }
            break;
            
        case 'oldest':
            // For dates, sort by oldest
            if (dataTypeId === 'date') {
                sortedData.sort(function(a, b) {
                    // Check if it's a month name
                    var months = ['january', 'february', 'march', 'april', 'may', 'june', 
                                  'july', 'august', 'september', 'october', 'november', 'december'];
                    var monthsShort = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 
                                      'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    
                    var aLower = a.toLowerCase();
                    var bLower = b.toLowerCase();
                    
                    // Check for month names (January to December order for "oldest")
                    var aMonthIndex = months.indexOf(aLower);
                    var bMonthIndex = months.indexOf(bLower);
                    if (aMonthIndex === -1) aMonthIndex = monthsShort.indexOf(aLower);
                    if (bMonthIndex === -1) bMonthIndex = monthsShort.indexOf(bLower);
                    
                    if (aMonthIndex !== -1 && bMonthIndex !== -1) {
                        // For months, oldest = January to December (normal month order)
                        return aMonthIndex - bMonthIndex;
                    }
                    
                    // Check for weekday names
                    var weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    var weekdaysShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                    
                    var aWeekIndex = weekdays.indexOf(aLower);
                    var bWeekIndex = weekdays.indexOf(bLower);
                    if (aWeekIndex === -1) aWeekIndex = weekdaysShort.indexOf(aLower);
                    if (bWeekIndex === -1) bWeekIndex = weekdaysShort.indexOf(bLower);
                    
                    if (aWeekIndex !== -1 && bWeekIndex !== -1) {
                        // For weekdays, oldest = Monday to Sunday (reverse order)
                        return bWeekIndex - aWeekIndex;
                    }
                    
                    // For full dates, parse and sort oldest to newest
                    var dateA = new Date(a);
                    var dateB = new Date(b);
                    if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                        return dateA - dateB; // Oldest first
                    }
                    
                    // For year strings, sort lowest to highest
                    var yearA = parseInt(a);
                    var yearB = parseInt(b);
                    if (!isNaN(yearA) && !isNaN(yearB)) {
                        return yearA - yearB;
                    }
                    
                    return 0;
                });
            }
            break;
    }
    
    return sortedData;
}

// Set up preview functionality for custom numbers
function setupCustomNumberPreview(layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    function updatePreview() {
        try {
            var minInput = document.getElementById('min-' + cleanLayerName);
            var maxInput = document.getElementById('max-' + cleanLayerName);
            var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
            var formatInput = document.getElementById('format-' + cleanLayerName);
            var prefixInput = document.getElementById('prefix-' + cleanLayerName);
            var previewElement = document.getElementById('preview-' + cleanLayerName);
            
            if (!minInput || !maxInput || !decimalsInput || !formatInput || !prefixInput || !previewElement) {
                return;
            }
            
            var min = parseInt(minInput.value) || 1;
            var max = parseInt(maxInput.value) || 1000;
            var decimals = decimalsInput.checked;
            var format = formatInput.checked;
            var prefix = prefixInput.value || '';
            
            // Generate sample value
            var value = Math.random() * (max - min) + min;
            
            if (!decimals) {
                value = Math.floor(value);
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            var result = value.toString();
            
            if (format && value >= 1000) {
                result = value.toLocaleString();
            }
            
            if (decimals && !result.includes('.')) {
                result += '.00';
            }
            
            previewElement.textContent = prefix + result;
        } catch (error) {
            console.log('Preview update error:', error);
        }
    }
    
    // Set up event listeners with small delay to ensure elements exist
    setTimeout(function() {
        var minInput = document.getElementById('min-' + cleanLayerName);
        var maxInput = document.getElementById('max-' + cleanLayerName);
        var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
        var formatInput = document.getElementById('format-' + cleanLayerName);
        var prefixInput = document.getElementById('prefix-' + cleanLayerName);
        
        if (minInput) minInput.addEventListener('input', updatePreview);
        if (maxInput) maxInput.addEventListener('input', updatePreview);
        if (decimalsInput) decimalsInput.addEventListener('change', updatePreview);
        if (formatInput) formatInput.addEventListener('change', updatePreview);
        if (prefixInput) prefixInput.addEventListener('input', updatePreview);
        
        // Initial preview update
        updatePreview();
    }, 100);
}

// Get configuration for a layer based on UI inputs
function getConfigForLayer(dataTypeId, layerName) {
    var config = {};
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    // Get values from UI elements if they exist
    var minInput = document.getElementById('min-' + cleanLayerName);
    var maxInput = document.getElementById('max-' + cleanLayerName);
    var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
    var formatInput = document.getElementById('format-' + cleanLayerName);
    var prefixInput = document.getElementById('prefix-' + cleanLayerName);
    var sortInput = document.getElementById('sort-' + cleanLayerName);
    var phoneFormatInput = document.getElementById('phoneFormat-' + cleanLayerName);
    var dateFormatInput = document.getElementById('dateFormat-' + cleanLayerName);
    var financeTypeInput = document.getElementById('financeType-' + cleanLayerName);
    var personTypeInput = document.getElementById('personType-' + cleanLayerName);
    var customPrefixInput = document.getElementById('customPrefix-' + cleanLayerName);
    var customSuffixInput = document.getElementById('customSuffix-' + cleanLayerName);
    var providerInput = document.getElementById('provider-' + cleanLayerName);
    var domainInput = document.getElementById('domain-' + cleanLayerName);
    var includeProtocolInput = document.getElementById('includeProtocol-' + cleanLayerName);
    var locationTypeInput = document.getElementById('locationType-' + cleanLayerName);
    var titleTypeInput = document.getElementById('titleType-' + cleanLayerName);
    var textCategoryInput = document.getElementById('textCategory-' + cleanLayerName);
    var avatarTypeInput = document.getElementById('avatarType-' + cleanLayerName);
    var imageCategoryInput = document.getElementById('imageCategory-' + cleanLayerName);
    var colorTypeInput = document.getElementById('colorType-' + cleanLayerName);
    
    if (minInput) config.min = parseInt(minInput.value) || 1;
    if (maxInput) config.max = parseInt(maxInput.value) || 1000;
    if (decimalsInput) config.decimals = decimalsInput.checked;
    if (formatInput) config.format = formatInput.checked;
    if (prefixInput) config.prefix = prefixInput.value || '';
    if (sortInput) config.sorting = sortInput.value || 'random';
    if (phoneFormatInput) config.phoneFormat = phoneFormatInput.value || 'human';
    if (dateFormatInput) config.dateFormat = dateFormatInput.value || 'MM/DD/YYYY';
    if (financeTypeInput) config.financeType = financeTypeInput.value || 'credit-card';
    if (personTypeInput) config.personType = personTypeInput.value || 'full-name';
    if (customPrefixInput) config.customPrefix = customPrefixInput.value || '';
    if (customSuffixInput) config.customSuffix = customSuffixInput.value || '';
    if (providerInput) config.provider = providerInput.value || '';
    if (domainInput) config.domain = domainInput.value || '';
    if (includeProtocolInput) config.includeProtocol = includeProtocolInput.checked;
    if (locationTypeInput) config.locationType = locationTypeInput.value || 'city';
    if (titleTypeInput) config.titleType = titleTypeInput.value || 'post-title';
    if (textCategoryInput) config.textCategory = textCategoryInput.value || 'any';
    if (avatarTypeInput) config.avatarType = avatarTypeInput.value || 'any';
    if (imageCategoryInput) config.imageCategory = imageCategoryInput.value || 'any';
    if (colorTypeInput) config.colorType = colorTypeInput.value || 'solid';
    
    return config;
}

// ... existing code ...

// Load image data using fetch with CORS workarounds
function loadImageData(imageUrl) {
    console.log('üîÑ Loading image from URL:', imageUrl);
    
    return tryImageWithCorsWorkarounds(imageUrl);
}

// Try multiple methods to load images with CORS workarounds
function tryImageWithCorsWorkarounds(imageUrl) {
    return new Promise(function(resolve) {
        // Method 1: Direct fetch
        console.log('üîÑ Image Method 1: Direct fetch...');
        fetch(imageUrl)
            .then(function(response) {
                if (!response.ok) throw new Error('Direct fetch failed: ' + response.status);
                return response.arrayBuffer();
            })
            .then(function(arrayBuffer) {
                console.log('‚úÖ Image Method 1 SUCCESS: Direct fetch worked!');
                resolve(new Uint8Array(arrayBuffer));
            })
            .catch(function(error) {
                console.log('‚ùå Image Method 1 failed:', error.message);
                
                // Method 2: Try with no-cors mode (for some services)
                console.log('üîÑ Image Method 2: Trying no-cors mode...');
                fetch(imageUrl, { mode: 'no-cors' })
                    .then(function(response) {
                        // no-cors mode returns opaque response, we can't read the body
                        // but we can at least check if the request succeeded
                        if (response.type === 'opaque') {
                            // For no-cors, we can't get the actual image data
                            // So we'll try a CORS proxy instead
                            throw new Error('No-cors mode returned opaque response');
                        }
                        return response.arrayBuffer();
                    })
                    .then(function(arrayBuffer) {
                        console.log('‚úÖ Image Method 2 SUCCESS: No-cors mode worked!');
                        resolve(new Uint8Array(arrayBuffer));
                    })
                    .catch(function(noCorsError) {
                        console.log('‚ùå Image Method 2 failed:', noCorsError.message);
                        
                        // Method 3: Try with CORS proxy
                        console.log('üîÑ Image Method 3: Trying CORS proxy...');
                        var proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(imageUrl);
                        fetch(proxyUrl)
                            .then(function(response) {
                                if (!response.ok) throw new Error('CORS proxy failed: ' + response.status);
                                return response.arrayBuffer();
                            })
                            .then(function(arrayBuffer) {
                                console.log('‚úÖ Image Method 3 SUCCESS: CORS proxy worked!');
                                resolve(new Uint8Array(arrayBuffer));
                            })
                            .catch(function(proxyError) {
                                console.log('‚ùå Image Method 3 failed:', proxyError.message);
                                
                                // Method 4: Generate a fallback based on the original URL type
                                console.log('üîÑ Image Method 4: Generating fallback...');
                                var fallbackUrl;
                                
                                                                 if (imageUrl.includes('randomuser.me') || imageUrl.includes('ui-avatars.com') || imageUrl.includes('pravatar.cc') || imageUrl.includes('multiavatar.com') || imageUrl.includes('robohash.org')) {
                                     // Avatar fallback
                                     fallbackUrl = 'https://api.dicebear.com/7.x/avataaars/png?seed=' + Math.random().toString(36).substring(7) + '&size=200&backgroundColor=transparent';
                                 } else {
                                     // General image fallback
                                     fallbackUrl = 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000);
                                 }
                                
                                fetch(fallbackUrl)
                                    .then(function(response) {
                                        if (!response.ok) throw new Error('Fallback failed');
                                        return response.arrayBuffer();
                                    })
                                    .then(function(arrayBuffer) {
                                        console.log('‚úÖ Image Method 4 SUCCESS: Fallback image loaded!');
                                        resolve(new Uint8Array(arrayBuffer));
                                    })
                                    .catch(function(fallbackError) {
                                        console.log('‚ùå Image Method 4 failed:', fallbackError.message);
                                        console.error('‚ùå All image loading methods failed for:', imageUrl);
                                        resolve(null);
                                    });
                            });
                    });
            });
    });
}

// Listen for messages from the main plugin code
window.addEventListener('message', function(event) {
    var msg = event.data.pluginMessage;
    if (!msg) return;
    
    if (msg.type === 'layers-scanned') {
        setLoadingState(scanButton, scanText, scanLoading, false);
        renderMappings(msg.data.mappings, msg.data.savedConfigurations);
        
        var preconfiguredCount = msg.data.mappings.filter(function(m) { return m.isPreConfigured; }).length;
        var statusMsg = 'Found ' + msg.data.mappings.length + ' layer mapping' + (msg.data.mappings.length > 1 ? 's' : '');
        if (preconfiguredCount > 0) {
            statusMsg += ' (' + preconfiguredCount + ' pre-configured)';
        }
        
        if (msg.data.mappings.length > 0) {
            showStatusMessage(statusMsg);
        } else {
            showStatusMessage('No layers with % prefixes found in selection', 'error');
        }
    } else if (msg.type === 'integer-settings-loaded') {
        // Restore integer settings from storage
        if (msg.data && Object.keys(msg.data).length > 0) {
            integerSettings = msg.data;
            console.log('üì• Integer settings restored:', integerSettings);
            // Populate the UI controls with loaded settings
            populateIntegerControlsFromSettings();
        }
    } else if (msg.type === 'mapping-removed') {
        currentMappings = currentMappings.filter(function(m) { return m.layerName !== msg.data.layerName; });
        renderMappings(currentMappings);
        showStatusMessage('Mapping removed');
    } else if (msg.type === 'data-applied') {
        setLoadingState(applyButton, applyText, applyLoading, false);
        hideProgressScreen();
        showStatusMessage(msg.message);
    } else if (msg.type === 'progress-update') {
        updateProgress(msg.completed, msg.total);
    } else if (msg.type === 'error') {
        setLoadingState(scanButton, scanText, scanLoading, false);
        setLoadingState(applyButton, applyText, applyLoading, false);
        hideProgressScreen();
        showStatusMessage(msg.message, 'error');
    } else if (msg.type === 'long-texts-loaded') {
        // Store longTexts data globally for use in content generation
        window.longTextsData = msg.data;
        console.log('üì• LongTexts data loaded:', msg.data ? 'Successfully' : 'Failed');
    } else if (msg.type === 'generate-data') {
        // Generate data and send back to main code
        Promise.resolve(generateData(msg.dataTypeId, msg.count, msg.layerName))
            .then(function(data) {
                parent.postMessage({
                    pluginMessage: {
                        type: 'data-generated',
                        requestId: msg.requestId,
                        data: data
                    }
                }, '*');
            })
            .catch(function(error) {
                console.error('Data generation failed:', error);
                parent.postMessage({
                    pluginMessage: {
                        type: 'data-generated',
                        requestId: msg.requestId,
                        data: Array(msg.count).fill('Generation failed')
                    }
                }, '*');
            });
    } else if (msg.type === 'load-image') {
        // Load image and send back to main code
        console.log('üì® Received image load request:', msg.requestId, msg.url);
        loadImageData(msg.url)
            .then(function(imageData) {
                console.log('üì§ Sending image data response:', msg.requestId, imageData ? 'Success' : 'Failed');
                parent.postMessage({
                    pluginMessage: {
                        type: 'image-loaded',
                        requestId: msg.requestId,
                        data: imageData
                    }
                }, '*');
            })
            .catch(function(error) {
                console.error('‚ùå Image loading failed:', error);
                parent.postMessage({
                    pluginMessage: {
                        type: 'image-loaded',
                        requestId: msg.requestId,
                        data: null
                    }
                }, '*');
            });
    }
});
    </script>
</body>
</html> 