<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        /* Figma automatically injects CSS variables when themeColors: true is set */
        /* Variables available: --figma-color-bg, --figma-color-text, etc. */

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--figma-color-bg);
            color: var(--figma-color-text);
            font-size: 12px;
        }

        h2 {
            font-size: 13px;
            font-weight: 510;
            line-height: 20px;
            color: var(--figma-color-text);
            margin: 0;
        }

        p {
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            opacity: 0.75;
            margin: 0;
            padding: 0 16px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 8px 16px 88px 16px; /* Add bottom padding for sticky apply button */
        }

        .section {
            background: var(--figma-color-bg);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .apply-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--figma-color-bg);
            padding: 8px 16px 16px 16px;
            z-index: 100;
        }

        /* Hide apply section when selection screen is active */
        .apply-section.hidden {
            display: none;
        }

        .apply-section .apply-button {
            max-width: 400px;
            margin: 0 auto;
            display: flex;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--figma-color-text);
        }

        .scan-button, .apply-button {
            width: 100%;
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            font-weight: 510;
            font-size: 11px;
            line-height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .scan-button {
            background: var(--figma-color-bg-brand);
            color: var(--figma-color-text-onbrand);
        }

        .scan-button:hover {
            background: var(--figma-color-bg-brand-hover);
        }

        .apply-button {
            background: var(--figma-color-bg-inverse); /* solid background (default) */
            color: var(--figma-color-bg);
            padding: 5px 8px !important;
            background-size: 240% 100%;
            background-position: 0% 50%;
            border: none;
            transition: background 0.3s ease, color 0.3s ease;
            font-weight: 510 !important;
        }

        .apply-button span {
            font-weight: 510 !important;
        }

        .apply-button:hover:not(:disabled):not(.disabled) {
            background: linear-gradient(90deg, 
            #007BE5 0%, 
            #FFC5D0 20%, 
            #FFBDA7 40%, 
            #007BE5 60%,
            #FFC5D0 80%, 
            #FFBDA7 100% 
            );
            background-size: 240% 100%;
            background-position: 0% 50%;
            animation: gradientMove 2s linear infinite;
            color: transparent; /* Hide original text */
            position: relative;
        }

        .apply-button:hover:not(:disabled):not(.disabled) span {
            /* Apply blend mode only to text content */
            mix-blend-mode: difference;
            color: #707070;
            position: relative;
            z-index: 1;
            text-shadow: 
                0 0 1px rgba(0, 0, 0, 1),
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 100% 50%;
            }
        }

        .apply-button:disabled,
        .apply-button.disabled {
            background: var(--figma-color-bg-disabled) !important;
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            pointer-events: none !important;
        }
        
        .apply-button:disabled:hover,
        .apply-button.disabled:hover {
            background: var(--figma-color-bg-disabled) !important;
            cursor: not-allowed !important;
            opacity: 0.5 !important;
        }

       
        
        .clear-sync-button {
            background: transparent;
            padding: 5px;
            border-radius: 6px;
            border: none;
            width: 30px;
            height: 30px;
        }

        .clear-sync-button:hover {
            background: var(--figma-color-bg-component);
        }

        .clear-sync-button svg {
            fill: var(--figma-color-icon-component-secondary);
            width: 16px;
            height: 16px;
        }

        .clear-sync-button:hover svg {
            fill: var(--figma-color-bg);
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mapping-item {
            border-radius: 6px;
            padding: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--figma-color-bg-secondary);
            padding: 4px;
            border-radius: 6px;
        }

        .config-panel {
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-top: 1px;
            padding: 0px;
            background: var(--figma-color-bg-brand-tertiary);
            border: none;
            border-radius: 6px;
            margin-bottom: 4px;
            /* Add any other custom styles here */
        }

        .config-preview {
            padding: 8px 0px;
            border: none;
            font-size: 20px;
            line-height: 24px;
            width: 100%;
            color: var(--figma-color-text);
            font-weight: 400;
            text-align: center;
            border-bottom: 1px solid var(--figma-color-bg);
        }

        .config-row {
            display: flex;
            gap: 1px;
            border-bottom: 1px solid var(--figma-color-bg);
        }

        .config-row > div:first-child {
            border-right: 1px solid var(--figma-color-bg) !important;
        }

        /* Ensure equal visual width for all elements in config rows */
        .config-row > div {
            box-sizing: border-box;
        }
        
        /* Keep original padding for each element type - they're already properly sized */

        .config-input {
            width: 100%;
            padding: 6px 8px;
            border: none;
            border-radius: 0px;
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            background: transparent;
        }

        .config-input:focus {
            outline: none;
        }

        .config-select {
            min-width: 142px;
            width: 100%;
            padding: 6px 24px 6px 24px;
            border: none;
            border-radius: 0px;
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            background: transparent;
            background-image: 
                url('data:image/svg+xml;charset=utf-8,<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 1.5C3.77613 1.50002 4 1.72387 4 2V8.79297L5.14648 7.64648C5.34175 7.45124 5.65826 7.45123 5.85352 7.64648C6.04871 7.84174 6.04874 8.15827 5.85352 8.35352L3.85352 10.3535C3.81946 10.3876 3.78038 10.4134 3.74023 10.4355C3.69597 10.46 3.64884 10.4801 3.59766 10.4902C3.5329 10.5031 3.4661 10.5032 3.40137 10.4902C3.35024 10.48 3.303 10.4601 3.25879 10.4355C3.2189 10.4134 3.18035 10.3874 3.14648 10.3535L1.14648 8.35352C0.951222 8.15825 0.951222 7.84175 1.14648 7.64648C1.34175 7.45124 1.65826 7.45123 1.85352 7.64648L3 8.79297V2C3 1.72386 3.22386 1.5 3.5 1.5ZM8.51562 1.50098C8.53625 1.50165 8.55672 1.50363 8.57715 1.50684C8.5907 1.50894 8.60402 1.51148 8.61719 1.51465C8.6341 1.51874 8.6505 1.5244 8.66699 1.53027C8.6781 1.53422 8.68946 1.53729 8.7002 1.54199C8.71602 1.54892 8.73091 1.55777 8.74609 1.56641C8.75935 1.57395 8.77269 1.58116 8.78516 1.58984C8.80906 1.60652 8.83219 1.62516 8.85352 1.64648L10.8535 3.64648L10.918 3.72461C11.0461 3.91868 11.0243 4.18267 10.8535 4.35352C10.6827 4.52436 10.4187 4.54608 10.2246 4.41797L10.1465 4.35352L9 3.20703V10C9 10.2761 8.77613 10.5 8.5 10.5C8.22386 10.5 8 10.2761 8 10V3.20703L6.85352 4.35352C6.65827 4.54876 6.34175 4.54872 6.14648 4.35352C5.95122 4.15825 5.95122 3.84175 6.14648 3.64648L8.14648 1.64648L8.22461 1.58203C8.27661 1.5477 8.33368 1.52454 8.39258 1.51172C8.40092 1.50989 8.40948 1.50922 8.41797 1.50781C8.44067 1.50408 8.46338 1.50157 8.48633 1.50098C8.49087 1.50085 8.49543 1.5 8.5 1.5C8.50524 1.5 8.51043 1.50082 8.51562 1.50098Z" fill="%23666"/></svg>'),
                url('data:image/svg+xml;charset=utf-8,<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.14651 3.39645C7.34177 3.20118 7.65828 3.20118 7.85354 3.39645C8.0488 3.59171 8.0488 3.90822 7.85354 4.10348L5.35354 6.60348C5.15828 6.79874 4.84177 6.79874 4.64651 6.60348L2.14651 4.10348C1.95125 3.90822 1.95125 3.59171 2.14651 3.39645C2.34177 3.20118 2.65828 3.20118 2.85354 3.39645L5.00002 5.54293L7.14651 3.39645Z" fill="%23666"/></svg>');
            background-repeat: no-repeat, no-repeat;
            background-position: 6px center, calc(100% - 8px) center;
            background-size: 12px 12px, 10px 10px;
            position: relative;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }



        .config-select:focus {
            outline: none;
        }

        .config-select-simple {
            min-width: 142px;
            width: 100%;
            padding: 6px 24px 6px 8px;
            border: none;
            border-radius: 0px;
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            background: transparent;
            background-image: url('data:image/svg+xml;charset=utf-8,<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.14651 3.39645C7.34177 3.20118 7.65828 3.20118 7.85354 3.39645C8.0488 3.59171 8.0488 3.90822 7.85354 4.10348L5.35354 6.60348C5.15828 6.79874 4.84177 6.79874 4.64651 6.60348L2.14651 4.10348C1.95125 3.90822 1.95125 3.59171 2.14651 3.39645C2.34177 3.20118 2.65828 3.20118 2.85354 3.39645L5.00002 5.54293L7.14651 3.39645Z" fill="%23666"/></svg>');
            background-repeat: no-repeat;
            background-position: calc(100% - 8px) center;
            background-size: 10px 10px;
            position: relative;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .config-select-simple:focus {
            outline: none;
        }

        .column-select-simple {
            width: 100%;
            padding: 4px 24px 4px 8px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            background: var(--figma-color-bg);
            background-image: url('data:image/svg+xml;charset=utf-8,<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.14651 3.39645C7.34177 3.20118 7.65828 3.20118 7.85354 3.39645C8.0488 3.59171 8.0488 3.90822 7.85354 4.10348L5.35354 6.60348C5.15828 6.79874 4.84177 6.79874 4.64651 6.60348L2.14651 4.10348C1.95125 3.90822 1.95125 3.59171 2.14651 3.39645C2.34177 3.20118 2.65828 3.20118 2.85354 3.39645L5.00002 5.54293L7.14651 3.39645Z" fill="%23666"/></svg>');
            background-repeat: no-repeat;
            background-position: calc(100% - 8px) center;
            background-size: 10px 10px;
            position: relative;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            margin-right: 2px;
        }

        .column-select-simple:focus {
            outline: none;
        }

        /* Data type selector placeholder opacity - only when showing "Select..." */
        .dropdown-text:not(:has(span)) {
            opacity: 0.5;
        }

        .config-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            justify-content: left;
            cursor: pointer;
        }

        .config-checkbox input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border: 1px solid var(--figma-color-border-disabled-strong            );
            border-radius: 2px;
            background: transparent;
            cursor: pointer;
            position: relative;
            margin: 0;
            padding: 0;
        }

        .config-checkbox input[type="checkbox"]:checked {
            background: var(--figma-color-bg-inverse);
            border-color: var(--figma-color-bg-inverse);
        }

        .config-checkbox input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 12px;
            height: 12px;
            background: var(--figma-color-bg);
            mask: url('data:image/svg+xml;charset=utf-8,<svg width="10" height="10" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.64651 2.64645C9.84177 2.45118 10.1583 2.45118 10.3535 2.64645C10.5488 2.84171 10.5488 3.15822 10.3535 3.35348L4.85354 8.85348C4.65828 9.04874 4.34177 9.04874 4.14651 8.85348L1.64651 6.35348C1.45125 6.15822 1.45125 5.84171 1.64651 5.64645C1.81737 5.47558 2.08134 5.45383 2.27541 5.58199L2.35354 5.64645L4.50002 7.79293L9.64651 2.64645Z" fill="black"/></svg>') center / contain no-repeat;
            -webkit-mask: url('data:image/svg+xml;charset=utf-8,<svg width="10" height="10" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.64651 2.64645C9.84177 2.45118 10.1583 2.45118 10.3535 2.64645C10.5488 2.84171 10.5488 3.15822 10.3535 3.35348L4.85354 8.85348C4.65828 9.04874 4.34177 9.04874 4.14651 8.85348L1.64651 6.35348C1.45125 6.15822 1.45125 5.84171 1.64651 5.64645C1.81737 5.47558 2.08134 5.45383 2.27541 5.58199L2.35354 5.64645L4.50002 7.79293L9.64651 2.64645Z" fill="black"/></svg>') center / contain no-repeat;
        }

        .config-checkbox span {
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            user-select: none;
        }

        .mapping-select {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            width: 148px;
        }

        .mapping-layer {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 16px;
            padding: 6px 8px;
        }

        .layer-name {
            font-size: 11px;
            line-height: 16px;
            font-weight: 510;
            color: var(--figma-color-text);
        }

        .layer-count {
            color: #666;
            font-size: 12px;
        }

        /* Layer Type Indicator Styles */
        .layer-type-indicator {
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            width: 12px;
            height: 12px;
        }

        .layer-type-indicator svg {
            width: 12px;
            height: 12px;
        }

        .layer-type-text svg {
            fill: var(--figma-color-icon-brand);
        }

        .layer-type-image svg {
            fill: var(--figma-color-icon-brand);
        }

        .layer-type-mixed svg {
            fill: var(--figma-color-icon-brand);
        }

        .remove-btn {
            background: transparent;
            color: var(--figma-color-bg-inverse);
            border: none;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            opacity: 0.5;
        }   

        .remove-btn:hover {
            opacity: 1;
        }

        /* Styles for mappings without selected data type */
        .mapping-item:has(.remove-btn[style*="display: flex"]) .mapping-layer {
            opacity: 0.5;
        }

        .mapping-item:has(.remove-btn[style*="display: flex"]) .layer-type-indicator svg {
            fill: var(--figma-color-bg-inverse);
        }

        .remove-btn svg {
            width: 16px;
            height: 16px;
            fill: var(--figma-color-bg-inverse);
        }

        .data-type-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .category-select, .type-select {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            width: 114px;
            font-size: 11px;
            line-height: 16px;
            padding: 4px 8px;
        }

        .type-select:disabled {
            background: #f8f9fa;
            color: #666;
        }

        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
            width: auto;
        }

        .dropdown-button {
            width: 110px;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: var(--figma-color-bg);
            color: var(--figma-color-bg-inverse);
            text-align: left;
            font-size: 11px;
            line-height: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s;
        }

        .dropdown-button:hover {
            border-color: #0066ff;
        }

        .dropdown-button.open {
            border-color: #0066ff;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .dropdown-arrow {
            width: 10px;
            height: 10px;
            fill: #666;
            transition: transform 0.2s;
        }

        .dropdown-button.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-panel {
            position: absolute;
            top: 32px;
            left: -100px;
            min-width: 240px;
            background: var(--figma-color-text-onselected);
            border-top: none;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            color: var(--figma-color-bg);
            backdrop-filter: blur(10px);
        }

        /* Width variants for different panel types */
        .dropdown-panel.two-column {
            min-width: 272px;
            width: 272;
            left: -132px; /* Adjust positioning for wider panel */
        }

        .dropdown-panel.single-column {
            min-width: 136px;
            width: 136px;
            left: 0px; /* Adjust positioning for narrower panel */
        }

        .dropdown-panel.open {
            display: block;
        }

        .dropdown-content {
            padding: 8px;
        }

        .dropdown-columns {
            display: flex;
            gap: 16px;
        }

        .dropdown-column {
            flex: 1;
        }

        .dropdown-column-title {
            font-weight: 400;
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-bg);
            margin-bottom: 6px;
            opacity: 0.5;
            padding: 0px 4px;
        }

        .dropdown-option {
            padding: 4px;
            font-size: 11px;
            line-height: 16px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.15s;
        }

        .dropdown-option:hover {
            background: var(--figma-color-bg-inverse);
            color: var(--figma-color-bg);
        }

        .dropdown-option:hover svg {
            fill: var(--figma-color-bg);
        }

        .dropdown-option.selected {
            background: var(--figma-color-bg);
            color: var(--figma-color-text);
        }

        .dropdown-option.selected svg {
            fill: var(--figma-color-text);
        }

        .option-checkmark {
            font-size: 12px;
            color: var(--figma-color-text);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .dropdown-option.selected .option-checkmark {
            opacity: 1;
        }

        /* SVG icon styling in dropdown options */
        .dropdown-option svg {
            fill: currentColor;
            flex-shrink: 0;
        }

        /* SVG checkmark styling */
        .option-checkmark svg {
            fill: currentColor;
            flex-shrink: 0;
        }

        /* SVG icon styling in dropdown button */
        .dropdown-text svg {
            fill: currentColor;
            flex-shrink: 0;
        }

        .status-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .status-success {
            background: var(--figma-color-bg-success-tertiary);
            color: var(--figma-color-text-success);
            border: 1px solid var(--figma-color-border-success);
        }

        .status-error {
            background: var(--figma-color-bg-danger-tertiary);
            color: var(--figma-color-text-danger);
            border: 1px solid var(--figma-color-border-danger);
        }

        .mappings-container {
            overflow: visible;
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 4px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--figma-color-text);
            padding: 20px;
            font-size: 11px;
            line-height: 16px;
            font-weight: 400;
            height: 280px;
            opacity: 0.5;
        }

        /* Progress Screen Styles */
        .progress-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            background-color: var(--figma-color-bg);
            z-index: 50;
        }

        .progress-screen.active {
            display: flex;
        }

        .progress-content {
            text-align: center;
            padding: 40px;
            border-radius: 12px;
            max-width: 320px;
            width: 70%;
        }

        .progress-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e1e5e9;
            border-top: 4px solid #0066ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .progress-status {
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            opacity: 0.75;
        }

        .progress-warning {
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            padding: 0px 12px;
            opacity: 0.75;
        }

        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: var(--figma-color-bg-tertiary);
            border-radius: 4px;
            margin: 16px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007BE5 0%, #FFC5D0 50%, #FFAE75 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Selection Onboarding Screen Styles */
        .selection-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 24px;
            background-color: var(--figma-color-bg);
            z-index: 50;
        }

        .selection-screen.active {
            display: flex;
        }

        .selection-content {
            text-align: center;
            background: var(--figma-color-bg);
            padding: 16px;
            max-width: 360px;
            height: 200px;
        }

        .selection-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .selection-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
        }

        .selection-message {
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text);
            line-height: 1.5;
            margin: 9px 24px 24px 24px;
            opacity: 0.75;
        }

        .synced-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
            background: var(--figma-color-bg-component-tertiary);
            padding: 4px;
            border-radius: 6px;
        }

        .sync-url-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            margin-bottom: 8px;
        }

        .synced-input-container {
             display: flex;
             flex-direction: row;
             gap: 4px;
         }

        .synced-container .sync-url-input {
            border: 1px solid var(--figma-color-border-component);
            text-align: left;
            background: var(--figma-color-border-component);
            color: var(--figma-color-text);
        }

        .synced-container .sync-url-input:focus {
            border: 1px solid var(--figma-color-border-component-hover);
        }

        .synced-container div .selection-scan-button {
            border: none;
        }

        .sheet-preview-container {
             margin: 8px 0 0 0;
        }

        .sync-url-input {
            width: 100%;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 11px;
            line-height: 20px;
            color: var(--figma-color-text);
            background: var(--figma-color-bg-hover);
            border: 1px solid var(--figma-color-bg-hover);
            text-align: center;
        }

        .sync-url-input:focus {
            outline: none;
            border: 1px solid var(--figma-color-border);
        }

        .sync-url-input::placeholder {
            color: var(--figma-color-text);
            opacity: 0.5;
        }

        .sync-url-error {
            color: var(--figma-color-text-warning);
            font-size: 11px;
            line-height: 16px;
            padding: 4px 8px;
            display: none;
            margin: 0;
            text-align: center;
            background: var(--figma-color-bg-warning-tertiary);
            border-radius: 6px;
        }

        .license-error {
            color: var(--figma-color-text-danger);
            font-size: 11px;
            margin-top: 4px;
            display: none;
            text-align: left;
        }

        .license-input-error {
            border-color: var(--figma-color-border-danger) !important;
        }

        .selection-scan-button {
            width: 100%;
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            color: var(--figma-color-text);
            border: 1px solid var(--figma-color-border);
            background: var(--figma-color-bg);
            font-size: 11px;
            line-height: 20px;
            opacity: 1;
        }

        .selection-scan-button svg {
            width: 16px;
            height: 16px;
            fill: var(--figma-color-text);
        }

        .selection-scan-button:hover {
            background: var(--figma-color-bg-inverse);
            border: 1px solid var(--figma-color-bg-inverse);
            color: var(--figma-color-bg);
            opacity: 1;
        }

        .selection-scan-button:hover svg {
            fill: var(--figma-color-bg);
        }

        .selection-scan-button:disabled {
            cursor: not-allowed;
            opacity: 0.25;
        }



        .selection-notice {
            font-size: 11px;
            line-height: 16px;
            color: var(--figma-color-text-brand);
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--figma-color-bg-brand-tertiary);
        }

        /* Tab System Styles */
        .tab-container {
            position: relative;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .tab-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            background: transparent;
            gap: 4px;
            padding: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 2px 8px;
            border: none;
            background: transparent;
            color: var(--figma-color-text);
            font-weight: 510;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            line-height: 20px;
            opacity: 0.5;
            border-radius: 6px;
        }

        .tab-button:hover {
            background: var(--figma-color-bg-hover);
            opacity: 1;
        }

        .tab-button.active {
            color: var(--figma-color-text);
            background: var(--figma-color-bg-hover);
            opacity: 1;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .tab-panel {
            flex: 1;
            overflow-y: auto;
        }

        .empty-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-style: italic;
        }

        /* Configuration Panel Toggle Styles */
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e1e8ed;
        }

        .config-title {
            font-weight: 500;
            color: #1a1a1a;
        }

        .config-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            transition: background-color 0.2s;
        }

        .config-toggle:hover {
            background: var(--figma-color-bg-selected-secondary);
        }

        .config-toggle svg {
            width: 16px;
            height: 16px;
            fill: var(--figma-color-icon);
            transition: fill 0.2s;
        }

        .config-toggle.open svg {
            fill: var(--figma-color-icon-brand);
        }

        .config-body {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .config-body.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        /* Google Sheets sync styles */
        .sheet-preview {
            margin-bottom: 8px;
        }

        .preview-table {
            border: 1px solid var(--figma-color-border-component);
            border-radius: 6px;
            overflow: hidden;
            font-size: 11px;
        }

        .preview-row {
            display: flex;
            min-height: 24px;
        }

        .preview-row.header {
            background: transparent;
            font-weight: 510;
        }

        .preview-cell {
            flex: 1;
            padding: 4px 6px;
            border-right: 1px solid var(--figma-color-border-component);
            border-bottom: 1px solid var(--figma-color-border-component);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            font-size: 11px;
            line-height: 16px;
        }

        .preview-cell:last-child {
            border-right: none;
        }

        .preview-row:last-child .preview-cell {
            border-bottom: none;
        }

        .sync-mapping-item {
            margin-bottom: 0px;
        }

        .upgrade-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            text-align: center;
            height: 450px;
        }

        /* Quota tooltip styles */
        .quota-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--figma-color-bg-inverse);
            color: var(--figma-color-bg-onselected);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            line-height: 16px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quota-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--figma-color-bg-inverse);
        }

        .quota-tooltip-warning {
            background: var(--figma-color-bg-warning-tertiary);
            color: var(--figma-color-text-warning);
        }

        .quota-tooltip-warning::after {
            border-top-color: #ff6b6b;
        }

        .quota-link {
            text-decoration: underline;
            cursor: pointer;
            color: inherit;
            opacity: 0.9;
        }

        .quota-link:hover {
            opacity: 1;
        }

        /* Persistent quota warning */
        .quota-tooltip.quota-persistent {
            position: static;
            transform: none;
            margin: 4px 0 0 0;
            left: auto;
            bottom: auto;
            display: block;
            white-space: normal;
            text-align: center;
        }

        .quota-tooltip.quota-persistent::after {
            display: none;
        }

        /* Button container for tooltip positioning */
        .button-container {
            position: relative;
            display: flex;
            width: 100%;
            flex-direction: column;
        }

    </style>
</head>
<body>
    <!-- Tab System -->
    <div class="tab-container">
        <nav class="tab-nav">
            <button class="tab-button active" data-tab="generate">Generate</button>
            <button class="tab-button" data-tab="sync">Sync</button>
            <button class="tab-button" data-tab="license">Upgrade</button>
            <span id="license-reset" style="position: absolute; right: 10px; top: 10px; font-size: 10px; color: #666; cursor: pointer; user-select: none;">rst</span>
        </nav>
        
        <!-- Generate Tab Content -->
        <div id="generate-tab" class="tab-content active">
            <div class="tab-panel" style="position: relative;">
                <div class="container">
                    <!-- Scan Section -->
                    <div class="section">
                        <button id="scan-button" class="selection-scan-button">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 10.833C2.27603 10.833 2.49982 11.057 2.5 11.333V12.666C2.5 12.887 2.58796 13.0996 2.74414 13.2559C2.90033 13.412 3.11219 13.4999 3.33301 13.5H4.66699L4.76758 13.5098C4.99525 13.5564 5.16684 13.7586 5.16699 14C5.16684 14.2414 4.99519 14.4426 4.76758 14.4893L4.66699 14.5H3.33301C2.84697 14.4999 2.38083 14.3065 2.03711 13.9629C1.6934 13.6191 1.5 13.1522 1.5 12.666V11.333C1.50018 11.057 1.72397 10.833 2 10.833ZM14 10.833C14.2759 10.8332 14.4998 11.0571 14.5 11.333V12.666C14.5 13.1522 14.3067 13.6191 13.9629 13.9629C13.6191 14.3067 13.1522 14.5 12.666 14.5H11.333C11.0571 14.4999 10.8332 14.2759 10.833 14C10.8332 13.7241 11.0571 13.5001 11.333 13.5H12.666C12.887 13.5 13.0996 13.4121 13.2559 13.2559C13.4121 13.0996 13.5 12.887 13.5 12.666V11.333C13.5002 11.0571 13.7241 10.8331 14 10.833ZM8.66699 10.167C8.94302 10.1671 9.16699 10.3909 9.16699 10.667C9.16682 10.9429 8.94291 11.1669 8.66699 11.167H4.66699C4.39096 11.167 4.16717 10.943 4.16699 10.667C4.16699 10.3908 4.39085 10.167 4.66699 10.167H8.66699ZM11.4346 7.50977C11.6623 7.5565 11.834 7.75848 11.834 8C11.834 8.24152 11.6623 8.4435 11.4346 8.49023L11.334 8.5H4.66699C4.39085 8.5 4.16699 8.27614 4.16699 8C4.16699 7.72386 4.39085 7.5 4.66699 7.5H11.334L11.4346 7.50977ZM10 4.83301C10.2759 4.83314 10.4998 5.0571 10.5 5.33301C10.5 5.60907 10.276 5.83288 10 5.83301H4.66699C4.39085 5.83301 4.16699 5.60915 4.16699 5.33301C4.16717 5.05702 4.39096 4.83301 4.66699 4.83301H10ZM4.76758 1.50977C4.99539 1.55641 5.16699 1.7584 5.16699 2C5.16699 2.2416 4.99539 2.44359 4.76758 2.49023L4.66699 2.5H3.33301C3.11211 2.50009 2.90034 2.58794 2.74414 2.74414C2.58794 2.90034 2.50009 3.11211 2.5 3.33301V4.66699C2.49982 4.94298 2.27603 5.16699 2 5.16699C1.72397 5.16699 1.50018 4.94298 1.5 4.66699V3.33301C1.50009 2.8469 1.69337 2.38085 2.03711 2.03711C2.38085 1.69337 2.8469 1.50009 3.33301 1.5H4.66699L4.76758 1.50977ZM12.666 1.5C13.1522 1.5 13.6191 1.69337 13.9629 2.03711C14.3065 2.38083 14.4999 2.84697 14.5 3.33301V4.66699C14.4998 4.94288 14.2759 5.16682 14 5.16699C13.7241 5.16686 13.5002 4.9429 13.5 4.66699V3.33301C13.4999 3.11219 13.412 2.90033 13.2559 2.74414C13.0996 2.58794 12.887 2.5 12.666 2.5H11.333C11.057 2.49987 10.833 2.27606 10.833 2C10.833 1.72394 11.057 1.50013 11.333 1.5H12.666Z" />
                            </svg>
                            <span id="scan-text">Re-scan layers</span>
                            <div id="scan-loading" class="loading-spinner" style="display: none;"></div>
                        </button>
                    </div>

                    <!-- Mappings Section -->
                    <div class="section">
                        <div id="mappings-container" class="mappings-container">
                            <div class="empty-state">
                                Click "Scan for % layers" to find layers that need data
                            </div>
                        </div>
                    </div>

                    <!-- Apply Section - Moved outside container to be sticky -->
                </div>
                
                <!-- Sticky Apply Section -->
                <div class="apply-section">
                    <div class="button-container">
                        <button id="apply-button" class="apply-button" disabled>
                            <span id="apply-text">Apply data to layers</span>
                            <div id="apply-loading" class="loading-spinner" style="display: none;"></div>
                        </button>
                    </div>
                </div>

                <!-- Selection Onboarding Screen (Generate tab only) -->
                <div id="selection-screen" class="selection-screen">
                    <div class="selection-content">
                        <div class="selection-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 21.667C4.55228 21.667 5 22.1147 5 22.667V25.334C5.00018 25.7757 5.17599 26.1993 5.48828 26.5117C5.80082 26.8242 6.22505 27 6.66699 27H9.33301C9.88518 27 10.3328 27.4479 10.333 28C10.3328 28.5521 9.88517 29 9.33301 29H6.66699C5.69477 29 4.7618 28.6141 4.07422 27.9268C3.38675 27.2393 3.00018 26.3062 3 25.334V22.667C3 22.1147 3.44772 21.667 4 21.667ZM28 21.667C28.5522 21.6671 29 22.1148 29 22.667V25.334C28.9998 26.3062 28.6142 27.2393 27.9268 27.9268C27.2393 28.6142 26.3062 28.9998 25.334 29H22.667C22.1148 29 21.6672 28.5521 21.667 28C21.6672 27.4479 22.1148 27 22.667 27H25.334C25.7758 26.9998 26.1993 26.8241 26.5117 26.5117C26.8241 26.1993 26.9998 25.7758 27 25.334V22.667C27 22.1148 27.4479 21.6672 28 21.667ZM17.333 20.333C17.8852 20.333 18.3328 20.7809 18.333 21.333C18.333 21.8853 17.8853 22.333 17.333 22.333H9.33301C8.78084 22.3329 8.33301 21.8852 8.33301 21.333C8.33321 20.781 8.78096 20.3331 9.33301 20.333H17.333ZM22.666 15C23.2183 15 23.666 15.4477 23.666 16C23.666 16.5523 23.2183 17 22.666 17H9.33301C8.78084 16.9999 8.33301 16.5522 8.33301 16C8.33301 15.4478 8.78084 15.0001 9.33301 15H22.666ZM20.1016 9.67188C20.606 9.72291 21 10.1491 21 10.667C20.9998 11.1847 20.6059 11.6111 20.1016 11.6621L20 11.667H9.33301C8.78096 11.6669 8.33321 11.219 8.33301 10.667C8.33301 10.1148 8.78084 9.66712 9.33301 9.66699H20L20.1016 9.67188ZM9.33301 3C9.88529 3 10.333 3.44772 10.333 4C10.333 4.55228 9.88529 5 9.33301 5H6.66699C6.22496 5 5.80084 5.17572 5.48828 5.48828C5.17572 5.80084 5 6.22496 5 6.66699V9.33301C5 9.88529 4.55228 10.333 4 10.333C3.44772 10.333 3 9.88529 3 9.33301V6.66699C3 5.69453 3.38659 4.76185 4.07422 4.07422C4.76185 3.38659 5.69453 3 6.66699 3H9.33301ZM25.334 3C26.3062 3.00015 27.2393 3.38672 27.9268 4.07422C28.6141 4.76181 29 5.69474 29 6.66699V9.33301C29 9.88521 28.5522 10.3329 28 10.333C27.4479 10.3328 27 9.88518 27 9.33301V6.66699C27 6.22502 26.8242 5.80083 26.5117 5.48828C26.1993 5.17596 25.7757 5.00015 25.334 5H22.667C22.1147 5 21.667 4.55228 21.667 4C21.667 3.44772 22.1147 3 22.667 3H25.334Z" fill="url(#paint0_linear_750_684)"/>
                                <defs>
                                <linearGradient id="paint0_linear_750_684" x1="16" y1="1.5" x2="16" y2="29" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#007BE5"/>
                                <stop offset="0.519231" stop-color="#FFC5D0"/>
                                <stop offset="1" stop-color="#FFBDA7"/>
                                </linearGradient>
                                </defs>
                            </svg> 
                        </div>
                        <div class="selection-message">
                            Add the prefix "%" to all the layers you want to populate with data.
                        </div>
                        <button id="selection-scan-button" class="selection-scan-button">
                            <span>Scan layers</span>
                        </button>
                        <div id="selection-notice" class="selection-notice" style="display: none;">
                            Select a layer to scan
                        </div>
                    </div>
                </div>

                <!-- Progress Screen (Generate tab only) -->
                <div id="progress-screen" class="progress-screen">
                    <div class="progress-content">
                        <div class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                        <div id="progress-status" class="progress-status">Applying data to...</div>
                        <div class="progress-warning">Do not close the plugin</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sync Tab Content -->
        <div id="sync-tab" class="tab-content">
            <div class="tab-panel" style="position: relative;">
                <div class="container" id="sync-main-container">
                    <!-- Google Sheets URL Section -->
                    <div class="section">
                        <div class="synced-container">
                            <div class="synced-input-container">
                                <input 
                                type="text" 
                                id="sheet-url-input" 
                                placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit"
                                class="sync-url-input"
                                />
                                <button id="clear-sync-button" class="clear-sync-button" title="Clear sync">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_813_4925)">
                                        <path d="M10.667 12.167C10.943 12.1672 11.167 12.391 11.167 12.667V14.667C11.1668 14.9429 10.9429 15.1668 10.667 15.167C10.391 15.167 10.1672 14.943 10.167 14.667V12.667C10.167 12.3908 10.3908 12.167 10.667 12.167ZM3.09277 7.47949C3.28793 7.28448 3.60456 7.28464 3.7998 7.47949C3.99502 7.67471 3.99493 7.99125 3.7998 8.18652L2.66602 9.32031L2.48145 9.53125C2.07752 10.0425 1.86002 10.6807 1.87109 11.3379C1.88387 12.0885 2.19436 12.8037 2.7334 13.3262C3.26219 13.8361 3.96851 14.121 4.70312 14.1211C5.43782 14.1211 6.14401 13.8362 6.67285 13.3262L7.80664 12.1924C8.00183 11.9977 8.31854 11.9976 8.51367 12.1924C8.70878 12.3875 8.70848 12.7041 8.51367 12.8994L7.36719 14.0459C6.65196 14.7356 5.69675 15.1211 4.70312 15.1211C3.77174 15.121 2.87456 14.7824 2.17676 14.1719L2.03906 14.0459C1.30903 13.339 0.889316 12.3706 0.87207 11.3545C0.854969 10.3385 1.24165 9.35714 1.94727 8.62598L1.95312 8.61914L3.09277 7.47949ZM14.667 10.167C14.943 10.1672 15.167 10.391 15.167 10.667C15.1668 10.9429 14.9429 11.1668 14.667 11.167H12.667C12.391 11.167 12.1672 10.943 12.167 10.667C12.167 10.3908 12.3908 10.167 12.667 10.167H14.667ZM11.2959 0.87793C12.2272 0.87793 13.1254 1.2167 13.8232 1.82715L13.96 1.95312L13.9609 1.9541C14.6908 2.6609 15.1106 3.62865 15.1279 4.64453C15.1445 5.6227 14.7852 6.56739 14.1289 7.28906C14.1087 7.32148 14.0864 7.35316 14.0586 7.38086L12.9121 8.52051C12.7163 8.7152 12.3998 8.71439 12.2051 8.51855C12.0108 8.32269 12.0114 8.00606 12.207 7.81152L13.2812 6.74219C13.2966 6.72001 13.3139 6.69853 13.333 6.67871C13.8547 6.13807 14.1407 5.41232 14.1279 4.66113C14.115 3.91019 13.8052 3.19432 13.2656 2.67188V2.67285C12.7368 2.16315 12.0304 1.87793 11.2959 1.87793C10.5616 1.87811 9.85579 2.16317 9.32715 2.67285L8.18555 3.80762C7.98975 4.00226 7.67322 4.00138 7.47852 3.80566C7.28416 3.60985 7.28485 3.29323 7.48047 3.09863L8.62695 1.95801L8.63281 1.95312C9.34786 1.26362 10.3026 0.878115 11.2959 0.87793ZM3.33301 4.83301C3.60904 4.83301 3.83283 5.05702 3.83301 5.33301C3.83301 5.60915 3.60915 5.83301 3.33301 5.83301H1.33301C1.05703 5.83281 0.833008 5.60903 0.833008 5.33301C0.833185 5.05714 1.05714 4.83321 1.33301 4.83301H3.33301ZM5.33301 0.833008C5.60904 0.833008 5.83283 1.05702 5.83301 1.33301V3.33301C5.83301 3.60915 5.60915 3.83301 5.33301 3.83301C5.05703 3.83281 4.83301 3.60903 4.83301 3.33301V1.33301C4.83318 1.05714 5.05714 0.833205 5.33301 0.833008Z" />
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_813_4925">
                                        <rect width="16" height="16" />
                                        </clipPath>
                                        </defs>
                                        </svg>
                                        
                                </button>
                            </div>
                            
                            <!-- Sheet Preview Section -->
                            <div id="sheet-preview-container" class="sheet-preview-container" style="display: none;">
                            </div>
                            
                            <div style="display: flex;">
                                <button id="sync-sheet-button" class="selection-scan-button" style="flex: 1;">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M2 7.5C2.27614 7.5 2.5 7.72386 2.5 8C2.5 9.45869 3.07988 10.8572 4.11133 11.8887C5.14232 12.9197 6.54006 13.4985 7.99805 13.499C9.54638 13.4932 11.0323 12.8896 12.1455 11.8135L12.792 11.167H10.667C10.391 11.167 10.1672 10.943 10.167 10.667C10.167 10.3908 10.3908 10.167 10.667 10.167H14C14.0327 10.167 14.0655 10.1694 14.0977 10.1758L14.1016 10.1768C14.1618 10.1892 14.2175 10.2131 14.2676 10.2451C14.2754 10.2501 14.2824 10.2563 14.29 10.2617C14.3089 10.2753 14.327 10.2896 14.3438 10.3057C14.3467 10.3085 14.3506 10.3105 14.3535 10.3135C14.3571 10.3171 14.3598 10.3215 14.3633 10.3252C14.3771 10.3399 14.3894 10.3557 14.4014 10.3721C14.4096 10.3833 14.4176 10.3945 14.4248 10.4062C14.4352 10.4232 14.4438 10.4408 14.4521 10.459C14.4559 10.4672 14.4605 10.475 14.4639 10.4834C14.4718 10.5036 14.4781 10.5245 14.4834 10.5459C14.4859 10.556 14.4893 10.5659 14.4912 10.5762C14.4966 10.6055 14.5 10.6361 14.5 10.667V14C14.4998 14.2759 14.2759 14.4998 14 14.5C13.7241 14.4998 13.5002 14.2759 13.5 14V11.874L12.8408 12.5332C11.5421 13.7886 9.80822 14.4932 8.00195 14.5H8C6.27609 14.5 4.62231 13.8157 3.40332 12.5967C2.18433 11.3777 1.5 9.72391 1.5 8C1.5 7.72386 1.72386 7.5 2 7.5ZM8 1.5C9.72391 1.5 11.3777 2.18433 12.5967 3.40332C13.8157 4.62231 14.5 6.27609 14.5 8C14.5 8.27614 14.2761 8.5 14 8.5C13.7239 8.5 13.5 8.27614 13.5 8C13.5 6.54131 12.9201 5.14278 11.8887 4.11133C10.8575 3.08011 9.45931 2.50026 8.00098 2.5C6.45297 2.50606 4.96749 3.11056 3.85449 4.18652L3.20801 4.83301H5.33301C5.60904 4.83301 5.83283 5.05702 5.83301 5.33301C5.83301 5.60915 5.60915 5.83301 5.33301 5.83301H2C1.96695 5.83301 1.93389 5.82976 1.90137 5.82324C1.85024 5.81301 1.80299 5.79309 1.75879 5.76855C1.71891 5.74644 1.68034 5.72038 1.64648 5.68652C1.61232 5.65233 1.58568 5.61357 1.56348 5.57324C1.52404 5.50174 1.5 5.42044 1.5 5.33301V2C1.5 1.72386 1.72386 1.5 2 1.5C2.27614 1.5 2.5 1.72386 2.5 2V4.12598L3.15918 3.4668C4.45789 2.21141 6.19178 1.50681 7.99805 1.5H8Z" />
                                    </svg>                                        
                                    <span id="sync-text">Sync & re-scan layers</span>
                                    <div id="sync-loading" class="loading-spinner" style="display: none;"></div>
                                </button>
                                
                            </div>
                        </div>
                    </div>

                    <!-- Layer Mappings Section -->
                    <div class="section">
                        <div id="sync-mappings-container" class="mappings-container">
                            <div class="empty-state">
                                Paste a Google Sheets URL and click "Sync & Scan Layers" to get started
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sticky Apply Section for Sync -->
                <div id="sync-apply-section" class="apply-section" style="display: none;">
                    <div class="button-container">
                        <button id="sync-apply-button" class="apply-button">
                            <span id="sync-apply-text">Apply data to layers</span>
                            <div id="sync-apply-loading" class="loading-spinner" style="display: none;"></div>
                        </button>
                    </div>
                </div>

                <!-- Sync Pre-Selection Screen (Sync tab only) -->
                <div id="sync-selection-screen" class="selection-screen">
                    <div class="selection-content">
                        <div class="selection-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M25.333 1.66699C25.9518 1.66699 26.5458 1.913 26.9834 2.35059C27.4207 2.78806 27.6659 3.38146 27.666 4V28C27.6659 28.6186 27.4208 29.2129 26.9834 29.6504C26.5458 30.0878 25.9517 30.334 25.333 30.334H8.66602C7.51705 30.3338 6.41504 29.8768 5.60254 29.0645C4.78997 28.2519 4.3331 27.1491 4.33301 26V6C4.33309 4.85099 4.79015 3.74908 5.60254 2.93652C6.41506 2.124 7.51695 1.66714 8.66602 1.66699H25.333ZM8.66602 23.667C8.04738 23.6671 7.45405 23.9131 7.0166 24.3506C6.57928 24.7881 6.33309 25.3814 6.33301 26C6.3331 26.6187 6.5791 27.2129 7.0166 27.6504C7.45403 28.0877 8.04749 28.3338 8.66602 28.334H25.333C25.4211 28.334 25.5059 28.2984 25.5684 28.2363C25.6308 28.1739 25.6659 28.0883 25.666 28V23.667H8.66602ZM8.66602 3.66699C8.04738 3.66714 7.45405 3.91314 7.0166 4.35059C6.57928 4.78806 6.33309 5.38142 6.33301 6V22.3496C7.02433 21.9078 7.83273 21.6671 8.66602 21.667H25.666V4C25.6659 3.91174 25.6308 3.82708 25.5684 3.76465C25.5059 3.70224 25.4213 3.66699 25.333 3.66699H8.66602ZM16 8.33301C16.5522 8.33301 16.9998 8.78089 17 9.33301V14.9189L19.293 12.626C19.6835 12.2357 20.3166 12.2356 20.707 12.626C21.0975 13.0164 21.0974 13.6495 20.707 14.04L16.707 18.04C16.6832 18.0639 16.6579 18.0861 16.6318 18.1074C16.5948 18.1378 16.5557 18.1643 16.5156 18.1885C16.4446 18.2314 16.3682 18.2657 16.2871 18.29C16.2813 18.2918 16.2754 18.2933 16.2695 18.2949C16.2151 18.3101 16.1593 18.3223 16.1016 18.3281C16.0337 18.335 15.9653 18.3351 15.8975 18.3281C15.8432 18.3226 15.7906 18.3117 15.7393 18.2979C15.7288 18.295 15.7184 18.2922 15.708 18.2891C15.6284 18.2648 15.5532 18.2308 15.4834 18.1885C15.4434 18.1643 15.4042 18.1378 15.3672 18.1074C15.3413 18.0862 15.3166 18.0637 15.293 18.04L11.293 14.04C10.9026 13.6495 10.9025 13.0165 11.293 12.626C11.6835 12.2357 12.3166 12.2356 12.707 12.626L15 14.9189V9.33301C15.0002 8.78089 15.4478 8.33301 16 8.33301Z" fill="url(#paint0_linear_750_2116)"/>
                                <defs>
                                <linearGradient id="paint0_linear_750_2116" x1="15.9995" y1="0.0131273" x2="15.9995" y2="30.334" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#007BE5"/>
                                <stop offset="0.519231" stop-color="#FFC5D0"/>
                                <stop offset="1" stop-color="#FFBDA7"/>
                                </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="selection-message">
                            Sync data from a Google Sheet and use it to populate your layers with "%” prefix.
                        </div>
                        <div class="sync-url-container">
                            <input 
                                type="text" 
                                id="sync-url-input" 
                                placeholder="Paste Google Sheet shared link"
                                class="sync-url-input"
                            />
                            <div id="sync-url-error" class="sync-url-error"></div>
                        </div>
                        <button id="sync-selection-scan-button" class="selection-scan-button" style="display: none;">
                            <span>Sync and scan layer</span>
                        </button>
                        <div id="sync-selection-notice" class="selection-notice" style="display: none;">
                            Select a layer to scan.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- License Tab Content -->
        <div id="license-tab" class="tab-content">
            <div class="tab-panel">
                <div class="upgrade-content">
                    <!-- SVG Icon -->
                    <div>
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.1953 1.3667C17.169 1.16734 19.1469 1.70886 20.7441 2.88525C22.3414 4.06186 23.445 5.79072 23.8398 7.73486C23.9861 8.45635 23.5193 9.15965 22.7979 9.30615C22.0765 9.45225 21.3731 8.98649 21.2266 8.26514C20.9634 6.96922 20.2277 5.8171 19.1631 5.03271C18.0983 4.24847 16.7796 3.88716 15.4639 4.02002C14.1482 4.15299 12.9284 4.77013 12.042 5.75146C11.1556 6.73291 10.6648 8.00908 10.666 9.33154V13.3335H25.333C27.5421 13.3335 29.333 15.1244 29.333 17.3335V26.6665C29.333 28.8756 27.5421 30.6665 25.333 30.6665H6.66699C4.45785 30.6665 2.66699 28.8756 2.66699 26.6665V17.3335C2.66705 15.1244 4.45789 13.3335 6.66699 13.3335H8V9.3335C7.99828 7.35005 8.7331 5.43638 10.0625 3.96436C11.3921 2.4922 13.2217 1.56622 15.1953 1.3667ZM6.66699 15.9995C5.93065 15.9995 5.33306 16.5972 5.33301 17.3335V26.6665C5.33301 27.4029 5.93061 27.9995 6.66699 27.9995H25.333C26.0694 27.9995 26.667 27.4029 26.667 26.6665V17.3335C26.6669 16.5972 26.0694 15.9995 25.333 15.9995H6.66699Z" fill="url(#paint0_linear_824_5878)"/>
                            <defs>
                                <linearGradient id="paint0_linear_824_5878" x1="16" y1="-0.36605" x2="16" y2="30.667" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#007BE5"/>
                                    <stop offset="0.519231" stop-color="#FFC5D0"/>
                                    <stop offset="1" stop-color="#FFBDA7"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>

                    <!-- Title -->
                    <h2>Unlock unlimited requests</h2>

                    <!-- Description -->
                    <p>Enter your license key and unlock unlimited requests. You can find your license key in your confirmation email.</p>

                    <!-- License Key Input Section -->
                    <div style="margin-bottom: 24px; width: 100%; max-width: 320px;">
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input 
                                id="license-key-input"
                                type="text" 
                                placeholder="Enter your license key"
                                class="sync-url-input"
                                style="flex: 1; text-align: left;"
                            />
                            <button id="validate-license-button" class="selection-scan-button" style="width: auto; flex-shrink: 0; padding: 4px 12px;">
                                Validate
                            </button>
                        </div>
                        <div id="license-error" class="license-error"></div>
                    </div>

                    <!-- Need License Text -->
                    <p>Do you need a license key?</p>

                    <!-- Get License Button -->
                    <button id="get-license-button" class="apply-button" style="width: 100%; max-width: 320px;">
                        <span>Get it now</span>
                    </button>
                </div>
                
                <!-- License Success Confirmation -->
                <div id="license-success-content" class="upgrade-content" style="display: none;">
                    <!-- Success Icon -->
                    <div>
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 1.33398C24.0999 1.33418 30.6668 7.90009 30.667 16C30.6668 24.0999 24.0999 30.6668 16 30.667C7.90009 30.6668 1.33418 24.0999 1.33398 16C1.33416 7.90008 7.90008 1.33416 16 1.33398ZM16 4C9.37284 4.00018 4.00018 9.37284 4 16C4.0002 22.6271 9.37285 27.9998 16 28C22.6271 27.9998 27.9998 22.6271 28 16C27.9998 9.37285 22.6271 4.0002 16 4ZM19.0576 12.3906C19.5783 11.8701 20.4217 11.8701 20.9424 12.3906C21.463 12.9113 21.463 13.7547 20.9424 14.2754L15.6094 19.6094C15.0887 20.1299 14.2443 20.13 13.7236 19.6094L11.0576 16.9424C10.5371 16.4217 10.537 15.5773 11.0576 15.0566C11.5782 14.5365 12.4218 14.5366 12.9424 15.0566L14.666 16.7803L19.0576 12.3906Z" fill="url(#paint0_linear_828_6137)"/>
                            <defs>
                                <linearGradient id="paint0_linear_828_6137" x1="16.0005" y1="-0.358305" x2="16.0005" y2="30.667" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#007BE5"/>
                                    <stop offset="0.519231" stop-color="#FFC5D0"/>
                                    <stop offset="1" stop-color="#FFBDA7"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>

                    <!-- Title -->
                    <h2>License activated</h2>

                    <!-- Description -->
                    <p>Your plugin has been successfully upgraded and now you can apply data without daily limits. Remember your license key can be used up to 10 times in case of reinstall or multiple devices.</p>

                    <!-- Continue Button -->
                    <button id="license-continue-button" class="apply-button" style="width: 100%; max-width: 320px;">
                        <span>Continue</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Embedded Faker.js Implementation for Figma Plugin -->
    <script>
        console.log('🚀 Loading embedded Faker.js implementation...');
        
        // Create a minimal but functional Faker.js implementation
        window.faker = {
            person: {
                fullName: function() {
                    var firstNames = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra'];
                    var lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson'];
                    return firstNames[Math.floor(Math.random() * firstNames.length)] + ' ' + lastNames[Math.floor(Math.random() * lastNames.length)];
                },
                firstName: function() {
                    var names = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra'];
                    return names[Math.floor(Math.random() * names.length)];
                },
                lastName: function() {
                    var names = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson'];
                    return names[Math.floor(Math.random() * names.length)];
                }
            },
            location: {
                city: function() {
                    var cities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose', 'Austin', 'Jacksonville', 'Fort Worth', 'Columbus', 'Charlotte', 'San Francisco', 'Indianapolis', 'Seattle', 'Denver', 'Washington', 'Boston', 'El Paso', 'Nashville', 'Detroit', 'Oklahoma City', 'Portland', 'Las Vegas', 'Memphis', 'Louisville', 'Baltimore'];
                    return cities[Math.floor(Math.random() * cities.length)];
                },
                country: function() {
                    var countries = ['United States', 'Canada', 'Mexico', 'Brazil', 'Argentina', 'United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Russia', 'China', 'Japan', 'India', 'Australia', 'South Africa', 'Egypt', 'Nigeria', 'Kenya', 'Morocco', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Poland', 'Greece'];
                    return countries[Math.floor(Math.random() * countries.length)];
                },
                streetAddress: function() {
                    var streets = ['Main Street', 'First Street', 'Second Street', 'Third Street', 'Park Avenue', 'Oak Street', 'Pine Street', 'Maple Avenue', 'Cedar Street', 'Elm Street', 'Washington Street', 'Lake Street', 'Hill Street', 'Church Street', 'Sunset Boulevard', 'Broadway', 'Fifth Avenue', 'Madison Avenue', 'Lincoln Street', 'Jefferson Avenue'];
                    var number = Math.floor(Math.random() * 9999) + 1;
                    return number + ' ' + streets[Math.floor(Math.random() * streets.length)];
                }
            },
            internet: {
                email: function(options) {
                    var domains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'company.com', 'example.com', 'test.com', 'mail.com', 'email.com', 'service.com'];
                    var names = ['john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'mark', 'anna', 'chris', 'emma', 'alex', 'maria', 'james', 'laura', 'robert', 'helen', 'paul', 'kate', 'steve', 'amy'];
                    
                    // Use custom provider if specified, otherwise random domain
                    var domain = (options && options.provider) ? options.provider : domains[Math.floor(Math.random() * domains.length)];
                    
                    return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 999) + '@' + domain;
                },
                userName: function() {
                    var names = ['user', 'admin', 'guest', 'john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'mark', 'anna', 'chris', 'emma', 'alex', 'maria', 'james', 'laura', 'robert', 'helen', 'paul'];
                    return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 9999);
                }
            },
            company: {
                name: function() {
                    var companies = ['TechCorp', 'InnovateLtd', 'GlobalSolutions', 'DataSystems', 'CloudTech', 'DigitalWorks', 'SmartSolutions', 'TechVision', 'FutureWorks', 'NextGen', 'ProTech', 'EliteServices', 'PrimeTech', 'CoreSystems', 'MegaCorp', 'UltraTech', 'PowerSolutions', 'SpeedTech', 'FlexiCorp', 'DynamicSystems'];
                    return companies[Math.floor(Math.random() * companies.length)];
                }
            },
            commerce: {
                productName: function() {
                    var products = ['Smartphone', 'Laptop', 'Tablet', 'Headphones', 'Camera', 'Watch', 'Speaker', 'Monitor', 'Keyboard', 'Mouse', 'Printer', 'Scanner', 'Router', 'Hard Drive', 'Memory Card', 'Cable', 'Charger', 'Case', 'Stand', 'Dock'];
                    var adjectives = ['Smart', 'Pro', 'Ultra', 'Premium', 'Advanced', 'Digital', 'Wireless', 'Portable', 'Compact', 'High-Tech'];
                    return adjectives[Math.floor(Math.random() * adjectives.length)] + ' ' + products[Math.floor(Math.random() * products.length)];
                }
            },
            lorem: {
                sentence: function() {
                    var sentences = [
                        'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
                        'Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',
                        'Ut enim ad minim veniam, quis nostrud exercitation ullamco.',
                        'Duis aute irure dolor in reprehenderit in voluptate velit esse.',
                        'Excepteur sint occaecat cupidatat non proident, sunt in culpa.',
                        'Nulla facilisi morbi tempus iaculis urna id volutpat lacus.',
                        'Pellentesque habitant morbi tristique senectus et netus.',
                        'Mauris blandit aliquet elit, eget tincidunt nibh pulvinar.',
                        'Vestibulum ante ipsum primis in faucibus orci luctus.',
                        'Curabitur pretium tincidunt lacus nulla gravida orci.'
                    ];
                    return sentences[Math.floor(Math.random() * sentences.length)];
                },
                paragraph: function() {
                    var paragraphs = [
                        'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.',
                        'Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
                        'Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.',
                        'Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt neque porro quisquam est.',
                        'At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.'
                    ];
                    return paragraphs[Math.floor(Math.random() * paragraphs.length)];
                },
                words: function() {
                    var words = ['lorem', 'ipsum', 'dolor', 'sit', 'amet', 'consectetur', 'adipiscing', 'elit', 'sed', 'eiusmod', 'tempor', 'incididunt', 'labore', 'dolore', 'magna', 'aliqua', 'enim', 'minim', 'veniam', 'nostrud'];
                    var count = Math.floor(Math.random() * 5) + 3; // 3-7 words
                    var result = [];
                    for (var i = 0; i < count; i++) {
                        result.push(words[Math.floor(Math.random() * words.length)]);
                    }
                    return result.join(' ');
                }
            },
            number: {
                int: function(options) {
                    var min = (options && options.min !== undefined) ? options.min : 0;
                    var max = (options && options.max !== undefined) ? options.max : 100;
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                },
                float: function(options) {
                    var min = (options && options.min !== undefined) ? options.min : 0;
                    var max = (options && options.max !== undefined) ? options.max : 100;
                    var fractionDigits = (options && options.fractionDigits !== undefined) ? options.fractionDigits : 2;
                    var value = Math.random() * (max - min) + min;
                    return parseFloat(value.toFixed(fractionDigits));
                }
            },
            date: {
                anytime: function() {
                    var now = new Date();
                    var pastDays = Math.floor(Math.random() * 365 * 2); // Random date within 2 years
                    return new Date(now.getTime() - (pastDays * 24 * 60 * 60 * 1000));
                },
                recent: function() {
                    var now = new Date();
                    var daysAgo = Math.floor(Math.random() * 30);
                    return new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
                }
            },
            phone: {
                number: function() {
                    var formats = [
                        function() { return '+1-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return '(' + (Math.floor(Math.random() * 900) + 100) + ') ' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return (Math.floor(Math.random() * 900) + 100) + '.' + (Math.floor(Math.random() * 900) + 100) + '.' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return '+44 ' + (Math.floor(Math.random() * 9000) + 1000) + ' ' + (Math.floor(Math.random() * 900000) + 100000); },
                        function() { return '+33 ' + (Math.floor(Math.random() * 9) + 1) + ' ' + (Math.floor(Math.random() * 90000000) + 10000000); },
                        function() { return '+49 ' + (Math.floor(Math.random() * 900) + 100) + ' ' + (Math.floor(Math.random() * 9000000) + 1000000); },
                        function() { return '+61 ' + (Math.floor(Math.random() * 9) + 1) + ' ' + (Math.floor(Math.random() * 90000000) + 10000000); }
                    ];
                    return formats[Math.floor(Math.random() * formats.length)]();
                }
            },
            finance: {
                amount: function() {
                    return (Math.random() * 999 + 1).toFixed(2);
                }
            }
        };
        
        // Set the loaded flag
        window.fakerLoaded = true;
        
        console.log('✅ Embedded Faker.js successfully loaded!');
        console.log('Available modules:', Object.keys(window.faker));
        console.log('Sample test:', window.faker.person.fullName());
        
        // Emit ready event
        window.dispatchEvent(new CustomEvent('fakerReady', { detail: { faker: window.faker } }));
    </script>

    <script>
// Global variables
var currentMappings = [];
var detailedConfigurations = {};
var scanButton = document.getElementById('scan-button');
var scanText = document.getElementById('scan-text');
var scanLoading = document.getElementById('scan-loading');
var applyButton = document.getElementById('apply-button');
var applyText = document.getElementById('apply-text');
var applyLoading = document.getElementById('apply-loading');
var mappingsContainer = document.getElementById('mappings-container');
var statusContainer = document.getElementById('status-container');
var progressScreen = document.getElementById('progress-screen');
        var selectionScreen = document.getElementById('selection-screen');
        var selectionScanButton = document.getElementById('selection-scan-button');
        var selectionNotice = document.getElementById('selection-notice');
        var applySection = document.querySelector('.apply-section');
var mainContainer = document.querySelector('.container');
var progressStatus = document.getElementById('progress-status');
var progressBar = document.getElementById('progress-bar');

// Sync tab variables
var syncSelectionScreen = document.getElementById('sync-selection-screen');
var syncMainContainer = document.getElementById('sync-main-container');
var syncUrlInput = document.getElementById('sync-url-input');
var syncUrlError = document.getElementById('sync-url-error');
var syncSelectionScanButton = document.getElementById('sync-selection-scan-button');
var syncSelectionNotice = document.getElementById('sync-selection-notice');
var syncApplySection = document.getElementById('sync-apply-section');

// Track sync state
var hasSyncedSheet = false;
var needsRescan = false; // Flag to force rescan instead of showing cached mappings

// License system variables and state
var licenseStatus = {
    isLicensed: false,
    remainingUses: 15,
    canUse: true,
    quotaMessage: ''
};

// License system functionality
function initializeLicenseSystem() {
    // Get license elements
    var validateLicenseButton = document.getElementById('validate-license-button');
    var licenseKeyInput = document.getElementById('license-key-input');
    var licenseError = document.getElementById('license-error');
    var getLicenseButton = document.getElementById('get-license-button');
    var upgradeContent = document.querySelector('.upgrade-content');
    var licenseSuccessContent = document.getElementById('license-success-content');
    var licenseContinueButton = document.getElementById('license-continue-button');
    var licenseReset = document.getElementById('license-reset');
    
         // License validation
     if (validateLicenseButton && licenseKeyInput) {
         // Real-time input validation
         licenseKeyInput.addEventListener('input', function() {
             var licenseKey = this.value.trim();
             var isValid = validateLicenseKeyFormat(licenseKey);
             
             // Visual feedback for input validation
             if (licenseKey.length > 0 && !isValid) {
                 this.classList.add('license-input-error');
                 showLicenseError('Invalid license key format');
             } else {
                 this.classList.remove('license-input-error');
                 hideLicenseError();
             }
             
             // Enable/disable validate button
             validateLicenseButton.disabled = !licenseKey || !isValid;
         });
         
         validateLicenseButton.addEventListener('click', function() {
             var licenseKey = licenseKeyInput.value.trim();
             if (!licenseKey) {
                 showLicenseError('Please enter a license key');
                 return;
             }
             
             if (!validateLicenseKeyFormat(licenseKey)) {
                 showLicenseError('Invalid license key format.');
                 return;
             }
             
             // Fix the setLoadingState call - don't pass null for loading element
             validateLicenseButton.disabled = true;
             validateLicenseButton.textContent = 'Validating...';
             
             parent.postMessage({
                 pluginMessage: {
                     type: 'validate-license',
                     data: { licenseKey: licenseKey }
                 }
             }, '*');
         });
     }
    
    // Get license button - redirect to Gumroad
    if (getLicenseButton) {
        getLicenseButton.addEventListener('click', function() {
            window.open('https://rengifoeder.gumroad.com/l/workflow', '_blank');
        });
    }
    
    // Continue button - force plugin refresh to ensure license status is updated
    if (licenseContinueButton) {
        licenseContinueButton.addEventListener('click', function() {
            // Get current window dimensions and send with refresh request
            var currentWidth = window.innerWidth;
            var currentHeight = window.innerHeight;
            
            parent.postMessage({
                pluginMessage: { 
                    type: 'refresh-plugin',
                    currentSize: { width: currentWidth, height: currentHeight }
                }
            }, '*');
        });
    }
    
    // Reset button for testing
    if (licenseReset) {
        licenseReset.addEventListener('click', function() {
            if (confirm('Clear all license data? (Development only)')) {
                parent.postMessage({
                    pluginMessage: { type: 'clear-license-data' }
                }, '*');
            }
        });
    }
    
    // Request initial license status
    parent.postMessage({
        pluginMessage: { type: 'get-license-status' }
    }, '*');
}

function showLicenseError(message) {
    var licenseError = document.getElementById('license-error');
    var licenseInput = document.getElementById('license-key-input');
    if (licenseError) {
        licenseError.textContent = message;
        licenseError.style.display = 'block';
    }
    if (licenseInput) {
        licenseInput.classList.add('license-input-error');
    }
}

function hideLicenseError() {
    var licenseError = document.getElementById('license-error');
    var licenseInput = document.getElementById('license-key-input');
    if (licenseError) {
        licenseError.style.display = 'none';
    }
    if (licenseInput) {
        licenseInput.classList.remove('license-input-error');
    }
}

function showLicenseSuccess() {
    var upgradeContent = document.querySelector('.upgrade-content');
    var licenseSuccessContent = document.getElementById('license-success-content');
    var upgradeTab = document.querySelector('[data-tab="license"]');
    
    if (upgradeContent && licenseSuccessContent) {
        upgradeContent.style.display = 'none';
        licenseSuccessContent.style.display = 'flex';
    }
    
    // Hide upgrade tab
    if (upgradeTab) {
        upgradeTab.style.display = 'none';
    }
}

function updateLicenseStatus(status) {
    licenseStatus = status;
    updateApplyButtonTooltips();
    
    // Hide upgrade tab if licensed
    if (status.isLicensed) {
        var upgradeTab = document.querySelector('[data-tab="license"]');
        if (upgradeTab) {
            upgradeTab.style.display = 'none';
        }
    }
}

function updateApplyButtonTooltips() {
    var applyButton = document.getElementById('apply-button');
    var syncApplyButton = document.getElementById('sync-apply-button');
    
    updateButtonTooltip(applyButton);
    updateButtonTooltip(syncApplyButton);
}

function updateButtonTooltip(button) {
    if (!button || !licenseStatus || licenseStatus.isLicensed) {
        removeTooltip(button);
        return;
    }
    
    var container = button.parentElement;
    if (!container.classList.contains('button-container')) {
        return;
    }
    
    // Remove existing tooltip
    var existingTooltip = container.querySelector('.quota-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    // Show tooltip/warning when there's a quota message
    if (licenseStatus && !licenseStatus.isLicensed && licenseStatus.quotaMessage) {
        var tooltip = document.createElement('div');
        tooltip.className = 'quota-tooltip';
        
        if (licenseStatus && licenseStatus.remainingUses === 0) {
            // For ran out of requests - show persistent warning
            tooltip.classList.add('quota-tooltip-warning');
            tooltip.classList.add('quota-persistent');
        }
        
        // Lock icon for quota messages
        var lockIcon = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px; vertical-align: middle; flex-shrink: 0;"><path d="M8 0.833008C9.01653 0.833105 9.99213 1.23725 10.7109 1.95605C11.4296 2.67477 11.8338 3.64967 11.834 4.66602V6.83301H12.667C13.6791 6.83318 14.4996 7.6539 14.5 8.66602V13.333C14.5 14.3454 13.6794 15.1658 12.667 15.166H3.33301C2.32064 15.1658 1.5 14.3454 1.5 13.333V8.66602C1.50035 7.6539 2.32085 6.83318 3.33301 6.83301H4.16699V4.66602C4.16717 3.64959 4.5713 2.67479 5.29004 1.95605C6.00882 1.23746 6.98362 0.833094 8 0.833008ZM3.33301 7.83301C2.87314 7.83318 2.50035 8.20619 2.5 8.66602V13.333C2.5 13.7931 2.87292 14.1658 3.33301 14.166H12.667C13.1271 14.1658 13.5 13.7931 13.5 13.333V8.66602C13.4996 8.20619 13.1269 7.83318 12.667 7.83301H3.33301ZM8 1.83301C7.24883 1.83309 6.52831 2.13203 5.99707 2.66309C5.46587 3.19428 5.16717 3.9148 5.16699 4.66602V6.83301H10.834V4.66602C10.8338 3.91489 10.535 3.19427 10.0039 2.66309C9.47264 2.13182 8.75131 1.8331 8 1.83301Z" fill="currentColor"/></svg>';
        
        var parts = licenseStatus.quotaMessage.split('Get unlimited');
        if (parts.length === 2) {
            tooltip.innerHTML = lockIcon + '<span>' + parts[0] + '<span class="quota-link">Get unlimited</span></span>';
            
            var quotaLink = tooltip.querySelector('.quota-link');
            if (quotaLink) {
                quotaLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showTab('license');
                });
            }
        } else {
            tooltip.innerHTML = lockIcon + '<span>' + licenseStatus.quotaMessage + '</span>';
        }
        
        container.appendChild(tooltip);
        
        if (licenseStatus && licenseStatus.remainingUses === 0) {
            // Show persistent warning for ran out of requests
            tooltip.style.display = 'block';
        } else {
            // Normal hover tooltip behavior for remaining uses
            var hideTimeout;
            
            var showTooltip = function() {
                if (licenseStatus && !licenseStatus.isLicensed && licenseStatus.quotaMessage) {
                    clearTimeout(hideTimeout);
                    tooltip.style.display = 'block';
                }
            };
            
            var hideTooltip = function() {
                hideTimeout = setTimeout(function() {
                    tooltip.style.display = 'none';
                }, 200); // 200ms delay
            };
            
            var cancelHide = function() {
                clearTimeout(hideTimeout);
            };
            
            // Button hover events
            button.addEventListener('mouseenter', showTooltip);
            button.addEventListener('mouseleave', hideTooltip);
            
            // Tooltip hover events to keep it open when hovering over the tooltip
            tooltip.addEventListener('mouseenter', cancelHide);
            tooltip.addEventListener('mouseleave', hideTooltip);
            
            hideTooltip(); // Start hidden
        }
    }
    
        // Disable button ONLY if user has run out of requests (quota exhausted)
    var shouldDisable = licenseStatus && licenseStatus.remainingUses === 0;
    
    if (shouldDisable) {
        button.classList.add('disabled');
        button.disabled = true; // Also set attribute for accessibility
    } else {
        button.classList.remove('disabled');
        button.disabled = false;
    }
    
    // Clear ALL inline styles - let CSS handle everything
    button.style.cssText = '';
}

function removeTooltip(button) {
    if (!button) return;
    
    var container = button.parentElement;
    if (!container.classList.contains('button-container')) {
        return;
    }
    
    var tooltip = container.querySelector('.quota-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

function validateLicenseKeyFormat(licenseKey) {
    if (!licenseKey || typeof licenseKey !== 'string') {
        return false;
    }
    
    // Remove whitespace
    var cleanKey = licenseKey.trim();
    
    // Gumroad license keys format:
    // - 35 characters total (32 alphanumeric + 3 hyphens)
    // - Pattern: XXXXXXXX-XXXXXXXX-XXXXXXXX-XXXXXXXX (8-8-8-8 format)
    // - Example: 6F0E4C97-B72A4E69-A11BF6C4-AF6517E7
    var gumroadPattern = /^[A-F0-9]{8}-[A-F0-9]{8}-[A-F0-9]{8}-[A-F0-9]{8}$/i;
    
    return cleanKey.length === 35 && gumroadPattern.test(cleanKey);
}

function verifyLicenseWithGumroad(requestId, licenseKey, productId) {
    // Handle Gumroad API call in UI thread where fetch is available
    var params = new URLSearchParams();
    params.append('product_id', productId);
    params.append('license_key', licenseKey);
    params.append('increment_uses_count', 'true');

    fetch('https://api.gumroad.com/v2/licenses/verify', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString()
    })
    .then(function(response) {
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        parent.postMessage({
            pluginMessage: {
                type: 'license-verified',
                requestId: requestId,
                data: data
            }
        }, '*');
    })
    .catch(function(error) {
        parent.postMessage({
            pluginMessage: {
                type: 'license-verified',
                requestId: requestId,
                error: error.message
            }
        }, '*');
    });
}

function handleLicenseValidationResult(result) {
    var validateLicenseButton = document.getElementById('validate-license-button');
    var licenseKeyInput = document.getElementById('license-key-input');
    
    // Reset button state
    if (validateLicenseButton) {
        validateLicenseButton.textContent = 'Validate';
        // Only enable if input is valid
        if (licenseKeyInput) {
            validateLicenseButton.disabled = !validateLicenseKeyFormat(licenseKeyInput.value.trim());
        } else {
            validateLicenseButton.disabled = false;
        }
    }
    
    if (result.success) {
        hideLicenseError();
        showLicenseSuccess();
    } else {
        showLicenseError(result.message);
    }
}

function showTab(tabName) {
    var tabButtons = document.querySelectorAll('.tab-button');
    var tabContents = document.querySelectorAll('.tab-content');
    
    // Remove active class from all buttons and contents
    tabButtons.forEach(function(btn) { btn.classList.remove('active'); });
    tabContents.forEach(function(content) { content.classList.remove('active'); });
    
    // Add active class to target button and content
    var targetButton = document.querySelector('[data-tab="' + tabName + '"]');
    var targetContent = document.getElementById(tabName + '-tab');
    
    if (targetButton) targetButton.classList.add('active');
    if (targetContent) targetContent.classList.add('active');
}

// Tab system functionality
function initializeTabs() {
    var tabButtons = document.querySelectorAll('.tab-button');
    var tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(function(btn) { btn.classList.remove('active'); });
            tabContents.forEach(function(content) { content.classList.remove('active'); });
            
            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(targetTab + '-tab').classList.add('active');
            
            // Handle sync tab specific logic
            if (targetTab === 'sync') {
                if (!hasSyncedSheet) {
                    // Show sync selection screen if no sheet has been synced yet
                    parent.postMessage({ pluginMessage: { type: 'get-selection-state' } }, '*');
                }
            }
        });
    });
}

// Enhanced data type configurations with options
var dataTypes = {
    // For TEXT/MIXED layers
    numbers: [
        { id: 'custom', label: 'Custom', description: 'Custom numbers with range and formatting', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.05566 1.00281C8.32983 1.0335 8.52743 1.28131 8.49707 1.55554L8.22559 3.99988H10C10.2761 3.99988 10.4999 4.22381 10.5 4.49988C10.5 4.77602 10.2761 4.99988 10 4.99988H8.11426L7.89258 6.99988H10C10.2761 6.99988 10.4999 7.22381 10.5 7.49988C10.5 7.77602 10.2761 7.99988 10 7.99988H7.78125L7.49707 10.5555C7.46637 10.8298 7.21865 11.0274 6.94434 10.9969C6.67014 10.9662 6.47245 10.7185 6.50293 10.4442L6.77441 7.99988H4.78125L4.49707 10.5555C4.46637 10.8298 4.21865 11.0274 3.94434 10.9969C3.67014 10.9662 3.47245 10.7185 3.50293 10.4442L3.77441 7.99988H2C1.72386 7.99988 1.5 7.77602 1.5 7.49988C1.50009 7.22381 1.72391 6.99988 2 6.99988H3.88574L4.10742 4.99988H2C1.72386 4.99988 1.5 4.77602 1.5 4.49988C1.50009 4.22381 1.72391 3.99988 2 3.99988H4.21875L4.50293 1.44421C4.53373 1.17011 4.78145 0.972379 5.05566 1.00281C5.32983 1.0335 5.52743 1.28131 5.49707 1.55554L5.22559 3.99988H7.21875L7.50293 1.44421C7.53373 1.17011 7.78145 0.972379 8.05566 1.00281ZM5.11426 4.99988L4.89258 6.99988H6.88574L7.10742 4.99988H5.11426Z" /></svg>' },
        { id: 'percentage', label: 'Percentage', description: 'Random percentages (0-100%)', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.75 7C9.7165 7 10.5 7.7835 10.5 8.75C10.5 9.7165 9.7165 10.5 8.75 10.5C7.7835 10.5 7 9.7165 7 8.75C7 7.7835 7.7835 7 8.75 7ZM9.14648 2.14648C9.34175 1.95122 9.65825 1.95122 9.85352 2.14648C10.0487 2.34175 10.0488 2.65827 9.85352 2.85352L2.85352 9.85352C2.65827 10.0488 2.34175 10.0487 2.14648 9.85352C1.95122 9.65825 1.95122 9.34175 2.14648 9.14648L9.14648 2.14648ZM8.75 8C8.33579 8 8 8.33579 8 8.75C8 9.16421 8.33579 9.5 8.75 9.5C9.16421 9.5 9.5 9.16421 9.5 8.75C9.5 8.33579 9.16421 8 8.75 8ZM3.25 1.5C4.2165 1.5 5 2.2835 5 3.25C5 4.2165 4.2165 5 3.25 5C2.2835 5 1.5 4.2165 1.5 3.25C1.5 2.2835 2.2835 1.5 3.25 1.5ZM3.25 2.5C2.83579 2.5 2.5 2.83579 2.5 3.25C2.5 3.66421 2.83579 4 3.25 4C3.66421 4 4 3.66421 4 3.25C4 2.83579 3.66421 2.5 3.25 2.5Z" /></svg>' },
        { id: 'phone', label: 'Phone', description: 'Phone numbers with format options', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.5 0.5C9.32843 0.5 10 1.17157 10 2V10C10 10.8284 9.32843 11.5 8.5 11.5H3.5C2.67157 11.5 2 10.8284 2 10V2C2 1.17157 2.67157 0.5 3.5 0.5H8.5ZM3.5 1.5C3.22386 1.5 3 1.72386 3 2V10C3 10.2761 3.22386 10.5 3.5 10.5H8.5C8.77614 10.5 9 10.2761 9 10V2C9 1.72386 8.77614 1.5 8.5 1.5H3.5ZM6.00488 8.5C6.28103 8.5 6.50488 8.72386 6.50488 9C6.50488 9.27614 6.28103 9.5 6.00488 9.5H6C5.72386 9.5 5.5 9.27614 5.5 9C5.5 8.72386 5.72386 8.5 6 8.5H6.00488Z" /></svg>' },
        { id: 'date', label: 'Date', description: 'Dates with multiple format options', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 0.5C8.27614 0.5 8.5 0.723858 8.5 1V1.5H9.5C10.3284 1.5 11 2.17157 11 3V10C11 10.8284 10.3284 11.5 9.5 11.5H2.5C1.67157 11.5 1 10.8284 1 10V3C1 2.17157 1.67157 1.5 2.5 1.5H3.5V1C3.5 0.723858 3.72386 0.5 4 0.5C4.27614 0.5 4.5 0.723858 4.5 1V1.5H7.5V1C7.5 0.723858 7.72386 0.5 8 0.5ZM2 5.5V10C2 10.2761 2.22386 10.5 2.5 10.5H9.5C9.77614 10.5 10 10.2761 10 10V5.5H2ZM2.5 2.5C2.22386 2.5 2 2.72386 2 3V4.5H10V3C10 2.72386 9.77614 2.5 9.5 2.5H8.5V3C8.5 3.27614 8.27614 3.5 8 3.5C7.72386 3.5 7.5 3.27614 7.5 3V2.5H4.5V3C4.5 3.27614 4.27614 3.5 4 3.5C3.72386 3.5 3.5 3.27614 3.5 3V2.5H2.5Z" /></svg>' },
        { id: 'finances', label: 'Finances', description: 'Financial data (cards, accounts, etc.)', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_762_3800)"><path d="M6 0.5C9.03757 0.5 11.5 2.96243 11.5 6C11.5 9.03757 9.03757 11.5 6 11.5C2.96243 11.5 0.5 9.03757 0.5 6C0.5 2.96243 2.96243 0.5 6 0.5ZM6 1.5C3.51472 1.5 1.5 3.51472 1.5 6C1.5 8.48528 3.51472 10.5 6 10.5C8.48528 10.5 10.5 8.48528 10.5 6C10.5 3.51472 8.48528 1.5 6 1.5ZM6 2.5C6.27614 2.5 6.5 2.72386 6.5 3V3.5H8C8.27614 3.5 8.5 3.72386 8.5 4C8.5 4.27614 8.27614 4.5 8 4.5H6.5V5.5H7C7.39783 5.5 7.77924 5.65815 8.06055 5.93945C8.34185 6.22076 8.5 6.60217 8.5 7C8.5 7.39783 8.34185 7.77924 8.06055 8.06055C7.77924 8.34185 7.39783 8.5 7 8.5H6.5V9C6.5 9.27614 6.27614 9.5 6 9.5C5.72386 9.5 5.5 9.27614 5.5 9V8.5H4C3.72386 8.5 3.5 8.27614 3.5 8C3.5 7.72386 3.72386 7.5 4 7.5H5.5V6.5H5C4.60217 6.5 4.22076 6.34185 3.93945 6.06055C3.69337 5.81446 3.54195 5.49174 3.50781 5.14844L3.5 5C3.5 4.60217 3.65815 4.22076 3.93945 3.93945C4.22076 3.65815 4.60217 3.5 5 3.5H5.5V3C5.5 2.72386 5.72386 2.5 6 2.5ZM6.5 7.5H7C7.13261 7.5 7.25975 7.44728 7.35352 7.35352C7.44728 7.25975 7.5 7.13261 7.5 7C7.5 6.86739 7.44728 6.74025 7.35352 6.64648C7.25975 6.55272 7.13261 6.5 7 6.5H6.5V7.5ZM5 4.5C4.86739 4.5 4.74025 4.55272 4.64648 4.64648C4.55272 4.74025 4.5 4.86739 4.5 5L4.50977 5.09766C4.52894 5.19389 4.57608 5.28311 4.64648 5.35352C4.74025 5.44728 4.86739 5.5 5 5.5H5.5V4.5H5Z" /></g><defs><clipPath id="clip0_762_3800"><rect width="12" height="12" /></clipPath></defs></svg>' }
    ],
    text: [
        { id: 'person', label: 'Person', description: 'Names, usernames, job titles, etc.', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 10.5V9.5C9 9.10218 8.84185 8.72076 8.56055 8.43945C8.27924 8.15815 7.89782 8 7.5 8H4.5C4.10218 8 3.72076 8.15815 3.43945 8.43945C3.15815 8.72076 3 9.10218 3 9.5V10.5C3 10.7761 2.77614 11 2.5 11C2.22386 11 2 10.7761 2 10.5V9.5C2 8.83696 2.26358 8.20126 2.73242 7.73242C3.20126 7.26358 3.83696 7 4.5 7H7.5C8.16304 7 8.79874 7.26358 9.26758 7.73242C9.73642 8.20126 10 8.83696 10 9.5V10.5C10 10.7761 9.77614 11 9.5 11C9.22386 11 9 10.7761 9 10.5Z" /><path d="M7.5 3.5C7.5 2.67157 6.82843 2 6 2C5.17157 2 4.5 2.67157 4.5 3.5C4.5 4.32843 5.17157 5 6 5C6.82843 5 7.5 4.32843 7.5 3.5ZM8.5 3.5C8.5 4.88071 7.38071 6 6 6C4.61929 6 3.5 4.88071 3.5 3.5C3.5 2.11929 4.61929 1 6 1C7.38071 1 8.5 2.11929 8.5 3.5Z" /></svg>' },
        { id: 'email', label: 'Email', description: 'Email addresses with provider options', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_756_2526)"><path d="M7.5 6C7.5 5.17157 6.82843 4.5 6 4.5C5.17157 4.5 4.5 5.17157 4.5 6C4.5 6.82843 5.17157 7.5 6 7.5C6.82843 7.5 7.5 6.82843 7.5 6ZM8.5 6C8.5 7.38071 7.38071 8.5 6 8.5C4.61929 8.5 3.5 7.38071 3.5 6C3.5 4.61929 4.61929 3.5 6 3.5C7.38071 3.5 8.5 4.61929 8.5 6Z" /><path d="M7.49994 6.49997V3.99997C7.49994 3.72383 7.7238 3.49997 7.99994 3.49997C8.27608 3.49997 8.49994 3.72383 8.49994 3.99997V6.49997C8.49994 6.76518 8.60538 7.01946 8.79291 7.207C8.98045 7.39453 9.23473 7.49997 9.49994 7.49997C9.76516 7.49997 10.0194 7.39454 10.207 7.207C10.3945 7.01946 10.4999 6.76518 10.4999 6.49997V5.99997C10.4999 4.98626 10.1574 4.00189 9.52826 3.207C8.89923 2.41236 8.02048 1.85298 7.03412 1.62009C6.04756 1.38719 5.01085 1.4942 4.09271 1.9238C3.17455 2.35343 2.4279 3.08058 1.97455 3.98727C1.5212 4.89396 1.38748 5.92758 1.59467 6.91989C1.80186 7.91209 2.33799 8.80555 3.11615 9.45505C3.89436 10.1045 4.86949 10.4716 5.88275 10.498C6.89612 10.5244 7.88917 10.2078 8.70014 9.59958C8.92103 9.43417 9.23472 9.47935 9.40033 9.70016C9.56575 9.92106 9.52056 10.2347 9.29975 10.4004C8.3087 11.1435 7.09569 11.5301 5.85736 11.498C4.6188 11.4658 3.42676 11.0165 2.47553 10.2226C1.52439 9.42876 0.86937 8.33675 0.616152 7.12399C0.362946 5.91119 0.52692 4.64816 1.081 3.54001C1.63509 2.43204 2.54685 1.54358 3.66889 1.01852C4.79109 0.493413 6.05777 0.362769 7.26361 0.647429C8.46939 0.932096 9.54357 1.61541 10.3124 2.58688C11.0813 3.55842 11.4999 4.76099 11.4999 5.99997V6.49997C11.4999 7.0304 11.2891 7.53896 10.914 7.91403C10.5389 8.2891 10.0304 8.49997 9.49994 8.49997C8.96951 8.49997 8.46095 8.2891 8.08588 7.91403C7.71081 7.53896 7.49994 7.0304 7.49994 6.49997Z" /></g><defs><clipPath id="clip0_756_2526"><rect width="12" height="12" /></clipPath></defs></svg>' },
        { id: 'website', label: 'Website', description: 'Website URLs with domain options', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.5 3C4.77614 3 5 3.22386 5 3.5C5 3.77614 4.77614 4 4.5 4H3.5C2.96957 4 2.46101 4.21086 2.08594 4.58594C1.71086 4.96101 1.5 5.46957 1.5 6C1.5 6.53043 1.71086 7.03899 2.08594 7.41406C2.46101 7.78914 2.96957 8 3.5 8H4.5C4.77614 8 5 8.22386 5 8.5C5 8.77614 4.77614 9 4.5 9H3.5C2.70435 9 1.94152 8.6837 1.37891 8.12109C0.816297 7.55848 0.5 6.79565 0.5 6C0.5 5.20435 0.816297 4.44152 1.37891 3.87891C1.94152 3.3163 2.70435 3 3.5 3H4.5ZM8.5 3C9.29565 3 10.0585 3.3163 10.6211 3.87891C11.1837 4.44152 11.5 5.20435 11.5 6C11.5 6.79565 11.1837 7.55848 10.6211 8.12109C10.0585 8.6837 9.29565 9 8.5 9H7.5C7.22386 9 7 8.77614 7 8.5C7 8.22386 7.22386 8 7.5 8H8.5C9.03043 8 9.53899 7.78914 9.91406 7.41406C10.2891 7.03899 10.5 6.53043 10.5 6C10.5 5.46957 10.2891 4.96101 9.91406 4.58594C9.53899 4.21086 9.03043 4 8.5 4H7.5C7.22386 4 7 3.77614 7 3.5C7 3.22386 7.22386 3 7.5 3H8.5ZM8 5.5C8.27614 5.5 8.5 5.72386 8.5 6C8.5 6.27614 8.27614 6.5 8 6.5H4C3.72386 6.5 3.5 6.27614 3.5 6C3.5 5.72386 3.72386 5.5 4 5.5H8Z" /></svg>' },
        { id: 'location', label: 'Location', description: 'Cities, addresses, coordinates, etc.', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 0.5C7.19347 0.5 8.33773 0.974446 9.18164 1.81836C10.0256 2.66227 10.5 3.80653 10.5 5C10.5 6.41684 9.7232 7.80148 8.89648 8.8877C8.05822 9.98902 7.10451 10.866 6.62695 11.2783C6.61855 11.2856 6.60945 11.2922 6.60059 11.2988C6.47067 11.3965 6.31997 11.4614 6.16113 11.4873L6 11.5C5.78325 11.5 5.57267 11.4291 5.39941 11.2988C5.39055 11.2922 5.38145 11.2856 5.37305 11.2783C4.89549 10.866 3.94178 9.98902 3.10352 8.8877C2.2768 7.80148 1.5 6.41684 1.5 5C1.5 3.80653 1.97445 2.66227 2.81836 1.81836C3.66227 0.974446 4.80653 0.5 6 0.5ZM6 1.5C5.07174 1.5 4.18177 1.86901 3.52539 2.52539C2.86901 3.18177 2.5 4.07174 2.5 5C2.5 6.07964 3.10793 7.24358 3.89844 8.28223C4.66224 9.28577 5.53968 10.0976 6 10.4971C6.46032 10.0976 7.33776 9.28577 8.10156 8.28223C8.89207 7.24358 9.5 6.07964 9.5 5C9.5 4.07174 9.13099 3.18177 8.47461 2.52539C7.85932 1.9101 7.0388 1.54688 6.17383 1.50391L6 1.5ZM6 3C7.10457 3 8 3.89543 8 5C8 6.10457 7.10457 7 6 7C4.89543 7 4 6.10457 4 5C4 3.89543 4.89543 3 6 3ZM6 4C5.44772 4 5 4.44772 5 5C5 5.55228 5.44772 6 6 6C6.55228 6 7 5.55228 7 5C7 4.44772 6.55228 4 6 4Z" /></svg>' },
        { id: 'title', label: 'Title', description: 'Post titles, company names, products, etc.', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 1.5C9.76522 1.5 10.0195 1.60543 10.207 1.79297C10.3946 1.98051 10.5 2.23478 10.5 2.5V3.5C10.5 3.77614 10.2761 4 10 4C9.72386 4 9.5 3.77614 9.5 3.5V2.5H6.5V9.5H7.5C7.77614 9.5 8 9.72386 8 10C8 10.2761 7.77614 10.5 7.5 10.5H4.5C4.22386 10.5 4 10.2761 4 10C4 9.72386 4.22386 9.5 4.5 9.5H5.5V2.5H2.5V3.5C2.5 3.77614 2.27614 4 2 4C1.72386 4 1.5 3.77614 1.5 3.5V2.5C1.5 2.23478 1.60543 1.9805 1.79297 1.79297C1.9805 1.60543 2.23478 1.5 2.5 1.5H9.5Z" /></svg>' },
        { id: 'long_text', label: 'Long text', description: 'Paragraphs by category', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 8.5C7.77614 8.5 8 8.72386 8 9C8 9.27614 7.77614 9.5 7.5 9.5H1.5C1.22386 9.5 1 9.27614 1 9C1 8.72386 1.22386 8.5 1.5 8.5H7.5ZM10.5 5.5C10.7761 5.5 11 5.72386 11 6C11 6.27614 10.7761 6.5 10.5 6.5H1.5C1.22386 6.5 1 6.27614 1 6C1 5.72386 1.22386 5.5 1.5 5.5H10.5ZM8.5 2.5C8.77614 2.5 9 2.72386 9 3C9 3.27614 8.77614 3.5 8.5 3.5H1.5C1.22386 3.5 1 3.27614 1 3C1 2.72386 1.22386 2.5 1.5 2.5H8.5Z" /></svg>' }
    ],
         // For OTHER layers
     media: [
         { id: 'avatar', label: 'Avatar', description: 'Profile pictures and avatars', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_750_932)"><path d="M6 0.5C9.03757 0.5 11.5 2.96243 11.5 6C11.5 8.02282 10.4069 9.78879 8.78027 10.7441C8.77533 10.7475 8.76971 10.7497 8.76465 10.7529C7.9521 11.2266 7.00834 11.5 6 11.5C4.99136 11.5 4.04709 11.2269 3.23438 10.7529C3.22932 10.7497 3.22368 10.7475 3.21875 10.7441C1.59249 9.78869 0.5 8.02252 0.5 6C0.5 2.96243 2.96243 0.5 6 0.5ZM4.5 9C4.36739 9 4.24025 9.05272 4.14648 9.14648C4.05272 9.24025 4 9.36739 4 9.5V10.0312C4.60258 10.3308 5.28142 10.5 6 10.5C6.71858 10.5 7.39742 10.3308 8 10.0312V9.5C8 9.36739 7.94728 9.24025 7.85352 9.14648C7.75975 9.05272 7.63261 9 7.5 9H4.5ZM6 1.5C3.51472 1.5 1.5 3.51472 1.5 6C1.5 7.33583 2.0825 8.53522 3.00684 9.35938C3.03945 9.01317 3.1915 8.68741 3.43945 8.43945C3.72076 8.15815 4.10218 8 4.5 8H7.5C7.89783 8 8.27924 8.15815 8.56055 8.43945C8.80848 8.68739 8.95955 9.01321 8.99219 9.35938C9.91684 8.53521 10.5 7.33609 10.5 6C10.5 3.51472 8.48528 1.5 6 1.5ZM6 3C7.10457 3 8 3.89543 8 5C8 6.10457 7.10457 7 6 7C4.89543 7 4 6.10457 4 5C4 3.89543 4.89543 3 6 3ZM6 4C5.44772 4 5 4.44772 5 5C5 5.55228 5.44772 6 6 6C6.55228 6 7 5.55228 7 5C7 4.44772 6.55228 4 6 4Z" /></g><defs><clipPath id="clip0_750_932"><rect width="12" height="12" /></clipPath></defs></svg>' },
         { id: 'image', label: 'Image', description: 'Images by category', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 1C10.3284 1 11 1.67157 11 2.5V9.5C11 10.3284 10.3284 11 9.5 11H2.5C1.67157 11 1 10.3284 1 9.5V2.5C1 1.67157 1.67157 1 2.5 1H9.5ZM8.25 6.16406C8.11745 6.16407 7.99023 6.21685 7.89648 6.31055L4.20703 10H9.5C9.77614 10 10 9.77614 10 9.5V7.70703L8.60352 6.31055C8.50976 6.21686 8.38254 6.16406 8.25 6.16406ZM2.5 2C2.22386 2 2 2.22386 2 2.5V9.5C2 9.77614 2.22386 10 2.5 10H2.79297L7.18945 5.60352L7.2998 5.50391C7.56668 5.28533 7.90202 5.16407 8.25 5.16406C8.64771 5.16406 9.02926 5.32236 9.31055 5.60352L10 6.29297V2.5C10 2.22386 9.77614 2 9.5 2H2.5ZM4.5 3C5.32843 3 6 3.67157 6 4.5C6 5.32843 5.32843 6 4.5 6C3.67157 6 3 5.32843 3 4.5C3 3.67157 3.67157 3 4.5 3ZM4.5 4C4.22386 4 4 4.22386 4 4.5C4 4.77614 4.22386 5 4.5 5C4.77614 5 5 4.77614 5 4.5C5 4.22386 4.77614 4 4.5 4Z" /></svg>' },
         { id: 'color', label: 'Color', description: 'Solid colors or gradients', hasOptions: true, icon: '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_750_1036)"><path d="M4.5 0.5C6.40013 0.5 7.98964 1.82517 8.39746 3.60156C10.1744 4.00896 11.5 5.59946 11.5 7.5C11.5 9.70914 9.70914 11.5 7.5 11.5C5.59946 11.5 4.00896 10.1744 3.60156 8.39746C1.82517 7.98964 0.5 6.40013 0.5 4.5C0.5 2.29086 2.29086 0.5 4.5 0.5ZM8.49512 4.67188C8.40748 6.74425 6.74425 8.40748 4.67188 8.49512C5.08259 9.66239 6.1923 10.5 7.5 10.5C9.15685 10.5 10.5 9.15685 10.5 7.5C10.5 6.1923 9.66239 5.08259 8.49512 4.67188ZM7.5 4.5C5.84315 4.5 4.5 5.84315 4.5 7.5C6.15685 7.5 7.5 6.15685 7.5 4.5ZM4.5 1.5C2.84315 1.5 1.5 2.84315 1.5 4.5C1.5 5.80727 2.33725 6.9161 3.50391 7.32715C3.59199 5.25552 5.25552 3.59199 7.32715 3.50391C6.9161 2.33725 5.80727 1.5 4.5 1.5Z" /></g><defs><clipPath id="clip0_750_1036"><rect width="12" height="12" /></clipPath></defs></svg>' }
     ]
};

// Event listeners
// Shared scan functionality
function performScan() {
    parent.postMessage({ pluginMessage: { type: 'scan-layers' } }, '*');
}

scanButton.addEventListener('click', function() {
    setLoadingState(scanButton, scanText, scanLoading, true);
    performScan();
});

selectionScanButton.addEventListener('click', function() {
    hideSelectionScreen();
    setLoadingState(scanButton, scanText, scanLoading, true);
    performScan();
});

// Sync tab event listeners
if (syncUrlInput) {
    syncUrlInput.addEventListener('input', function() {
        // Update button state when URL input changes (includes validation)
        parent.postMessage({ pluginMessage: { type: 'get-selection-state' } }, '*');
    });
}

if (syncSelectionScanButton) {
    syncSelectionScanButton.addEventListener('click', function() {
        var sheetUrl = syncUrlInput.value.trim();
        var validation = validateGoogleSheetsUrl(sheetUrl);
        
        if (!validation.isValid) {
            if (validation.error) {
                showSyncUrlError(validation.error);
            } else {
                showSyncUrlError('Please enter a Google Sheets URL');
            }
            return;
        }
        
        // Copy URL to main sync input and trigger sync
        var mainSheetUrlInput = document.getElementById('sheet-url-input');
        if (mainSheetUrlInput) {
            mainSheetUrlInput.value = sheetUrl;
        }
        
        // Hide sync selection screen and trigger sync
        hideSyncSelectionScreen();
        setLoadingState(syncSheetButton, syncText, syncLoading, true);
        
        parent.postMessage({
            pluginMessage: {
                type: 'sync-google-sheet',
                data: { sheetUrl: sheetUrl }
            }
        }, '*');
    });
}

applyButton.addEventListener('click', function() {
    if (currentMappings.length === 0) {
        showStatusMessage('No mappings to apply', 'error');
        return;
    }
    
    // Reset batch tracking for new operation
    resetBatchTracking();
    
    // Debug: Log current mappings before saving configurations
    console.log('🔍 DEBUG: Current mappings before saving configs:', currentMappings);
    
        // First, save detailed configurations for all mappings SEQUENTIALLY to avoid race conditions
    async function saveDetailedConfigsSequentially() {
        for (var i = 0; i < currentMappings.length; i++) {
            var mapping = currentMappings[i];
            if (mapping.dataTypeId) {
                var config = getConfigForLayer(mapping.dataTypeId, mapping.layerName);
                console.log('💾 Saving detailed config for:', mapping.layerName, 'dataType:', mapping.dataTypeId, 'config:', config);
                
                // Debug: Check if this is an avatar and what config was captured
                if (mapping.dataTypeId === 'avatar') {
                    var cleanLayerName = mapping.layerName.replace(/[^a-zA-Z0-9]/g, '');
                    var avatarTypeInput = document.getElementById('avatarType-' + cleanLayerName);
                    console.log('🔍 AVATAR DEBUG - Element found:', !!avatarTypeInput, 'Value:', avatarTypeInput ? avatarTypeInput.value : 'N/A');
                }
                
                console.log('📤 Sending save-detailed-config message to backend...');
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-detailed-config',
                        layerName: mapping.layerName,
                        dataTypeId: mapping.dataTypeId,
                        config: config
                    }
                }, '*');
                console.log('✅ save-detailed-config message sent');
                
                // Add delay between saves to prevent race conditions
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
    }
    
    // Then collect mappings with selected data types for application
    var mappingsToApply = [];
    for (var i = 0; i < currentMappings.length; i++) {
        var mapping = currentMappings[i];
        if (mapping.dataTypeId) {
            mappingsToApply.push({
                layerName: mapping.layerName,
                dataTypeId: mapping.dataTypeId
            });
        }
    }

    if (mappingsToApply.length === 0) {
        showStatusMessage('Please select data types for at least one mapping', 'error');
        return;
    }

    // Calculate total individual layers for progress tracking
    var totalLayers = 0;
    for (var i = 0; i < currentMappings.length; i++) {
        var mapping = currentMappings[i];
        if (mapping.dataTypeId) {
            totalLayers += mapping.count; // mapping.count is the number of individual layers
        }
    }

    // Show progress screen immediately
    showProgressScreen(totalLayers);
    setLoadingState(applyButton, applyText, applyLoading, true);

    // Execute sequential saving, then apply
    saveDetailedConfigsSequentially().then(function() {
        console.log('🏁 All detailed configs saved, proceeding with apply...');
        parent.postMessage({ 
            pluginMessage: { 
                type: 'apply-data', 
                mappings: mappingsToApply 
            } 
        }, '*');
    });
});

// Utility functions
function setLoadingState(button, textElement, loadingElement, isLoading) {
    if (isLoading) {
        textElement.style.display = 'none';
        loadingElement.style.display = 'block';
        button.disabled = true;
    } else {
        textElement.style.display = 'block';
        loadingElement.style.display = 'none';
        button.disabled = false;
    }
}

function showStatusMessage(message, type) {
    if (!statusContainer) {
        console.log('📢 Status message:', message, '(type:', type + ')');
        return;
    }
    
    var messageDiv = document.createElement('div');
    messageDiv.className = 'status-message status-' + (type || 'success');
    messageDiv.textContent = message;
    
    statusContainer.innerHTML = '';
    statusContainer.appendChild(messageDiv);
    
    setTimeout(function() {
        if (statusContainer && statusContainer.contains(messageDiv)) {
            statusContainer.removeChild(messageDiv);
        }
    }, 5000);
}

// Progress screen functions
function showProgressScreen(totalLayers) {
    mainContainer.style.display = 'none';
    progressScreen.classList.add('active');
    applySection.classList.add('hidden'); // Hide apply section when progress screen is shown
    updateProgress(0, totalLayers);
}

function hideProgressScreen() {
    progressScreen.classList.remove('active');
    mainContainer.style.display = 'block';
    applySection.classList.remove('hidden'); // Show apply section when progress screen is hidden
    resetProgress();
}

function updateProgress(completed, total) {
    var percentage = Math.round((completed / total) * 100);
    progressBar.style.width = percentage + '%';
    progressStatus.textContent = 'Applying data to ' + completed + '/' + total + ' layers';
}

function resetProgress() {
    progressBar.style.width = '0%';
    progressStatus.textContent = 'Preparing...';
}

// Selection screen functions
function showSelectionScreen(hasSelection) {
    mainContainer.style.display = 'none';
    selectionScreen.classList.add('active');
    applySection.classList.add('hidden'); // Hide apply section when selection screen is shown
    updateSelectionButtonState(hasSelection);
}

function hideSelectionScreen() {
    selectionScreen.classList.remove('active');
    mainContainer.style.display = 'block';
    applySection.classList.remove('hidden'); // Show apply section when selection screen is hidden
}

function updateSelectionButtonState(hasSelection) {
    if (hasSelection) {
        selectionScanButton.style.display = 'block';
        selectionScanButton.disabled = false;
        selectionNotice.style.display = 'none';
    } else {
        selectionScanButton.style.display = 'none';
        selectionNotice.style.display = 'block';
    }
}

// Sync tab selection screen functions
function showSyncSelectionScreen(hasSelection) {
    if (syncMainContainer) syncMainContainer.style.display = 'none';
    if (syncSelectionScreen) syncSelectionScreen.classList.add('active');
    if (syncApplySection) syncApplySection.style.display = 'none';
    updateSyncSelectionButtonState(hasSelection);
}

function hideSyncSelectionScreen() {
    if (syncSelectionScreen) syncSelectionScreen.classList.remove('active');
    if (syncMainContainer) syncMainContainer.style.display = 'block';
}

function updateSyncSelectionButtonState(hasSelection) {
    var urlValue = syncUrlInput ? syncUrlInput.value.trim() : '';
    var validation = validateGoogleSheetsUrl(urlValue);
    var hasValidUrl = validation.isValid;
    var shouldEnable = hasSelection && hasValidUrl;
    
    // Show URL validation error if there's an error message
    if (validation.error) {
        showSyncUrlError(validation.error);
    } else {
        hideSyncUrlError();
    }
    
    if (syncSelectionScanButton) {
        // Show button only if there's a valid URL and a layer is selected
        if (shouldEnable) {
            syncSelectionScanButton.style.display = 'block';
            syncSelectionScanButton.disabled = false;
        } else {
            syncSelectionScanButton.style.display = 'none';
        }
    }
    
    if (syncSelectionNotice) {
        // Show notice only if button is visible but no layers are selected
        if (hasValidUrl && !hasSelection) {
            syncSelectionNotice.style.display = 'block';
        } else {
            syncSelectionNotice.style.display = 'none';
        }
    }
}

function showSyncUrlError(message) {
    if (syncUrlError) {
        syncUrlError.textContent = message;
        syncUrlError.style.display = 'block';
    }
}

function hideSyncUrlError() {
    if (syncUrlError) {
        syncUrlError.style.display = 'none';
    }
}

function validateGoogleSheetsUrl(url) {
    if (!url || url.trim().length === 0) {
        return { isValid: false, error: '' }; // Empty URL, no error message needed
    }
    
    // Check if it's a Google Sheets URL pattern
    var sheetsUrlPattern = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
    
    if (!sheetsUrlPattern.test(url)) {
        return { 
            isValid: false, 
            error: 'Invalid Google Sheets URL.' 
        };
    }
    
    return { isValid: true, error: '' };
}

// Get available categories based on layer type
function getAvailableCategoriesForLayerType(layerType) {
    switch (layerType) {
        case 'TEXT':
            return ['numbers', 'text']; // Text layers get numbers and text options
        case 'OTHER':
            return ['media']; // Non-text layers get media options
        case 'MIXED':
            return ['numbers', 'text', 'media']; // Mixed layers get all options
        default:
            return ['numbers', 'text']; // Default fallback for text layers
    }
}

// Generate dropdown content based on available categories
function generateDropdownContent(availableCategories, layerName) {
    var html = '';
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    // Check if we need two columns (TEXT layers) or one column (OTHER layers)
    var needsTwoColumns = availableCategories.includes('numbers') && availableCategories.includes('text');
    
    if (needsTwoColumns) {
        html += '<div class="dropdown-columns">';
        
        // Left column - NUMBERS
        if (availableCategories.includes('numbers')) {
            html += '<div class="dropdown-column">';
            html += '<div class="dropdown-column-title">Numbers</div>';
            var numbersTypes = dataTypes.numbers;
            for (var i = 0; i < numbersTypes.length; i++) {
                var type = numbersTypes[i];
                html += '<div class="dropdown-option" data-layer-name="' + layerName + '" data-type="' + type.id + '">';
                html += '<span style="display: flex; align-items: center; gap: 8px;">';
                html += type.icon;
                html += '<span>' + type.label + '</span>';
                html += '</span>';
                html += '<span class="option-checkmark"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.64645 2.64645C9.84171 2.45118 10.1582 2.45118 10.3535 2.64645C10.5487 2.84171 10.5487 3.15822 10.3535 3.35348L4.85348 8.85348C4.65822 9.04874 4.34171 9.04874 4.14645 8.85348L1.64645 6.35348C1.45118 6.15822 1.45118 5.84171 1.64645 5.64645C1.81731 5.47558 2.08127 5.45383 2.27535 5.58199L2.35348 5.64645L4.49996 7.79293L9.64645 2.64645Z" /></svg></span>';
                html += '</div>';
            }
            html += '</div>';
        }
        
        // Right column - TEXT
        if (availableCategories.includes('text')) {
            html += '<div class="dropdown-column">';
            html += '<div class="dropdown-column-title">Text</div>';
            var textTypes = dataTypes.text;
            for (var i = 0; i < textTypes.length; i++) {
                var type = textTypes[i];
                html += '<div class="dropdown-option" data-layer-name="' + layerName + '" data-type="' + type.id + '">';
                html += '<span style="display: flex; align-items: center; gap: 8px;">';
                html += type.icon;
                html += '<span>' + type.label + '</span>';
                html += '</span>';
                html += '<span class="option-checkmark"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.64645 2.64645C9.84171 2.45118 10.1582 2.45118 10.3535 2.64645C10.5487 2.84171 10.5487 3.15822 10.3535 3.35348L4.85348 8.85348C4.65822 9.04874 4.34171 9.04874 4.14645 8.85348L1.64645 6.35348C1.45118 6.15822 1.45118 5.84171 1.64645 5.64645C1.81731 5.47558 2.08127 5.45383 2.27535 5.58199L2.35348 5.64645L4.49996 7.79293L9.64645 2.64645Z" /></svg></span>';
                html += '</div>';
            }
            html += '</div>';
        }
        
        html += '</div>';
    } else {
        // Single column layout for OTHER layers
        if (availableCategories.includes('media')) {
            html += '<div class="dropdown-column-title">Media</div>';
            var mediaTypes = dataTypes.media;
            for (var i = 0; i < mediaTypes.length; i++) {
                var type = mediaTypes[i];
                html += '<div class="dropdown-option" data-layer-name="' + layerName + '" data-type="' + type.id + '">';
                html += '<span style="display: flex; align-items: center; gap: 8px;">';
                html += type.icon;
                html += '<span>' + type.label + '</span>';
                html += '</span>';
                html += '<span class="option-checkmark"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.64645 2.64645C9.84171 2.45118 10.1582 2.45118 10.3535 2.64645C10.5487 2.84171 10.5487 3.15822 10.3535 3.35348L4.85348 8.85348C4.65822 9.04874 4.34171 9.04874 4.14645 8.85348L1.64645 6.35348C1.45118 6.15822 1.45118 5.84171 1.64645 5.64645C1.81731 5.47558 2.08127 5.45383 2.27535 5.58199L2.35348 5.64645L4.49996 7.79293L9.64645 2.64645Z" /></svg></span>';
                html += '</div>';
            }
        }
    }
    
    return html;
}

// Toggle dropdown open/closed
function toggleDropdown(layerName) {
    console.log('🔄 Toggle dropdown for layer:', layerName);
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var dropdown = document.getElementById('dropdown-' + cleanLayerName);
    var panel = document.getElementById('panel-' + cleanLayerName);
    
    if (!dropdown || !panel) {
        console.error('❌ Dropdown elements not found for layer:', layerName);
        return;
    }
    
    var button = dropdown.querySelector('.dropdown-button');
    
    // Find the layer type to determine panel width
    var layerType = null;
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            layerType = currentMappings[i].layerType;
            break;
        }
    }
    
    // Apply appropriate width class based on layer type
    if (layerType) {
        var availableCategories = getAvailableCategoriesForLayerType(layerType);
        var needsTwoColumns = availableCategories.includes('numbers') && availableCategories.includes('text');
        
        // Remove existing width classes
        panel.classList.remove('two-column', 'single-column');
        
        // Add appropriate width class
        if (needsTwoColumns) {
            panel.classList.add('two-column');
        } else {
            panel.classList.add('single-column');
        }
    }
    
    // Close all other dropdowns first
    var allDropdowns = document.querySelectorAll('.dropdown-panel');
    var allButtons = document.querySelectorAll('.dropdown-button');
    
    for (var i = 0; i < allDropdowns.length; i++) {
        if (allDropdowns[i] !== panel) {
            allDropdowns[i].classList.remove('open');
        }
    }
    
    for (var i = 0; i < allButtons.length; i++) {
        if (allButtons[i] !== button) {
            allButtons[i].classList.remove('open');
        }
    }
    
    // Toggle this dropdown
    var isOpen = panel.classList.contains('open');
    console.log('📍 Dropdown was open:', isOpen, '- toggling to:', !isOpen);
    
    panel.classList.toggle('open');
    button.classList.toggle('open');
}

// Deselect a data type (reset to unselected state)
function deselectDataType(layerName) {
    console.log('🗑️ Deselecting data type for layer:', layerName);
    
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var dropdown = document.getElementById('dropdown-' + cleanLayerName);
    var panel = document.getElementById('panel-' + cleanLayerName);
    var configPanel = document.getElementById('config-panel-' + cleanLayerName);
    
    if (!dropdown || !panel) {
        console.error('❌ Dropdown elements not found for deselection:', layerName);
        return;
    }
    
    var button = dropdown.querySelector('.dropdown-button');
    var dropdownText = button.querySelector('.dropdown-text');
    
    // Reset button text
    dropdownText.innerHTML = 'Select...';
    
    // Remove selected state from all dropdown options
    var options = panel.querySelectorAll('.dropdown-option');
    for (var i = 0; i < options.length; i++) {
        options[i].classList.remove('selected');
    }
    
    // Close dropdown
    panel.classList.remove('open');
    button.classList.remove('open');
    
    // Hide configuration panel
    if (configPanel) {
        configPanel.style.display = 'none';
    }
    
    // Clear data type from mapping
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            delete currentMappings[i].dataTypeId;
            break;
        }
    }
    
    // Remove saved configuration to persist deselection intent
    parent.postMessage({ 
        pluginMessage: { 
            type: 'remove-configuration', 
            layerName: layerName 
        } 
    }, '*');
    
    // Show remove button since no data type is selected
    showRemoveButton(layerName);
    
    console.log('✅ Data type deselected for layer:', layerName);
}

// Hide remove button and show toggle button for a specific mapping
function hideRemoveButton(layerName) {
    var mappingItems = document.querySelectorAll('.mapping-item');
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            var removeBtn = item.querySelector('.remove-btn');
            var toggleBtn = item.querySelector('.config-toggle');
            if (removeBtn) {
                removeBtn.style.display = 'none';
            }
            if (toggleBtn) {
                toggleBtn.style.display = 'flex';
            }
            break;
        }
    }
}

// Show remove button and hide toggle button for a specific mapping
function showRemoveButton(layerName) {
    var mappingItems = document.querySelectorAll('.mapping-item');
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            var removeBtn = item.querySelector('.remove-btn');
            var toggleBtn = item.querySelector('.config-toggle');
            if (removeBtn) {
                removeBtn.style.display = 'flex';
            }
            if (toggleBtn) {
                toggleBtn.style.display = 'none';
            }
            break;
        }
    }
}

// Toggle configuration panel visibility
function toggleConfigPanel(layerName) {
    console.log('🔄 Toggling config panel for layer:', layerName);
    
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var configPanel = document.getElementById('config-panel-' + cleanLayerName);
    
    // Find the toggle button in the mapping header
    var mappingItems = document.querySelectorAll('.mapping-item');
    var toggleButton = null;
    
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            toggleButton = item.querySelector('.config-toggle');
            break;
        }
    }
    
    if (!configPanel || !toggleButton) {
        console.error('❌ Config panel elements not found for layer:', layerName);
        return;
    }
    
    var isHidden = configPanel.style.display === 'none';
    
    if (isHidden) {
        // Show the panel
        configPanel.style.display = 'block';
        toggleButton.classList.add('open');
        console.log('✅ Showed config panel for layer:', layerName);
    } else {
        // Hide the panel
        configPanel.style.display = 'none';
        toggleButton.classList.remove('open');
        console.log('✅ Hidden config panel for layer:', layerName);
    }
}

// Select a data type from dropdown
function selectDataType(layerName, dataTypeId) {
    console.log('🎯 Select data type:', dataTypeId, 'for layer:', layerName);
    
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var dropdown = document.getElementById('dropdown-' + cleanLayerName);
    var panel = document.getElementById('panel-' + cleanLayerName);
    
    if (!dropdown || !panel) {
        console.error('❌ Dropdown elements not found for selection:', layerName);
        return;
    }
    
    var button = dropdown.querySelector('.dropdown-button');
    var dropdownText = button.querySelector('.dropdown-text');
    
    // Check if this data type is already selected (for deselection)
    var currentMapping = null;
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            currentMapping = currentMappings[i];
            break;
        }
    }
    
    if (currentMapping && currentMapping.dataTypeId === dataTypeId) {
        // Deselect the data type
        console.log('🔄 Deselecting data type:', dataTypeId, 'for layer:', layerName);
        deselectDataType(layerName);
        return;
    }
    
    // Find the selected data type info
    var selectedType = null;
    for (var category in dataTypes) {
        for (var i = 0; i < dataTypes[category].length; i++) {
            if (dataTypes[category][i].id === dataTypeId) {
                selectedType = dataTypes[category][i];
                break;
            }
        }
        if (selectedType) break;
    }
    
    // Update button text with icon
    if (selectedType) {
        dropdownText.innerHTML = '<span style="display: flex; align-items: center; gap: 8px;">' + selectedType.icon + '<span>' + selectedType.label + '</span></span>';
        console.log('✅ Updated button text to:', selectedType.label);
    }
    
    // Update selected state in dropdown
    var options = panel.querySelectorAll('.dropdown-option');
    for (var i = 0; i < options.length; i++) {
        options[i].classList.remove('selected');
        if (options[i].getAttribute('data-type') === dataTypeId) {
            options[i].classList.add('selected');
        }
    }
    
    // Close dropdown
    panel.classList.remove('open');
    button.classList.remove('open');
    
    // Update mapping and show config panel (use existing logic)
    handleTypeChange(layerName, dataTypeId);
    
    // Hide remove button since a data type is now selected
    hideRemoveButton(layerName);
}

// Event delegation for dropdown functionality
document.addEventListener('click', function(event) {
    // Handle dropdown button clicks
    var dropdownButton = event.target.closest('.dropdown-button');
    if (dropdownButton) {
        event.preventDefault();
        event.stopPropagation();
        var layerName = dropdownButton.getAttribute('data-layer-name');
        if (layerName) {
            console.log('🖱️ Dropdown button clicked for:', layerName);
            toggleDropdown(layerName);
        }
        return;
    }
    
    // Handle dropdown option clicks
    var dropdownOption = event.target.closest('.dropdown-option');
    if (dropdownOption) {
        event.preventDefault();
        event.stopPropagation();
        var layerName = dropdownOption.getAttribute('data-layer-name');
        var dataType = dropdownOption.getAttribute('data-type');
        if (layerName && dataType) {
            console.log('🖱️ Dropdown option clicked:', dataType, 'for:', layerName);
            selectDataType(layerName, dataType);
        }
        return;
    }
    
    // Close dropdowns when clicking outside
    var isDropdownClick = event.target.closest('.custom-dropdown');
    if (!isDropdownClick) {
        var allDropdowns = document.querySelectorAll('.dropdown-panel.open');
        var allButtons = document.querySelectorAll('.dropdown-button.open');
        
        for (var i = 0; i < allDropdowns.length; i++) {
            allDropdowns[i].classList.remove('open');
        }
        
        for (var i = 0; i < allButtons.length; i++) {
            allButtons[i].classList.remove('open');
        }
    }
});

// Auto-populate a mapping with saved configuration
function autoPopulateMapping(layerName, dataTypeId, layerType) {
    console.log('🔄 Auto-populating mapping for:', layerName, 'dataType:', dataTypeId);
    
    // Find the mapping item in DOM
    var mappingItems = document.querySelectorAll('.mapping-item');
    var targetItem = null;
    
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            targetItem = item;
            break;
        }
    }
    
    if (!targetItem) return;
    
    // Find the data type info
    var selectedType = null;
    for (var category in dataTypes) {
        for (var j = 0; j < dataTypes[category].length; j++) {
            if (dataTypes[category][j].id === dataTypeId) {
                selectedType = dataTypes[category][j];
                break;
            }
        }
        if (selectedType) break;
    }
    
    if (!selectedType) return;
    
    // Update the dropdown button text and selection
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var dropdown = document.getElementById('dropdown-' + cleanLayerName);
    if (dropdown) {
        var button = dropdown.querySelector('.dropdown-button');
        var dropdownText = button.querySelector('.dropdown-text');
        var panel = document.getElementById('panel-' + cleanLayerName);
        
        // Update button text with icon
        dropdownText.innerHTML = '<span style="display: flex; align-items: center; gap: 8px;">' + selectedType.icon + '<span>' + selectedType.label + '</span></span>';
        
        // Update selected state in dropdown options
        var options = panel.querySelectorAll('.dropdown-option');
        for (var i = 0; i < options.length; i++) {
            options[i].classList.remove('selected');
            if (options[i].getAttribute('data-type') === dataTypeId) {
                options[i].classList.add('selected');
            }
        }
        
        // Update the mapping data and show config panel
        handleTypeChange(layerName, dataTypeId);
        
        // Restore detailed configuration if available (with small delay to ensure DOM is ready)
        if (detailedConfigurations[layerName]) {
            var detailedConfig = detailedConfigurations[layerName];
            if (detailedConfig.dataTypeId === dataTypeId && detailedConfig.config) {
                setTimeout(function() {
                    restoreDetailedConfig(layerName, detailedConfig.config);
                }, 10);
            }
        }
        
        // Hide remove button since a data type is now selected
        hideRemoveButton(layerName);
    }
}

// Restore detailed configuration values to UI elements
function restoreDetailedConfig(layerName, config) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    console.log('🔄 Restoring detailed config for:', layerName, config);
    
    // Restore all possible configuration values
    if (config.min !== undefined) {
        var minInput = document.getElementById('min-' + cleanLayerName);
        if (minInput) minInput.value = config.min;
    }
    if (config.max !== undefined) {
        var maxInput = document.getElementById('max-' + cleanLayerName);
        if (maxInput) maxInput.value = config.max;
    }
    if (config.decimals !== undefined) {
        var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
        if (decimalsInput) decimalsInput.checked = config.decimals;
    }
    if (config.format !== undefined) {
        var formatInput = document.getElementById('format-' + cleanLayerName);
        if (formatInput) formatInput.checked = config.format;
    }
    if (config.prefix !== undefined) {
        var prefixInput = document.getElementById('prefix-' + cleanLayerName);
        if (prefixInput) prefixInput.value = config.prefix;
    }
    if (config.sorting !== undefined) {
        var sortInput = document.getElementById('sort-' + cleanLayerName);
        if (sortInput) sortInput.value = config.sorting;
    }
    if (config.phoneFormat !== undefined) {
        var phoneFormatInput = document.getElementById('phoneFormat-' + cleanLayerName);
        if (phoneFormatInput) phoneFormatInput.value = config.phoneFormat;
    }
    if (config.dateFormat !== undefined) {
        var dateFormatInput = document.getElementById('dateFormat-' + cleanLayerName);
        if (dateFormatInput) dateFormatInput.value = config.dateFormat;
    }
    if (config.financeType !== undefined) {
        var financeTypeInput = document.getElementById('financeType-' + cleanLayerName);
        if (financeTypeInput) financeTypeInput.value = config.financeType;
    }
    if (config.personType !== undefined) {
        var personTypeInput = document.getElementById('personType-' + cleanLayerName);
        if (personTypeInput) personTypeInput.value = config.personType;
    }
    if (config.customPrefix !== undefined) {
        var customPrefixInput = document.getElementById('customPrefix-' + cleanLayerName);
        if (customPrefixInput) customPrefixInput.value = config.customPrefix;
    }
    if (config.customSuffix !== undefined) {
        var customSuffixInput = document.getElementById('customSuffix-' + cleanLayerName);
        if (customSuffixInput) customSuffixInput.value = config.customSuffix;
    }
    if (config.provider !== undefined) {
        var providerInput = document.getElementById('provider-' + cleanLayerName);
        if (providerInput) providerInput.value = config.provider;
    }
    if (config.domain !== undefined) {
        var domainInput = document.getElementById('domain-' + cleanLayerName);
        if (domainInput) domainInput.value = config.domain;
    }
    if (config.includeProtocol !== undefined) {
        var includeProtocolInput = document.getElementById('includeProtocol-' + cleanLayerName);
        if (includeProtocolInput) includeProtocolInput.checked = config.includeProtocol;
    }
    if (config.locationType !== undefined) {
        var locationTypeInput = document.getElementById('locationType-' + cleanLayerName);
        if (locationTypeInput) locationTypeInput.value = config.locationType;
    }
    if (config.titleType !== undefined) {
        var titleTypeInput = document.getElementById('titleType-' + cleanLayerName);
        if (titleTypeInput) titleTypeInput.value = config.titleType;
    }
    if (config.textCategory !== undefined) {
        var textCategoryInput = document.getElementById('textCategory-' + cleanLayerName);
        if (textCategoryInput) textCategoryInput.value = config.textCategory;
    }
    if (config.avatarType !== undefined) {
        var avatarTypeInput = document.getElementById('avatarType-' + cleanLayerName);
        if (avatarTypeInput) {
            console.log('✅ Setting avatarType to:', config.avatarType, 'for element:', avatarTypeInput);
            avatarTypeInput.value = config.avatarType;
        } else {
            console.log('❌ Avatar type input not found for:', cleanLayerName);
        }
    }
    if (config.imageCategory !== undefined) {
        var imageCategoryInput = document.getElementById('imageCategory-' + cleanLayerName);
        if (imageCategoryInput) imageCategoryInput.value = config.imageCategory;
    }
    if (config.colorType !== undefined) {
        var colorTypeInput = document.getElementById('colorType-' + cleanLayerName);
        if (colorTypeInput) colorTypeInput.value = config.colorType;
    }
    
    // Update preview if it's a custom number
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var configContent = document.getElementById('config-content-' + cleanLayerName);
    if (configContent && configContent.innerHTML.includes('preview-')) {
        setupCustomNumberPreview(layerName);
    }
}

function renderMappings(mappings, savedConfigurations, detailedConfigs) {
    currentMappings = mappings;
    savedConfigurations = savedConfigurations || {};
    detailedConfigurations = detailedConfigs || {};
    
    console.log('📥 UI received detailed configurations:', detailedConfigurations);
    
    if (mappings.length === 0) {
        mappingsContainer.innerHTML = '<div class="empty-state">No layers with % prefixes found</div>';
        applyButton.disabled = true;
        return;
    }
    
    var html = '';
    for (var i = 0; i < mappings.length; i++) {
        var mapping = mappings[i];
        var cleanLayerName = mapping.layerName.replace(/[^a-zA-Z0-9]/g, '');
        
        // Get available categories for this layer type
        var availableCategories = getAvailableCategoriesForLayerType(mapping.layerType);
        
        // Generate layer type indicator for inline use
        var layerTypeIndicator = '';
        var layerTypeClass = '';
        switch (mapping.layerType) {
            case 'TEXT':
                layerTypeIndicator = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 1.5C9.76522 1.5 10.0195 1.60543 10.207 1.79297C10.3946 1.98051 10.5 2.23478 10.5 2.5V3.5C10.5 3.77614 10.2761 4 10 4C9.72386 4 9.5 3.77614 9.5 3.5V2.5H6.5V9.5H7.5C7.77614 9.5 8 9.72386 8 10C8 10.2761 7.77614 10.5 7.5 10.5H4.5C4.22386 10.5 4 10.2761 4 10C4 9.72386 4.22386 9.5 4.5 9.5H5.5V2.5H2.5V3.5C2.5 3.77614 2.27614 4 2 4C1.72386 4 1.5 3.77614 1.5 3.5V2.5C1.5 2.23478 1.60543 1.9805 1.79297 1.79297C1.9805 1.60543 2.23478 1.5 2.5 1.5H9.5Z" /></svg>';
                layerTypeClass = 'layer-type-text';
                break;
            case 'OTHER':
                layerTypeIndicator = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_781_4798)"><path d="M9.56445 6.89746C9.70003 6.65698 10.0056 6.57153 10.2461 6.70703L10.9961 7.12988H10.9971C11.1508 7.21709 11.2792 7.34436 11.3682 7.49707C11.457 7.64973 11.5039 7.82339 11.5039 8C11.5039 8.17681 11.4572 8.35113 11.3682 8.50391C11.2795 8.65602 11.151 8.78103 10.998 8.86816L10.999 8.86914L6.75 11.3018L6.75098 11.3027C6.52321 11.4342 6.26397 11.5037 6.00098 11.5039C5.73817 11.5039 5.47966 11.4339 5.25195 11.3027V11.3037L1.00195 8.86914V8.86816C0.849263 8.78108 0.7214 8.65576 0.632812 8.50391C0.543766 8.35109 0.496107 8.17687 0.496094 8C0.496108 7.8233 0.543934 7.64978 0.632812 7.49707C0.721868 7.3443 0.85006 7.21707 1.00391 7.12988H1.00488L1.75488 6.70703C1.99542 6.57177 2.30105 6.65698 2.43652 6.89746C2.57146 7.13779 2.48611 7.44257 2.24609 7.57812L1.49707 8L1.49902 8.00098L5.74902 10.4365L5.75098 10.4375C5.82677 10.481 5.91356 10.5039 6.00098 10.5039C6.08843 10.5037 6.17523 10.4812 6.25098 10.4375L6.25195 10.4365L10.502 8.00098L10.5029 8L9.75488 7.57812C9.5146 7.4426 9.42929 7.13791 9.56445 6.89746ZM6.00098 0.496094C6.2634 0.496255 6.52162 0.565341 6.74902 0.696289L10.9971 3.12988C11.1508 3.21709 11.2792 3.34436 11.3682 3.49707C11.457 3.64973 11.5039 3.82338 11.5039 4C11.5039 4.17681 11.4572 4.35112 11.3682 4.50391C11.2795 4.65602 11.151 4.78103 10.998 4.86816L10.999 4.86914L6.75 7.30176L6.75098 7.30273C6.52321 7.43423 6.26396 7.50374 6.00098 7.50391C5.73817 7.50391 5.47966 7.4339 5.25195 7.30273V7.30371L1.00195 4.86914V4.86816C0.84926 4.78108 0.721402 4.65576 0.632812 4.50391C0.543763 4.35108 0.496104 4.17687 0.496094 4C0.496106 3.8233 0.543935 3.64978 0.632812 3.49707C0.721867 3.34431 0.850067 3.21707 1.00391 3.12988L5.25195 0.696289V0.697266C5.47966 0.566101 5.73817 0.496094 6.00098 0.496094ZM6.00098 1.49609C5.9134 1.49609 5.82687 1.51978 5.75098 1.56348H5.74902L1.49902 3.99902L1.49707 4L1.49902 4.00098L5.74902 6.43652L5.75098 6.4375C5.82677 6.48104 5.91356 6.50391 6.00098 6.50391C6.08843 6.50375 6.17523 6.48123 6.25098 6.4375L6.25195 6.43652L10.502 4.00098L10.5039 4L10.502 3.99902L6.25195 1.56348H6.25098C6.17523 1.51975 6.08843 1.49626 6.00098 1.49609Z" /></g><defs><clipPath id="clip0_781_4798"><rect width="12" height="12" /></clipPath></defs></svg>';
                layerTypeClass = 'layer-type-image';
                break;
            case 'MIXED':
                layerTypeIndicator = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_781_4798)"><path d="M9.56445 6.89746C9.70003 6.65698 10.0056 6.57153 10.2461 6.70703L10.9961 7.12988H10.9971C11.1508 7.21709 11.2792 7.34436 11.3682 7.49707C11.457 7.64973 11.5039 7.82339 11.5039 8C11.5039 8.17681 11.4572 8.35113 11.3682 8.50391C11.2795 8.65602 11.151 8.78103 10.998 8.86816L10.999 8.86914L6.75 11.3018L6.75098 11.3027C6.52321 11.4342 6.26397 11.5037 6.00098 11.5039C5.73817 11.5039 5.47966 11.4339 5.25195 11.3027V11.3037L1.00195 8.86914V8.86816C0.849263 8.78108 0.7214 8.65576 0.632812 8.50391C0.543766 8.35109 0.496107 8.17687 0.496094 8C0.496108 7.8233 0.543934 7.64978 0.632812 7.49707C0.721868 7.3443 0.85006 7.21707 1.00391 7.12988H1.00488L1.75488 6.70703C1.99542 6.57177 2.30105 6.65698 2.43652 6.89746C2.57146 7.13779 2.48611 7.44257 2.24609 7.57812L1.49707 8L1.49902 8.00098L5.74902 10.4365L5.75098 10.4375C5.82677 10.481 5.91356 10.5039 6.00098 10.5039C6.08843 10.5037 6.17523 10.4812 6.25098 10.4375L6.25195 10.4365L10.502 8.00098L10.5029 8L9.75488 7.57812C9.5146 7.4426 9.42929 7.13791 9.56445 6.89746ZM6.00098 0.496094C6.2634 0.496255 6.52162 0.565341 6.74902 0.696289L10.9971 3.12988C11.1508 3.21709 11.2792 3.34436 11.3682 3.49707C11.457 3.64973 11.5039 3.82338 11.5039 4C11.5039 4.17681 11.4572 4.35112 11.3682 4.50391C11.2795 4.65602 11.151 4.78103 10.998 4.86816L10.999 4.86914L6.75 7.30176L6.75098 7.30273C6.52321 7.43423 6.26396 7.50374 6.00098 7.50391C5.73817 7.50391 5.47966 7.4339 5.25195 7.30273V7.30371L1.00195 4.86914V4.86816C0.84926 4.78108 0.721402 4.65576 0.632812 4.50391C0.543763 4.35108 0.496104 4.17687 0.496094 4C0.496106 3.8233 0.543935 3.64978 0.632812 3.49707C0.721867 3.34431 0.850067 3.21707 1.00391 3.12988L5.25195 0.696289V0.697266C5.47966 0.566101 5.73817 0.496094 6.00098 0.496094ZM6.00098 1.49609C5.9134 1.49609 5.82687 1.51978 5.75098 1.56348H5.74902L1.49902 3.99902L1.49707 4L1.49902 4.00098L5.74902 6.43652L5.75098 6.4375C5.82677 6.48104 5.91356 6.50391 6.00098 6.50391C6.08843 6.50375 6.17523 6.48123 6.25098 6.4375L6.25195 6.43652L10.502 4.00098L10.5039 4L10.502 3.99902L6.25195 1.56348H6.25098C6.17523 1.51975 6.08843 1.49626 6.00098 1.49609Z" /></g><defs><clipPath id="clip0_781_4798"><rect width="12" height="12" /></clipPath></defs></svg>';
                layerTypeClass = 'layer-type-mixed';
                break;
        }
        
        // Add saved configuration indicator
        var savedConfigIndicator = '';
        if (mapping.isPreConfigured) {
            savedConfigIndicator = '<div style="color: #00aa00; font-size: 11px; margin-bottom: 6px;">💾 Previously configured</div>';
        }
        
        html += '<div class="mapping-item">';
        html += '<div class="mapping-header">';
        html += '<div class="mapping-layer">';
        html += '<span class="layer-type-indicator ' + layerTypeClass + '">' + layerTypeIndicator + '</span>';
        html += '<span class="layer-name">' + mapping.layerName + '</span>';
        html += '</div>';
        html += '<div class="mapping-select">';
        html += '<div class="data-type-selector">';
        html += '<div class="custom-dropdown" id="dropdown-' + cleanLayerName + '">';
        html += '<button type="button" class="dropdown-button" data-layer-name="' + mapping.layerName + '">';
        html += '<span class="dropdown-text">Select...</span>';
        html += '<svg class="dropdown-arrow" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">';
        html += '<path d="M7.14645 3.39648C7.34171 3.20122 7.65822 3.20122 7.85348 3.39648C8.04874 3.59174 8.04874 3.90825 7.85348 4.10351L5.35348 6.60351C5.15822 6.79877 4.84171 6.79877 4.64645 6.60351L2.14645 4.10351C1.95118 3.90825 1.95118 3.59174 2.14645 3.39648C2.34171 3.20121 2.65822 3.20121 2.85348 3.39648L4.99996 5.54296L7.14645 3.39648Z" />';
        html += '</svg>';
        html += '</button>';
        html += '<div class="dropdown-panel" id="panel-' + cleanLayerName + '">';
        html += '<div class="dropdown-content">';
        html += generateDropdownContent(availableCategories, mapping.layerName);
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        // Always create both buttons, show/hide based on configuration state
        html += '<button class="remove-btn" onclick="handleRemoveMapping(\'' + mapping.layerName.replace(/'/g, "\\'") + '\')" style="display: ' + (!mapping.dataTypeId ? 'flex' : 'none') + ';">';
        html += '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">';
        html += '<g clip-path="url(#clip0_828_6358)">';
        html += '<path d="M8 0.833008C11.9578 0.833184 15.1658 4.04224 15.166 8C15.1658 11.9578 11.9578 15.1658 8 15.166C4.04224 15.1658 0.833184 11.9578 0.833008 8C0.833206 4.04225 4.04225 0.833206 8 0.833008ZM8 1.83301C4.59453 1.83321 1.83321 4.59453 1.83301 8C1.83318 11.4055 4.59452 14.1658 8 14.166C11.4055 14.1658 14.1658 11.4055 14.166 8C14.1658 4.59452 11.4055 1.83318 8 1.83301ZM9.64648 5.64648C9.84175 5.45122 10.1583 5.45122 10.3535 5.64648C10.5487 5.84175 10.5488 6.15827 10.3535 6.35352L8.70703 8L10.3535 9.64648L10.418 9.72461C10.5461 9.91868 10.5244 10.1827 10.3535 10.3535C10.1827 10.5244 9.91868 10.5461 9.72461 10.418L9.64648 10.3535L8 8.70703L6.35352 10.3535C6.15827 10.5488 5.84175 10.5487 5.64648 10.3535C5.45122 10.1583 5.45122 9.84175 5.64648 9.64648L7.29297 8L5.64648 6.35352C5.45122 6.15825 5.45122 5.84175 5.64648 5.64648C5.84175 5.45122 6.15825 5.45122 6.35352 5.64648L8 7.29297L9.64648 5.64648Z" />';
        html += '</g>';
        html += '<defs>';
        html += '<clipPath id="clip0_828_6358">';
        html += '<rect width="16" height="16" />';
        html += '</clipPath>';
        html += '</defs>';
        html += '</svg>';
        html += '</button>';
        html += '<button class="config-toggle" onclick="toggleConfigPanel(\'' + mapping.layerName.replace(/'/g, "\\'") + '\')" style="display: ' + (mapping.dataTypeId ? 'flex' : 'none') + ';">';
        html += '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">';
        html += '<path d="M11.333 8.83301C12.7136 8.83301 13.8328 9.95244 13.833 11.333C13.833 12.7137 12.7137 13.833 11.333 13.833C10.1235 13.8328 9.11426 12.9742 8.88281 11.833H3.33301C3.05703 11.8328 2.83301 11.609 2.83301 11.333C2.83318 11.0571 3.05714 10.8332 3.33301 10.833H8.88281C9.1145 9.6921 10.1238 8.83318 11.333 8.83301ZM11.333 9.83301C10.5049 9.83321 9.83318 10.5048 9.83301 11.333C9.83301 12.1613 10.5047 12.8328 11.333 12.833C12.1614 12.833 12.833 12.1614 12.833 11.333C12.8328 10.5047 12.1613 9.83301 11.333 9.83301ZM4.66699 2.16699C5.87646 2.16717 6.88574 3.02578 7.11719 4.16699H12.667C12.943 4.16719 13.167 4.39097 13.167 4.66699C13.1668 4.94287 12.9429 5.16679 12.667 5.16699H7.11719C6.8855 6.3079 5.87624 7.16682 4.66699 7.16699C3.28639 7.16699 2.16717 6.04756 2.16699 4.66699C2.16699 3.28628 3.28628 2.16699 4.66699 2.16699ZM4.66699 3.16699C3.83857 3.16699 3.16699 3.83857 3.16699 4.66699C3.16717 5.49527 3.83867 6.16699 4.66699 6.16699C5.49514 6.16679 6.16682 5.49515 6.16699 4.66699C6.16699 3.83869 5.49525 3.16719 4.66699 3.16699Z" />';
        html += '</svg>';
        html += '</button>';
        html += '</div>';
        html += '</div>';
        // html += savedConfigIndicator; // Removed "Previously configured" message
        
        // Configuration panel (initially hidden, will be shown when a data type with options is selected)
        html += '<div class="config-panel" id="config-panel-' + cleanLayerName + '" style="display: none;">';
        html += '<div class="config-content" id="config-content-' + cleanLayerName + '"></div>';
        html += '</div>';
        html += '</div>';
    }
    
    mappingsContainer.innerHTML = html;
    
    // Auto-populate saved configurations
    for (var i = 0; i < mappings.length; i++) {
        var mapping = mappings[i];
        if (mapping.dataTypeId) {
            autoPopulateMapping(mapping.layerName, mapping.dataTypeId, mapping.layerType);
        }
    }
    
    applyButton.disabled = false;
    
    // Load integer settings after rendering
    loadIntegerSettings();
}

function handleRemoveMapping(layerName) {
    parent.postMessage({ 
        pluginMessage: { 
            type: 'remove-mapping', 
            layerName: layerName 
        } 
    }, '*');
}

// Legacy function - no longer used with custom dropdown
// Kept for backward compatibility during transition
function handleCategoryChange(layerName, category) {
    // This function is deprecated - custom dropdown handles selection directly
    console.log('handleCategoryChange called - this function is deprecated with custom dropdown');
}

function handleTypeChange(layerName, dataTypeId) {
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            // If dataTypeId is falsy (empty string, null, undefined), remove it entirely
            if (!dataTypeId || dataTypeId.trim() === '') {
                delete currentMappings[i].dataTypeId;
            } else {
                currentMappings[i].dataTypeId = dataTypeId;
            }
            break;
        }
    }
    
    // Show/hide configuration panel based on selection
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var configPanel = document.getElementById('config-panel-' + cleanLayerName);
    var configContent = document.getElementById('config-content-' + cleanLayerName);
    
    if (!configPanel || !configContent) return;
    
    // Find the data type configuration
    var dataType = null;
    for (var category in dataTypes) {
        for (var j = 0; j < dataTypes[category].length; j++) {
            if (dataTypes[category][j].id === dataTypeId) {
                dataType = dataTypes[category][j];
                break;
            }
        }
        if (dataType) break;
    }
    
    // Find the toggle button to sync its state
    var mappingItems = document.querySelectorAll('.mapping-item');
    var toggleButton = null;
    
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            toggleButton = item.querySelector('.config-toggle');
            break;
        }
    }

    if (dataType && dataType.hasOptions) {
        configPanel.style.display = 'block';
        configContent.innerHTML = generateConfigHTML(dataTypeId, layerName);
        
        // Set toggle button to open state since panel is visible
        if (toggleButton) {
            toggleButton.classList.add('open');
        }
        
        // Set up preview for custom numbers
        if (dataTypeId === 'custom') {
            setupCustomNumberPreview(layerName);
        }
    } else {
        configPanel.style.display = 'none';
        configContent.innerHTML = '';
        
        // Set toggle button to closed state since panel is hidden
        if (toggleButton) {
            toggleButton.classList.remove('open');
        }
    }
}

// Generate configuration HTML for data types with options
function generateConfigHTML(dataTypeId, layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var html = '';
    
    // Add configuration header (no toggle button since it's now in the mapping header)
    function addConfigHeader(title) {
        // Headers removed - just open the config body div
        html += '<div class="config-body" id="config-body-' + cleanLayerName + '">';
    }
    
    function closeConfigBody() {
        html += '</div>'; // Close config-body
    }
    
    switch (dataTypeId) {
        case 'custom':
            addConfigHeader('🔢 Custom Number Settings');

            // Preview
            html += '<div class="config-preview">';
            html += '<span id="preview-' + cleanLayerName + '">1,234</span>';
            html += '</div>';

            // Checkboxes
            html += '<div class="config-row">';
            html += '<div style="flex: 1;" class="config-checkbox">';
            html += '<input type="checkbox" id="decimals-' + cleanLayerName + '">';
            html += '<span>Decimals</span>';
            html += '</div>';
            html += '<div style="flex: 1;" class="config-checkbox">';
            html += '<input type="checkbox" id="format-' + cleanLayerName + '">';
            html += '<span>Formatted</span>';
            html += '</div>';
            html += '</div>';
            
            // Range inputs
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<input class="config-input" type="number" id="min-' + cleanLayerName + '" placeholder="Min" >';
            html += '</div>';
            html += '<div style="flex: 1; ">';
            html += '<input class="config-input" type="number" id="max-' + cleanLayerName + '" placeholder="Max" >';
            html += '</div>';
            html += '</div>';
            
            // Prefix and sorting
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<input type="text" id="prefix-' + cleanLayerName + '" placeholder="Prefix" class="config-input">';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="ascending">Ascending</option>';
            html += '<option value="descending">Descending</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            
            
            
            closeConfigBody();
            
            // Store the layer name for later event listener setup
            if (!window.customNumberLayers) {
                window.customNumberLayers = [];
            }
            window.customNumberLayers.push(cleanLayerName);
            break;
            
        case 'percentage':
            addConfigHeader('📊 Percentage Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;" class="config-checkbox">';
            html += '<input type="checkbox" id="decimals-' + cleanLayerName + '">';
            html += '<span>Decimals</span>';
            html += '</div>';
            html += '<div style="flex: 1;" >';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="ascending">Ascending</option>';
            html += '<option value="descending">Descending</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'phone':
            addConfigHeader('📞 Phone Settings');
            html += '<div class="config-row">';
            html += '<select id="phoneFormat-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="human">Human Readable</option>';
            html += '<option value="national">National Format</option>';
            html += '<option value="international">International Format</option>';
            html += '</select>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'date':
            addConfigHeader('📅 Date Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;" >';
            html += '<select id="dateFormat-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="MM/DD/YYYY">MM/DD/YYYY</option>';
            html += '<option value="DD/MM/YYYY">DD/MM/YYYY</option>';
            html += '<option value="YYYY/MM/DD">YYYY/MM/DD</option>';
            html += '<option value="year">Year only</option>';
            html += '<option value="month">Month only</option>';
            html += '<option value="weekday">Weekday only</option>';
            html += '</select>';
            html += '</div>';
            html += '<div style="flex: 1;" >';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="recent">Most Recent</option>';
            html += '<option value="oldest">Oldest</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'finances':
            addConfigHeader('💰 Finance Settings');
            html += '<div class="config-row">';
            html += '<select id="financeType-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="credit-card">Credit Card Number</option>';
            html += '<option value="account-number">Account Number</option>';
            html += '<option value="bitcoin">Bitcoin Address</option>';
            html += '<option value="iban">IBAN</option>';
            html += '</select>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'person':
            addConfigHeader('👤 Person Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<input type="text" id="customPrefix-' + cleanLayerName + '" class="config-input" placeholder="Prefix">';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<input type="text" id="customSuffix-' + cleanLayerName + '" class="config-input" placeholder="Sufix">';
            html += '</div>';
            html += '</div>';

            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="personType-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="full-name">Full Name</option>';
            html += '<option value="first-name">First Name</option>';
            html += '<option value="last-name">Last Name</option>';
            html += '<option value="username">Username</option>';
            html += '<option value="gender">Gender</option>';
            html += '<option value="job-title">Job Title</option>';
            html += '<option value="password">Password</option>';
            html += '</select>';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            
            closeConfigBody();
            break;
            
        case 'email':
            addConfigHeader('📧 Email Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<input type="text" id="provider-' + cleanLayerName + '" placeholder="e.g., gmail.com" class="config-input">';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'website':
            addConfigHeader('🌐 Website Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;" class="config-checkbox">';
            html += '<input type="checkbox" id="includeProtocol-' + cleanLayerName + '" checked>';
            html += '<span style="font-size: 12px;">Include https://</span>';
            html += '</div>';
            html += '</div>';

            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<input type="text" id="domain-' + cleanLayerName + '" placeholder="e.g., .com, .org" class="config-input">';
            html += '</div>';
            html += '<div style="flex: 1;">';            
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'location':
            addConfigHeader('🗺️ Location Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="locationType-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="city">City</option>';
            html += '<option value="country">Country</option>';
            html += '<option value="full-address">Full Address</option>';
            html += '<option value="street-address">Street Address</option>';
            html += '<option value="zip-code">ZIP Code</option>';
            html += '<option value="country-code">Country Code</option>';
            html += '<option value="coordinates">Coordinates</option>';
            html += '</select>';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'title':
            addConfigHeader('📰 Title Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="titleType-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="post-title">Post Title</option>';
            html += '<option value="company-name">Company Name</option>';
            html += '<option value="product-name">Product Name</option>';
            html += '<option value="food">Food</option>';
            html += '<option value="animal">Animal</option>';
            html += '<option value="song-title">Song Title</option>';
            html += '<option value="music-artist">Music Artist</option>';
            html += '<option value="random-word">Random Word</option>';
            html += '</select>';
            html += '</div>';
            html += '<div style="flex: 1;">';
            html += '<select id="sort-' + cleanLayerName + '" class="config-select">';
            html += '<option value="random">Random</option>';
            html += '<option value="a-z">A-Z</option>';
            html += '<option value="z-a">Z-A</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'long_text':
            addConfigHeader('📖 Long Text Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="textCategory-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="any">Any Category</option>';
            html += '<option value="technology">Technology</option>';
            html += '<option value="biography">Biography</option>';
            html += '<option value="history">History</option>';
            html += '<option value="nature">Nature</option>';
            html += '<option value="medicine">Medicine</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'avatar':
            addConfigHeader('👤 Avatar Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="avatarType-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="any">Any Avatar</option>';
            html += '<option value="real-people">Real People</option>';
            html += '<option value="male">Only Male</option>';
            html += '<option value="female">Only Female</option>';
            html += '<option value="robots">Robots</option>';
            html += '<option value="cartoon">Cartoon</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'image':
            addConfigHeader('🖼️ Image Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="imageCategory-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="any">Any Category</option>';
            html += '<option value="products">Products</option>';
            html += '<option value="landscapes">Landscapes</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
            
        case 'color':
            addConfigHeader('🎨 Color Settings');
            html += '<div class="config-row">';
            html += '<div style="flex: 1;">';
            html += '<select id="colorType-' + cleanLayerName + '" class="config-select-simple">';
            html += '<option value="solid">Solid Color</option>';
            html += '<option value="gradient">Gradient</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            closeConfigBody();
            break;
    }
    
    return html;
}

// Store configuration settings for each mapping
var configSettings = {};

// Configuration storage key for integer settings
var INTEGER_SETTINGS_STORAGE_KEY = 'integerSettings';

// Store integer generation context
var currentIntegerGenerationContext = {
    layerName: null,
    count: 0,
    generatedNumbers: []
};

// Batch-level anti-repetition system - prevents repetition within current operation
var currentBatchUsedContent = {};

// Function to get non-repeated content from an array within current batch
function getUniqueFromBatch(contentArray, categoryKey) {
    if (!contentArray || contentArray.length === 0) {
        return null;
    }
    
    // Initialize tracking for this category if not exists
    if (!currentBatchUsedContent[categoryKey]) {
        currentBatchUsedContent[categoryKey] = [];
    }
    
    var usedInBatch = currentBatchUsedContent[categoryKey];
    
    // Find available (not used in this batch) items
    var availableItems = contentArray.filter(function(item) {
        return usedInBatch.indexOf(item) === -1;
    });
    
    // If no available items, reset batch tracking for this category
    if (availableItems.length === 0) {
        currentBatchUsedContent[categoryKey] = [];
        availableItems = contentArray;
    }
    
    // Select from available items
    var selectedItem = availableItems[Math.floor(Math.random() * availableItems.length)];
    
    // Track this selection in current batch
    currentBatchUsedContent[categoryKey].push(selectedItem);
    
    return selectedItem;
}

// Reset batch tracking when starting a new operation
function resetBatchTracking() {
    currentBatchUsedContent = {};
}

function generateCustomIntegerArray(count, layerName) {
    // Get settings for the layer
    var settings = integerSettings[layerName] || {
        includeDecimals: false,
        formatWithCommas: false,
        minValue: 1,
        maxValue: 1000,
        prefix: '',
        sortOrder: 'none'
    };
    
    var minVal = settings.minValue;
    var maxVal = settings.maxValue;
    
    // Ensure min is less than max
    if (minVal >= maxVal) {
        maxVal = minVal + 1000;
    }
    
    var numbers = [];
    var generatedSet = new Set();
    var maxAttempts = Math.min(1000, (maxVal - minVal + 1) * 2); // Reasonable limit for unique attempts
    
    // Generate the required number of values
    for (var i = 0; i < count; i++) {
        var number;
        var attempts = 0;
        
        // Try to generate a unique number
        do {
            if (settings.includeDecimals) {
                // Generate with 2 decimal places
                var baseNumber = Math.random() * (maxVal - minVal) + minVal;
                number = Math.round(baseNumber * 100) / 100;
            } else {
                // Generate integer
                number = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
            }
            attempts++;
        } while (generatedSet.has(number) && attempts < maxAttempts);
        
        // Add to set to track uniqueness
        generatedSet.add(number);
        numbers.push(number);
    }
    
    // Apply sorting if specified
    if (settings.sortOrder === 'ascending') {
        numbers.sort(function(a, b) { return a - b; });
    } else if (settings.sortOrder === 'descending') {
        numbers.sort(function(a, b) { return b - a; });
    }
    // 'none' means no sorting - keep random order
    
    // Format all numbers
    var formattedNumbers = numbers.map(function(number) {
        var formattedNumber = number.toString();
        
        if (settings.formatWithCommas && !settings.includeDecimals) {
            // Add comma formatting for integers
            formattedNumber = number.toLocaleString();
        } else if (settings.formatWithCommas && settings.includeDecimals) {
            // Add comma formatting for decimals (ensure 2 decimal places)
            formattedNumber = number.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } else if (settings.includeDecimals) {
            // Ensure 2 decimal places without comma formatting
            formattedNumber = number.toFixed(2);
        }
        
        // Add prefix if specified
        if (settings.prefix) {
            formattedNumber = settings.prefix + formattedNumber;
        }
        
        return formattedNumber;
    });
    
    return formattedNumbers;
}

// Legacy function for single number generation (fallback)
function generateCustomInteger() {
    // This function is kept for backwards compatibility but shouldn't be used
    // in the new array-based generation approach
    console.warn('⚠️ Using legacy single integer generation - should use array generation instead');
    var settings = integerSettings[currentIntegerGenerationContext.layerName] || {
        includeDecimals: false,
        formatWithCommas: false,
        minValue: 1,
        maxValue: 1000,
        prefix: '',
        sortOrder: 'none'
    };
    
    var minVal = settings.minValue;
    var maxVal = settings.maxValue;
    
    if (minVal >= maxVal) {
        maxVal = minVal + 1000;
    }
    
    var number;
    if (settings.includeDecimals) {
        var baseNumber = Math.random() * (maxVal - minVal) + minVal;
        number = Math.round(baseNumber * 100) / 100;
    } else {
        number = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
    }
    
    var formattedNumber = number.toString();
    
    if (settings.formatWithCommas && !settings.includeDecimals) {
        formattedNumber = number.toLocaleString();
    } else if (settings.formatWithCommas && settings.includeDecimals) {
        formattedNumber = number.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } else if (settings.includeDecimals) {
        formattedNumber = number.toFixed(2);
    }
    
    if (settings.prefix) {
        formattedNumber = settings.prefix + formattedNumber;
    }
    
    return formattedNumber;
}

function updateIntegerSettings(layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    var decimalsCheckbox = document.getElementById('decimals-' + cleanLayerName);
    var formatCheckbox = document.getElementById('format-' + cleanLayerName);
    var minInput = document.getElementById('min-' + cleanLayerName);
    var maxInput = document.getElementById('max-' + cleanLayerName);
    var prefixInput = document.getElementById('prefix-' + cleanLayerName);
    var sortSelect = document.getElementById('sort-' + cleanLayerName);
    
    if (!integerSettings[layerName]) {
        integerSettings[layerName] = {};
    }
    
    integerSettings[layerName] = {
        includeDecimals: decimalsCheckbox ? decimalsCheckbox.checked : false,
        formatWithCommas: formatCheckbox ? formatCheckbox.checked : false,
        minValue: minInput ? parseInt(minInput.value) || 1 : 1,
        maxValue: maxInput ? parseInt(maxInput.value) || 1000 : 1000,
        prefix: prefixInput ? prefixInput.value || '' : '',
        sortOrder: sortSelect ? sortSelect.value || 'none' : 'none'
    };
    
    console.log('Updated integer settings for', layerName, ':', integerSettings[layerName]);
    
    // Auto-save integer settings
    saveIntegerSettings();
}

// Save integer settings to storage
function saveIntegerSettings() {
    try {
        parent.postMessage({
            pluginMessage: {
                type: 'store-integer-settings',
                data: integerSettings
            }
        }, '*');
        console.log('💾 Integer settings saved');
    } catch (error) {
        console.error('Error saving integer settings:', error);
    }
}

// Load integer settings from storage  
function loadIntegerSettings() {
    try {
        parent.postMessage({
            pluginMessage: {
                type: 'load-integer-settings'
            }
        }, '*');
    } catch (error) {
        console.error('Error loading integer settings:', error);
    }
}

// Populate integer controls with loaded settings
function populateIntegerControlsFromSettings() {
    // Go through all current mappings and populate integer controls
    for (var layerName in integerSettings) {
        var settings = integerSettings[layerName];
        var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
        
        // Check if controls exist for this layer
        var decimalsCheckbox = document.getElementById('decimals-' + cleanLayerName);
        if (decimalsCheckbox) {
            decimalsCheckbox.checked = settings.includeDecimals || false;
        }
        
        var formatCheckbox = document.getElementById('format-' + cleanLayerName);
        if (formatCheckbox) {
            formatCheckbox.checked = settings.formatWithCommas || false;
        }
        
        var minInput = document.getElementById('min-' + cleanLayerName);
        if (minInput) {
            minInput.value = settings.minValue || 1;
        }
        
        var maxInput = document.getElementById('max-' + cleanLayerName);
        if (maxInput) {
            maxInput.value = settings.maxValue || 1000;
        }
        
        var prefixInput = document.getElementById('prefix-' + cleanLayerName);
        if (prefixInput) {
            prefixInput.value = settings.prefix || '';
        }
        
        var sortSelect = document.getElementById('sort-' + cleanLayerName);
        if (sortSelect) {
            sortSelect.value = settings.sortOrder || 'none';
        }
        
        console.log('🔧 Populated integer controls for', layerName, 'with settings:', settings);
    }
}

// Enhanced data generation function
function generateData(dataTypeId, count, layerName) {
    console.log('🔄 Generating data for:', dataTypeId, 'count:', count, 'layer:', layerName);
    
    // Handle special external API types first
    if (dataTypeId === 'avatar_randomuser') {
        return fetchRandomUserPhotos(count);
    }
    
    if (dataTypeId === 'avatar_randomuser_male') {
        return fetchRandomUserPhotos(count, 'male');
    }
    
    if (dataTypeId === 'avatar_randomuser_female') {
        return fetchRandomUserPhotos(count, 'female');
    }
    
    if (dataTypeId === 'avatar_pravatar') {
        return fetchPravatarPhotos(count);
    }
    
    if (dataTypeId === 'avatar_multiavatar') {
        return fetchMultiavatarPhotos(count);
    }
    
    if (dataTypeId === 'avatar_robohash') {
        return fetchRobohashPhotos(count);
    }
    
    if (dataTypeId === 'user_api') {
        return fetch('https://randomuser.me/api/?results=' + count)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                return data.results.map(function(user) {
                    return user.name.first + ' ' + user.name.last;
                });
            })
            .catch(function(error) {
                console.error('RandomUser API failed:', error);
                return Array(count).fill('API Error');
            });
    }
    
    if (dataTypeId === 'product_api') {
        return fetch('https://dummyjson.com/products?limit=' + Math.min(count, 100))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var results = [];
                for (var i = 0; i < count; i++) {
                    results.push(data.products[i % data.products.length].title);
                }
                return results;
            })
            .catch(function(error) {
                console.error('DummyJSON API failed:', error);
                return Array(count).fill('API Error');
            });
    }
    
    if (dataTypeId === 'product_image') {
        return fetch('https://dummyjson.com/products?limit=' + Math.min(count, 100))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var images = data.products.map(function(product) {
                    return product.thumbnail;
                });
                var result = [];
                for (var i = 0; i < count; i++) {
                    result.push(images[i % images.length]);
                }
                return result;
            })
            .catch(function(error) {
                console.error('DummyJSON API failed:', error);
                var fallback = [];
                for (var i = 0; i < count; i++) {
                    fallback.push('https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000));
                }
                return fallback;
            });
    }
    
    // Handle new enhanced data types
    if (window.fakerLoaded && window.faker) {
        console.log('🎲 Using enhanced Faker.js generation for:', dataTypeId);
        
        var results = [];
        for (var i = 0; i < count; i++) {
            var value = generateSingleValue(dataTypeId, layerName);
            results.push(String(value));
        }
        
        // Apply sorting if configured
        var config = getConfigForLayer(dataTypeId, layerName);
        if (config && config.sorting && config.sorting !== 'random') {
            results = applySorting(results, config.sorting, dataTypeId);
        }
        
        console.log('✅ Generated', results.length, 'items for:', dataTypeId);
        console.log('Sample data:', results.slice(0, 3));
        return Promise.resolve(results);
    }
    
    // Fallback if Faker.js is not loaded
    return Promise.resolve(generateDataFallback(dataTypeId, count, layerName));
}

// Generate a single value based on data type ID and layer configuration
function generateSingleValue(dataTypeId, layerName) {
    // Get configuration for this layer if available
    var config = getConfigForLayer(dataTypeId, layerName);
    
    switch (dataTypeId) {
        // NUMBERS
        case 'custom':
            var min = config.min || 1;
            var max = config.max || 1000;
            var decimals = config.decimals || false;
            var format = config.format || false;
            var prefix = config.prefix || '';
            
            var value = Math.random() * (max - min) + min;
            
            if (!decimals) {
                value = Math.floor(value);
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            var result = value.toString();
            
            if (format && value >= 1000) {
                result = value.toLocaleString();
            }
            
            if (decimals && !result.includes('.')) {
                result += '.00';
            }
            
            return prefix + result;
            
        case 'percentage':
            var decimals = config.decimals || false;
            var value = Math.random() * 100;
            
            if (!decimals) {
                value = Math.floor(value);
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            return value + '%';
            
        case 'phone':
            var format = config.phoneFormat || 'human';
            
            switch (format) {
                case 'national':
                    return window.faker.phone.number('###-###-####');
                case 'international':
                    return window.faker.phone.number('+1-###-###-####');
                default: // human
                    return window.faker.phone.number();
            }
            
        case 'date':
            var format = config.dateFormat || 'MM/DD/YYYY';
            var date = window.faker.date.anytime();
            
            switch (format) {
                case 'DD/MM/YYYY':
                    return date.toLocaleDateString('en-GB');
                case 'YYYY/MM/DD':
                    return date.toISOString().split('T')[0];
                case 'year':
                    return date.getFullYear().toString();
                case 'month':
                    return date.toLocaleDateString('en-US', { month: 'long' });
                case 'weekday':
                    return date.toLocaleDateString('en-US', { weekday: 'long' });
                default: // MM/DD/YYYY
                    return date.toLocaleDateString('en-US');
            }
            
        case 'finances':
            var type = config.financeType || 'credit-card';
            
            switch (type) {
                case 'account-number':
                    // Use fallback if function doesn't exist
                    if (window.faker.finance.accountNumber) {
                        return window.faker.finance.accountNumber();
                    } else {
                        // Generate simple account number fallback
                        return Math.floor(Math.random() * 900000000) + 100000000;
                    }
                case 'bitcoin':
                    // Use fallback if function doesn't exist
                    if (window.faker.finance.bitcoinAddress) {
                        return window.faker.finance.bitcoinAddress();
                    } else {
                        // Generate simple Bitcoin address fallback
                        var chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
                        var result = '1';
                        for (var i = 0; i < 33; i++) {
                            result += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return result;
                    }
                case 'iban':
                    // Use fallback if function doesn't exist
                    if (window.faker.finance.iban) {
                        return window.faker.finance.iban();
                    } else {
                        // Generate simple IBAN fallback
                        var countryCode = ['DE', 'FR', 'ES', 'IT', 'GB'][Math.floor(Math.random() * 5)];
                        var checkDigits = Math.floor(Math.random() * 90) + 10;
                        var bankCode = Math.floor(Math.random() * 90000000) + 10000000;
                        return countryCode + checkDigits + bankCode;
                    }
                default: // credit-card
                    // Use fallback if function doesn't exist
                    var cardNumber;
                    if (window.faker.finance.creditCardNumber) {
                        cardNumber = window.faker.finance.creditCardNumber();
                    } else {
                        // Generate simple credit card number fallback
                        var prefixes = ['4', '5', '37', '6'];
                        var prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
                        cardNumber = prefix;
                        while (cardNumber.length < 16) {
                            cardNumber += Math.floor(Math.random() * 10);
                        }
                        cardNumber = cardNumber.substring(0, 16);
                    }
                    
                    // Format credit card number with spaces every 4 digits
                    return cardNumber.replace(/(.{4})/g, '$1 ').trim();
            }
            
        // TEXT
        case 'person':
            var type = config.personType || 'full-name';
            var prefix = config.customPrefix || '';
            var suffix = config.customSuffix || '';
            
            var result = '';
            
            switch (type) {
                case 'first-name':
                    result = window.faker.person.firstName();
                    break;
                case 'last-name':
                    result = window.faker.person.lastName();
                    break;
                case 'username':
                    result = window.faker.internet.userName();
                    break;
                case 'gender':
                    result = window.faker.person.gender();
                    break;
                case 'job-title':
                    result = window.faker.person.jobTitle();
                    break;
                case 'password':
                    result = window.faker.internet.password();
                    break;
                default: // full-name
                    result = window.faker.person.fullName();
            }
            
            return prefix + result + suffix;
            
        case 'email':
            var provider = config.provider;
            
            if (provider && provider.trim() !== '') {
                return window.faker.internet.email({ provider: provider.trim() });
            }
            
            return window.faker.internet.email();
            
        case 'website':
            var domain = config.domain;
            var includeProtocol = config.includeProtocol !== false; // Default to true if not specified
            
            try {
                var generatedUrl;
                
                if (domain) {
                    // Get a base URL and replace the domain
                    var baseUrl = window.faker.internet.url();
                    // Replace the existing domain with the custom one
                    var urlParts = baseUrl.split('://');
                    var protocol = urlParts[0];
                    var domainPart = urlParts[1].split('/')[0];
                    var path = urlParts[1].substring(domainPart.length);
                    
                    if (includeProtocol) {
                        generatedUrl = protocol + '://' + window.faker.internet.domainWord() + domain + path;
                    } else {
                        generatedUrl = window.faker.internet.domainWord() + domain + path;
                    }
                } else {
                    var baseUrl = window.faker.internet.url();
                    if (includeProtocol) {
                        generatedUrl = baseUrl;
                    } else {
                        // Remove protocol from URL
                        generatedUrl = baseUrl.replace(/^https?:\/\//, '');
                    }
                }
                
                return generatedUrl;
            } catch (error) {
                // Fallback website generation
                var domains = ['.com', '.org', '.net', '.io', '.co'];
                var subdomains = ['www', 'app', 'blog', 'shop', 'store', 'news'];
                var words = ['tech', 'digital', 'creative', 'smart', 'future', 'global', 'rapid', 'blue', 'green', 'nova'];
                
                var subdomain = subdomains[Math.floor(Math.random() * subdomains.length)];
                var word = words[Math.floor(Math.random() * words.length)];
                var domainExt = domain || domains[Math.floor(Math.random() * domains.length)];
                
                var websiteUrl = subdomain + '.' + word + domainExt;
                
                if (includeProtocol) {
                    return 'https://' + websiteUrl;
                } else {
                    return websiteUrl;
                }
            }
            
        case 'location':
            var type = config.locationType || 'city';
            
            switch (type) {
                case 'country':
                    return window.faker.location.country();
                case 'full-address':
                    // Create full address with fallbacks
                    try {
                        return window.faker.location.streetAddress() + ', ' + window.faker.location.city() + ', ' + window.faker.location.state();
                    } catch (error) {
                        var streetNumbers = [123, 456, 789, 1001, 2345];
                        var streetNames = ['Main St', 'Oak Ave', 'First St', 'Park Dr', 'Elm St', 'Maple Ave', 'Cedar Ln', 'Pine St'];
                        var cities = ['Springfield', 'Franklin', 'Georgetown', 'Madison', 'Riverside'];
                        var states = ['CA', 'NY', 'TX', 'FL', 'IL'];
                        
                        var streetNum = streetNumbers[Math.floor(Math.random() * streetNumbers.length)];
                        var streetName = streetNames[Math.floor(Math.random() * streetNames.length)];
                        var city = cities[Math.floor(Math.random() * cities.length)];
                        var state = states[Math.floor(Math.random() * states.length)];
                        
                        return streetNum + ' ' + streetName + ', ' + city + ', ' + state;
                    }
                case 'street-address':
                    // Create street address with fallback
                    try {
                        return window.faker.location.streetAddress();
                    } catch (error) {
                        var streetNumbers = [123, 456, 789, 1001, 2345, 567, 890, 1234];
                        var streetNames = ['Main St', 'Oak Ave', 'First St', 'Park Dr', 'Elm St', 'Maple Ave', 'Cedar Ln', 'Pine St', 'Broad St', 'Church St'];
                        
                        var streetNum = streetNumbers[Math.floor(Math.random() * streetNumbers.length)];
                        var streetName = streetNames[Math.floor(Math.random() * streetNames.length)];
                        
                        return streetNum + ' ' + streetName;
                    }
                case 'zip-code':
                    // Create ZIP code with fallback
                    try {
                        return window.faker.location.zipCode();
                    } catch (error) {
                        var zip1 = Math.floor(Math.random() * 90000) + 10000; // 5-digit ZIP
                        return zip1.toString();
                    }
                case 'country-code':
                    // Create country code with fallback
                    try {
                        return window.faker.location.countryCode();
                    } catch (error) {
                        var countryCodes = ['US', 'CA', 'UK', 'DE', 'FR', 'IT', 'ES', 'JP', 'AU', 'BR', 'IN', 'CN', 'MX', 'AR', 'NL'];
                        return countryCodes[Math.floor(Math.random() * countryCodes.length)];
                    }
                case 'coordinates':
                    // Create coordinates with fallback
                    try {
                        return window.faker.location.latitude() + ', ' + window.faker.location.longitude();
                    } catch (error) {
                        var lat = (Math.random() * 180 - 90).toFixed(6); // -90 to 90
                        var lon = (Math.random() * 360 - 180).toFixed(6); // -180 to 180
                        return lat + ', ' + lon;
                    }
                default: // city
                    return window.faker.location.city();
            }
            
        case 'title':
            var type = config.titleType || 'post-title';
            
            switch (type) {
                case 'company-name':
                    return window.faker.company.name();
                case 'product-name':
                    return window.faker.commerce.productName();
                case 'food':
                    // Generate food names
                    var foods = ['Pizza Margherita', 'Chicken Caesar Salad', 'Beef Tacos', 'Salmon Teriyaki', 'Mushroom Risotto', 'Thai Green Curry', 'BBQ Pulled Pork', 'Vegetable Stir Fry', 'Chocolate Brownies', 'Apple Pie', 'Greek Gyros', 'Spaghetti Carbonara', 'Fish and Chips', 'Chicken Tikka Masala', 'French Onion Soup'];
                    return foods[Math.floor(Math.random() * foods.length)];
                case 'animal':
                    // Generate animal names with fallback
                    if (window.faker.animal && window.faker.animal.type) {
                        return window.faker.animal.type();
                    } else {
                        var animals = ['Lion', 'Tiger', 'Elephant', 'Giraffe', 'Zebra', 'Panda', 'Kangaroo', 'Dolphin', 'Eagle', 'Wolf', 'Bear', 'Fox', 'Rabbit', 'Deer', 'Monkey'];
                        return animals[Math.floor(Math.random() * animals.length)];
                    }
                case 'song-title':
                    // Generate song titles with a better format
                    var songTitles = ['Dancing in the Moonlight', 'Electric Dreams', 'Sunset Boulevard', 'City of Stars', 'Wild Horses', 'Purple Rain', 'Golden Hour', 'Sweet Caroline', 'Bohemian Rhapsody', 'Imagine Dragons', 'Perfect Storm', 'Counting Stars', 'Rolling in the Deep', 'Someone Like You', 'Shape of You'];
                    return songTitles[Math.floor(Math.random() * songTitles.length)];
                case 'music-artist':
                    // Generate music artist names
                    var artists = ['The Midnight Stars', 'Luna Echo', 'Electric Pulse', 'Neon Dreams', 'Acoustic Soul', 'Digital Symphony', 'Velvet Storm', 'Crystal Waters', 'Iron Mountain', 'Silver Moon', 'Golden Wave', 'Red Horizon', 'Blue Thunder', 'Green Valley', 'Purple Sky'];
                    return artists[Math.floor(Math.random() * artists.length)];
                case 'random-word':
                    // Generate random words
                    if (window.faker.lorem && window.faker.lorem.word) {
                        return window.faker.lorem.word();
                    } else {
                        var words = ['Innovation', 'Discovery', 'Adventure', 'Journey', 'Harmony', 'Serenity', 'Courage', 'Wisdom', 'Freedom', 'Balance', 'Energy', 'Passion', 'Growth', 'Success', 'Wonder'];
                        return words[Math.floor(Math.random() * words.length)];
                    }
                default: // post-title
                    // Use post titles from cached longTexts data
                    if (window.longTextsData && window.longTextsData.post_titles) {
                        return getUniqueFromBatch(window.longTextsData.post_titles, 'post-title');
                    }
                    // Fallback to simple titles
                    return window.faker.lorem.sentence();
            }
            
        case 'long_text':
            var category = config.textCategory || 'any';
            
            // Load data from longTexts.json via cached data
            if (window.longTextsData) {
                // Use cached data
                var longTexts = window.longTextsData;
                
                if (category === 'any') {
                    // Exclude post_titles from "any category" - they should only be used for Title > Post title
                    var longTextCategories = ['technology', 'biography', 'history', 'nature', 'medicine'];
                    var allTexts = [];
                    for (var i = 0; i < longTextCategories.length; i++) {
                        var cat = longTextCategories[i];
                        if (longTexts[cat]) {
                            allTexts = allTexts.concat(longTexts[cat]);
                        }
                    }
                    return getUniqueFromBatch(allTexts, 'any');
                }
                
                var categoryTexts = longTexts[category];
                if (categoryTexts) {
                    return getUniqueFromBatch(categoryTexts, category);
                }
            }
            
            // Fallback if no data available
            return window.faker.lorem.paragraphs(2);
            
        // MEDIA
        case 'avatar':
            var type = config.avatarType || 'any';
            
            switch (type) {
                case 'real-people':
                    // Use existing RandomUser function logic
                    var gender = Math.random() > 0.5 ? 'men' : 'women';
                    var id = Math.floor(Math.random() * 99) + 1;
                    return 'https://randomuser.me/api/portraits/' + gender + '/' + id + '.jpg';
                case 'male':
                    var id = Math.floor(Math.random() * 99) + 1;
                    return 'https://randomuser.me/api/portraits/men/' + id + '.jpg';
                case 'female':
                    var id = Math.floor(Math.random() * 99) + 1;
                    return 'https://randomuser.me/api/portraits/women/' + id + '.jpg';
                case 'robots':
                    var seed = Math.random().toString(36).substring(7);
                    return 'https://robohash.org/' + seed + '.png?size=200x200&set=set1';
                case 'cartoon':
                    var seed = Math.random().toString(36).substring(7);
                    return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + seed + '&size=200&backgroundColor=transparent';
                default: // any
                    var types = ['real-people', 'robots', 'cartoon'];
                    var randomType = types[Math.floor(Math.random() * types.length)];
                    // Directly generate based on type to avoid recursion
                    switch (randomType) {
                        case 'real-people':
                            var gender = Math.random() > 0.5 ? 'men' : 'women';
                            var id = Math.floor(Math.random() * 99) + 1;
                            return 'https://randomuser.me/api/portraits/' + gender + '/' + id + '.jpg';
                        case 'robots':
                            var seed = Math.random().toString(36).substring(7);
                            return 'https://robohash.org/' + seed + '.png?size=200x200&set=set1';
                        case 'cartoon':
                            var seed = Math.random().toString(36).substring(7);
                            return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + seed + '&size=200&backgroundColor=transparent';
                    }
            }
            
        case 'image':
            var category = config.imageCategory || 'any';
            
            switch (category) {
                case 'products':
                    return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
                case 'landscapes':
                    return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
                default: // any
                    return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
            }
            
        case 'color':
            var type = config.colorType || 'solid';
            
            // Generate random RGB color manually since faker.color.rgb() might not be available
            function generateRandomColor() {
                var r = Math.floor(Math.random() * 256);
                var g = Math.floor(Math.random() * 256);
                var b = Math.floor(Math.random() * 256);
                return 'rgb(' + r + ', ' + g + ', ' + b + ')';
            }
            
            if (type === 'gradient') {
                var color1 = generateRandomColor();
                var color2 = generateRandomColor();
                return 'linear-gradient(45deg, ' + color1 + ', ' + color2 + ')';
            }
            
            return generateRandomColor();
            
        // Legacy data types for backward compatibility
        case 'name':
            return window.faker.person.fullName();
        case 'username':
            return window.faker.internet.userName();
        case 'city':
            return window.faker.location.city();
        case 'country':
            return window.faker.location.country();
        case 'company':
            return window.faker.company.name();
        case 'email':
            return window.faker.internet.email();
        case 'product_name':
            return window.faker.commerce.productName();
        case 'post_title':
            return window.faker.lorem.sentence();
        case 'description':
            return window.faker.lorem.paragraph();
        case 'lorem':
            return window.faker.lorem.words();
        case 'integer':
            return generateCustomInteger();
        case 'decimal':
            return window.faker.number.float({ min: 0, max: 100, fractionDigits: 2 });
        case 'currency':
            return '$' + window.faker.finance.amount();
        case 'date':
            return window.faker.date.anytime().toLocaleDateString();
        case 'phone':
            return window.faker.phone.number();
        case 'percentage':
            return window.faker.number.int({ min: 0, max: 100 }) + '%';
        case 'avatar_dicebear':
            return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + window.faker.string.uuid() + '&size=200&backgroundColor=transparent';
        case 'image_picsum':
            return 'https://picsum.photos/400/300?random=' + window.faker.number.int({ min: 1, max: 1000 });
            
        default:
            return 'Data type not supported: ' + dataTypeId;
    }
}

// Apply sorting to data array based on sorting type and data type
function applySorting(data, sortingType, dataTypeId) {
    if (sortingType === 'random' || !sortingType) {
        return data; // Already random
    }
    
    var sortedData = data.slice(); // Create a copy
    
    switch (sortingType) {
        case 'ascending':
            sortedData.sort(function(a, b) {
                // Check if values are numbers
                var numA = parseFloat(a.replace(/[^0-9.-]/g, ''));
                var numB = parseFloat(b.replace(/[^0-9.-]/g, ''));
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                
                // Text comparison
                return a.localeCompare(b);
            });
            break;
            
        case 'descending':
            sortedData.sort(function(a, b) {
                // Check if values are numbers
                var numA = parseFloat(a.replace(/[^0-9.-]/g, ''));
                var numB = parseFloat(b.replace(/[^0-9.-]/g, ''));
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numB - numA;
                }
                
                // Text comparison
                return b.localeCompare(a);
            });
            break;
            
        case 'a-z':
            sortedData.sort(function(a, b) {
                return a.localeCompare(b);
            });
            break;
            
        case 'z-a':
            sortedData.sort(function(a, b) {
                return b.localeCompare(a);
            });
            break;
            
        case 'recent':
            // For dates, sort by most recent
            if (dataTypeId === 'date') {
                sortedData.sort(function(a, b) {
                    // Check if it's a month name
                    var months = ['january', 'february', 'march', 'april', 'may', 'june', 
                                  'july', 'august', 'september', 'october', 'november', 'december'];
                    var monthsShort = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 
                                      'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    
                    var aLower = a.toLowerCase();
                    var bLower = b.toLowerCase();
                    
                    // Check for month names (December to January order for "recent")
                    var aMonthIndex = months.indexOf(aLower);
                    var bMonthIndex = months.indexOf(bLower);
                    if (aMonthIndex === -1) aMonthIndex = monthsShort.indexOf(aLower);
                    if (bMonthIndex === -1) bMonthIndex = monthsShort.indexOf(bLower);
                    
                    if (aMonthIndex !== -1 && bMonthIndex !== -1) {
                        // For months, recent = December to January (reverse month order)
                        return (11 - bMonthIndex) - (11 - aMonthIndex);
                    }
                    
                    // Check for weekday names
                    var weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    var weekdaysShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                    
                    var aWeekIndex = weekdays.indexOf(aLower);
                    var bWeekIndex = weekdays.indexOf(bLower);
                    if (aWeekIndex === -1) aWeekIndex = weekdaysShort.indexOf(aLower);
                    if (bWeekIndex === -1) bWeekIndex = weekdaysShort.indexOf(bLower);
                    
                    if (aWeekIndex !== -1 && bWeekIndex !== -1) {
                        // For weekdays, recent = Sunday to Monday (normal order)
                        return aWeekIndex - bWeekIndex;
                    }
                    
                    // For full dates, parse and sort newest to oldest
                    var dateA = new Date(a);
                    var dateB = new Date(b);
                    if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                        return dateB - dateA; // Newest first
                    }
                    
                    // For year strings, sort highest to lowest
                    var yearA = parseInt(a);
                    var yearB = parseInt(b);
                    if (!isNaN(yearA) && !isNaN(yearB)) {
                        return yearB - yearA;
                    }
                    
                    return 0;
                });
            }
            break;
            
        case 'oldest':
            // For dates, sort by oldest
            if (dataTypeId === 'date') {
                sortedData.sort(function(a, b) {
                    // Check if it's a month name
                    var months = ['january', 'february', 'march', 'april', 'may', 'june', 
                                  'july', 'august', 'september', 'october', 'november', 'december'];
                    var monthsShort = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 
                                      'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    
                    var aLower = a.toLowerCase();
                    var bLower = b.toLowerCase();
                    
                    // Check for month names (January to December order for "oldest")
                    var aMonthIndex = months.indexOf(aLower);
                    var bMonthIndex = months.indexOf(bLower);
                    if (aMonthIndex === -1) aMonthIndex = monthsShort.indexOf(aLower);
                    if (bMonthIndex === -1) bMonthIndex = monthsShort.indexOf(bLower);
                    
                    if (aMonthIndex !== -1 && bMonthIndex !== -1) {
                        // For months, oldest = January to December (normal month order)
                        return aMonthIndex - bMonthIndex;
                    }
                    
                    // Check for weekday names
                    var weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    var weekdaysShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                    
                    var aWeekIndex = weekdays.indexOf(aLower);
                    var bWeekIndex = weekdays.indexOf(bLower);
                    if (aWeekIndex === -1) aWeekIndex = weekdaysShort.indexOf(aLower);
                    if (bWeekIndex === -1) bWeekIndex = weekdaysShort.indexOf(bLower);
                    
                    if (aWeekIndex !== -1 && bWeekIndex !== -1) {
                        // For weekdays, oldest = Monday to Sunday (reverse order)
                        return bWeekIndex - aWeekIndex;
                    }
                    
                    // For full dates, parse and sort oldest to newest
                    var dateA = new Date(a);
                    var dateB = new Date(b);
                    if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                        return dateA - dateB; // Oldest first
                    }
                    
                    // For year strings, sort lowest to highest
                    var yearA = parseInt(a);
                    var yearB = parseInt(b);
                    if (!isNaN(yearA) && !isNaN(yearB)) {
                        return yearA - yearB;
                    }
                    
                    return 0;
                });
            }
            break;
    }
    
    return sortedData;
}

// Set up preview functionality for custom numbers
function setupCustomNumberPreview(layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    function updatePreview() {
        try {
            var minInput = document.getElementById('min-' + cleanLayerName);
            var maxInput = document.getElementById('max-' + cleanLayerName);
            var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
            var formatInput = document.getElementById('format-' + cleanLayerName);
            var prefixInput = document.getElementById('prefix-' + cleanLayerName);
            var previewElement = document.getElementById('preview-' + cleanLayerName);
            
            if (!minInput || !maxInput || !decimalsInput || !formatInput || !prefixInput || !previewElement) {
                return;
            }
            
            var min = parseInt(minInput.value) || 1;
            var max = parseInt(maxInput.value) || 1000;
            var decimals = decimalsInput.checked;
            var format = formatInput.checked;
            var prefix = prefixInput.value || '';
            
            // Generate sample value
            var value = Math.random() * (max - min) + min;
            
            if (!decimals) {
                value = Math.floor(value);
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            var result = value.toString();
            
            if (format && value >= 1000) {
                result = value.toLocaleString();
            }
            
            if (decimals && !result.includes('.')) {
                result += '.00';
            }
            
            previewElement.textContent = prefix + result;
        } catch (error) {
            console.log('Preview update error:', error);
        }
    }
    
    // Set up event listeners with small delay to ensure elements exist
    setTimeout(function() {
        var minInput = document.getElementById('min-' + cleanLayerName);
        var maxInput = document.getElementById('max-' + cleanLayerName);
        var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
        var formatInput = document.getElementById('format-' + cleanLayerName);
        var prefixInput = document.getElementById('prefix-' + cleanLayerName);
        
        if (minInput) minInput.addEventListener('input', updatePreview);
        if (maxInput) maxInput.addEventListener('input', updatePreview);
        if (decimalsInput) decimalsInput.addEventListener('change', updatePreview);
        if (formatInput) formatInput.addEventListener('change', updatePreview);
        if (prefixInput) prefixInput.addEventListener('input', updatePreview);
        
        // Initial preview update
        updatePreview();
    }, 100);
}

// Get configuration for a layer based on UI inputs
function getConfigForLayer(dataTypeId, layerName) {
    var config = {};
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    // Get values from UI elements if they exist
    var minInput = document.getElementById('min-' + cleanLayerName);
    var maxInput = document.getElementById('max-' + cleanLayerName);
    var decimalsInput = document.getElementById('decimals-' + cleanLayerName);
    var formatInput = document.getElementById('format-' + cleanLayerName);
    var prefixInput = document.getElementById('prefix-' + cleanLayerName);
    var sortInput = document.getElementById('sort-' + cleanLayerName);
    var phoneFormatInput = document.getElementById('phoneFormat-' + cleanLayerName);
    var dateFormatInput = document.getElementById('dateFormat-' + cleanLayerName);
    var financeTypeInput = document.getElementById('financeType-' + cleanLayerName);
    var personTypeInput = document.getElementById('personType-' + cleanLayerName);
    var customPrefixInput = document.getElementById('customPrefix-' + cleanLayerName);
    var customSuffixInput = document.getElementById('customSuffix-' + cleanLayerName);
    var providerInput = document.getElementById('provider-' + cleanLayerName);
    var domainInput = document.getElementById('domain-' + cleanLayerName);
    var includeProtocolInput = document.getElementById('includeProtocol-' + cleanLayerName);
    var locationTypeInput = document.getElementById('locationType-' + cleanLayerName);
    var titleTypeInput = document.getElementById('titleType-' + cleanLayerName);
    var textCategoryInput = document.getElementById('textCategory-' + cleanLayerName);
    var avatarTypeInput = document.getElementById('avatarType-' + cleanLayerName);
    var imageCategoryInput = document.getElementById('imageCategory-' + cleanLayerName);
    var colorTypeInput = document.getElementById('colorType-' + cleanLayerName);
    
    if (minInput) config.min = parseInt(minInput.value) || 1;
    if (maxInput) config.max = parseInt(maxInput.value) || 1000;
    if (decimalsInput) config.decimals = decimalsInput.checked;
    if (formatInput) config.format = formatInput.checked;
    if (prefixInput) config.prefix = prefixInput.value || '';
    if (sortInput) config.sorting = sortInput.value || 'random';
    if (phoneFormatInput) config.phoneFormat = phoneFormatInput.value || 'human';
    if (dateFormatInput) config.dateFormat = dateFormatInput.value || 'MM/DD/YYYY';
    if (financeTypeInput) config.financeType = financeTypeInput.value || 'credit-card';
    if (personTypeInput) config.personType = personTypeInput.value || 'full-name';
    if (customPrefixInput) config.customPrefix = customPrefixInput.value || '';
    if (customSuffixInput) config.customSuffix = customSuffixInput.value || '';
    if (providerInput) config.provider = providerInput.value || '';
    if (domainInput) config.domain = domainInput.value || '';
    if (includeProtocolInput) config.includeProtocol = includeProtocolInput.checked;
    if (locationTypeInput) config.locationType = locationTypeInput.value || 'city';
    if (titleTypeInput) config.titleType = titleTypeInput.value || 'post-title';
    if (textCategoryInput) config.textCategory = textCategoryInput.value || 'any';
    if (avatarTypeInput) config.avatarType = avatarTypeInput.value || 'any';
    if (imageCategoryInput) config.imageCategory = imageCategoryInput.value || 'any';
    if (colorTypeInput) config.colorType = colorTypeInput.value || 'solid';
    
    return config;
}

// ... existing code ...

// Load image data using fetch with CORS workarounds
function loadImageData(imageUrl) {
    console.log('🔄 Loading image from URL:', imageUrl);
    
    return tryImageWithCorsWorkarounds(imageUrl);
}

// Try multiple methods to load images with CORS workarounds
function tryImageWithCorsWorkarounds(imageUrl) {
    return new Promise(function(resolve) {
        // Method 1: Direct fetch
        console.log('🔄 Image Method 1: Direct fetch...');
        fetch(imageUrl)
            .then(function(response) {
                if (!response.ok) throw new Error('Direct fetch failed: ' + response.status);
                return response.arrayBuffer();
            })
            .then(function(arrayBuffer) {
                console.log('✅ Image Method 1 SUCCESS: Direct fetch worked!');
                resolve(new Uint8Array(arrayBuffer));
            })
            .catch(function(error) {
                console.log('❌ Image Method 1 failed:', error.message);
                
                // Method 2: Try with no-cors mode (for some services)
                console.log('🔄 Image Method 2: Trying no-cors mode...');
                fetch(imageUrl, { mode: 'no-cors' })
                    .then(function(response) {
                        // no-cors mode returns opaque response, we can't read the body
                        // but we can at least check if the request succeeded
                        if (response.type === 'opaque') {
                            // For no-cors, we can't get the actual image data
                            // So we'll try a CORS proxy instead
                            throw new Error('No-cors mode returned opaque response');
                        }
                        return response.arrayBuffer();
                    })
                    .then(function(arrayBuffer) {
                        console.log('✅ Image Method 2 SUCCESS: No-cors mode worked!');
                        resolve(new Uint8Array(arrayBuffer));
                    })
                    .catch(function(noCorsError) {
                        console.log('❌ Image Method 2 failed:', noCorsError.message);
                        
                        // Method 3: Try with CORS proxy
                        console.log('🔄 Image Method 3: Trying CORS proxy...');
                        var proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(imageUrl);
                        fetch(proxyUrl)
                            .then(function(response) {
                                if (!response.ok) throw new Error('CORS proxy failed: ' + response.status);
                                return response.arrayBuffer();
                            })
                            .then(function(arrayBuffer) {
                                console.log('✅ Image Method 3 SUCCESS: CORS proxy worked!');
                                resolve(new Uint8Array(arrayBuffer));
                            })
                            .catch(function(proxyError) {
                                console.log('❌ Image Method 3 failed:', proxyError.message);
                                
                                // Method 4: Generate a fallback based on the original URL type
                                console.log('🔄 Image Method 4: Generating fallback...');
                                var fallbackUrl;
                                
                                                                 if (imageUrl.includes('randomuser.me') || imageUrl.includes('ui-avatars.com') || imageUrl.includes('pravatar.cc') || imageUrl.includes('multiavatar.com') || imageUrl.includes('robohash.org')) {
                                     // Avatar fallback
                                     fallbackUrl = 'https://api.dicebear.com/7.x/avataaars/png?seed=' + Math.random().toString(36).substring(7) + '&size=200&backgroundColor=transparent';
                                 } else {
                                     // General image fallback
                                     fallbackUrl = 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000);
                                 }
                                
                                fetch(fallbackUrl)
                                    .then(function(response) {
                                        if (!response.ok) throw new Error('Fallback failed');
                                        return response.arrayBuffer();
                                    })
                                    .then(function(arrayBuffer) {
                                        console.log('✅ Image Method 4 SUCCESS: Fallback image loaded!');
                                        resolve(new Uint8Array(arrayBuffer));
                                    })
                                    .catch(function(fallbackError) {
                                        console.log('❌ Image Method 4 failed:', fallbackError.message);
                                        console.error('❌ All image loading methods failed for:', imageUrl);
                                        resolve(null);
                                    });
                            });
                    });
            });
    });
}

// Note: Theme colors are automatically handled by Figma when themeColors: true is set
// Figma will inject CSS variables and add figma-light/figma-dark classes automatically

// Google Sheets Sync functionality
var syncMappings = [];
var sheetColumns = [];
var sheetDataPreview = [];

// Get DOM elements for sync functionality
var syncSheetButton = document.getElementById('sync-sheet-button');
var syncText = document.getElementById('sync-text');
var syncLoading = document.getElementById('sync-loading');
var sheetUrlInput = document.getElementById('sheet-url-input');
var sheetPreviewContainer = document.getElementById('sheet-preview-container');
var syncMappingsContainer = document.getElementById('sync-mappings-container');
var syncApplySection = document.getElementById('sync-apply-section');
var syncApplyButton = document.getElementById('sync-apply-button');
var syncApplyText = document.getElementById('sync-apply-text');
var syncApplyLoading = document.getElementById('sync-apply-loading');
var clearSyncButton = document.getElementById('clear-sync-button');

// Event listeners for sync functionality
if (syncSheetButton) {
    syncSheetButton.addEventListener('click', function() {
        var sheetUrl = sheetUrlInput.value.trim();
        if (!sheetUrl) {
            showStatusMessage('Please enter a Google Sheets URL', 'error');
            return;
        }
        
        setLoadingState(syncSheetButton, syncText, syncLoading, true);
        parent.postMessage({
            pluginMessage: {
                type: 'sync-google-sheet',
                data: { sheetUrl: sheetUrl }
            }
        }, '*');
    });
}

if (syncApplyButton) {
    syncApplyButton.addEventListener('click', function() {
        var mappings = [];
        
        // Collect mappings from UI
        var syncMappingItems = syncMappingsContainer.querySelectorAll('.sync-mapping-item');
        syncMappingItems.forEach(function(item) {
            var layerName = item.dataset.layerName;
            var columnSelect = item.querySelector('.column-select');
            if (columnSelect && columnSelect.value) {
                mappings.push({
                    layerName: layerName,
                    columnName: columnSelect.value
                });
            }
        });
        
        if (mappings.length === 0) {
            showStatusMessage('Please select at least one column mapping', 'error');
            return;
        }
        
        setLoadingState(syncApplyButton, syncApplyText, syncApplyLoading, true);
        parent.postMessage({
            pluginMessage: {
                type: 'apply-sheet-data',
                data: { mappings: mappings }
            }
        }, '*');
    });
}

if (clearSyncButton) {
    clearSyncButton.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear the saved sync data for this document?')) {
            parent.postMessage({
                pluginMessage: {
                    type: 'clear-sync-data'
                }
            }, '*');
        }
    });
}

// Render sheet preview in dedicated container
function renderSheetPreview(columns, dataPreview) {
    if (!sheetPreviewContainer) return;
    
    var previewHtml = '<div class="sheet-preview">';
    previewHtml += '<div class="preview-table">';
    
    // Headers
    previewHtml += '<div class="preview-row header">';
    columns.forEach(function(col) {
        previewHtml += '<div class="preview-cell">' + escapeHtml(col) + '</div>';
    });
    previewHtml += '</div>';
    
    // Sample data row (just one)
    dataPreview.slice(0, 1).forEach(function(row) {
        previewHtml += '<div class="preview-row">';
        columns.forEach(function(col, index) {
            var cellValue = row[index] || '';
            previewHtml += '<div class="preview-cell">' + escapeHtml(cellValue.toString().substring(0, 20)) + '</div>';
        });
        previewHtml += '</div>';
    });
    
    previewHtml += '</div></div>';
    
    sheetPreviewContainer.innerHTML = previewHtml;
    sheetPreviewContainer.style.display = 'block';
}

// Hide sheet preview
function hideSheetPreview() {
    if (sheetPreviewContainer) {
        sheetPreviewContainer.style.display = 'none';
        sheetPreviewContainer.innerHTML = '';
    }
}

// Render sync mappings (without preview)
function renderSyncMappings(layers, columns, dataPreview) {
    console.log('🎨 Rendering sync mappings:', layers.length, 'layers,', columns.length, 'columns');
    
    syncMappings = layers;
    sheetColumns = columns;
    sheetDataPreview = dataPreview;
    
    // Render the preview in the dedicated container first
    renderSheetPreview(columns, dataPreview);
    
    if (layers.length === 0) {
        syncMappingsContainer.innerHTML = '<div class="empty-state">No layers with % prefixes found in selection.</div>';
        syncApplySection.style.display = 'none';
        return;
    }
    
    // Layer mappings only (no preview)
    var mappingsHtml = '';
    
    layers.forEach(function(layer) {
        mappingsHtml += '<div class="sync-mapping-item mapping-item" data-layer-name="' + escapeHtml(layer.layerName) + '">';
        mappingsHtml += '<div class="mapping-header">';
        mappingsHtml += '<div class="mapping-layer">';
        mappingsHtml += getLayerTypeIcon(layer.layerType);
        mappingsHtml += '<span class="layer-name">' + escapeHtml(layer.layerName) + '</span>';
        mappingsHtml += '</div>';
        mappingsHtml += '<div class="mapping-select">';
        mappingsHtml += '<select class="column-select column-select-simple">';
        mappingsHtml += '<option value="">Select column...</option>';
        columns.forEach(function(col) {
            mappingsHtml += '<option value="' + escapeHtml(col) + '">' + escapeHtml(col) + '</option>';
        });
        mappingsHtml += '</select>';
        mappingsHtml += '<button class="remove-btn sync-remove-btn" onclick="handleSyncRemoveMapping(\'' + layer.layerName.replace(/'/g, "\\'") + '\')" style="display: flex;">';
        mappingsHtml += '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">';
        mappingsHtml += '<g clip-path="url(#clip0_828_6358)">';
        mappingsHtml += '<path d="M8 0.833008C11.9578 0.833184 15.1658 4.04224 15.166 8C15.1658 11.9578 11.9578 15.1658 8 15.166C4.04224 15.1658 0.833184 11.9578 0.833008 8C0.833206 4.04225 4.04225 0.833206 8 0.833008ZM8 1.83301C4.59453 1.83321 1.83321 4.59453 1.83301 8C1.83318 11.4055 4.59452 14.1658 8 14.166C11.4055 14.1658 14.1658 11.4055 14.166 8C14.1658 4.59452 11.4055 1.83318 8 1.83301ZM9.64648 5.64648C9.84175 5.45122 10.1583 5.45122 10.3535 5.64648C10.5487 5.84175 10.5488 6.15827 10.3535 6.35352L8.70703 8L10.3535 9.64648L10.418 9.72461C10.5461 9.91868 10.5244 10.1827 10.3535 10.3535C10.1827 10.5244 9.91868 10.5461 9.72461 10.418L9.64648 10.3535L8 8.70703L6.35352 10.3535C6.15827 10.5488 5.84175 10.5487 5.64648 10.3535C5.45122 10.1583 5.45122 9.84175 5.64648 9.64648L7.29297 8L5.64648 6.35352C5.45122 6.15825 5.45122 5.84175 5.64648 5.64648C5.84175 5.45122 6.15825 5.45122 6.35352 5.64648L8 7.29297L9.64648 5.64648Z" />';
        mappingsHtml += '</g>';
        mappingsHtml += '<defs>';
        mappingsHtml += '<clipPath id="clip0_828_6358">';
        mappingsHtml += '<rect width="16" height="16" />';
        mappingsHtml += '</clipPath>';
        mappingsHtml += '</defs>';
        mappingsHtml += '</svg>';
        mappingsHtml += '</button>';
        mappingsHtml += '</div>';
        mappingsHtml += '</div>';
        mappingsHtml += '</div>';
    });
    
    syncMappingsContainer.innerHTML = mappingsHtml;
    
    // Show apply section
    syncApplySection.style.display = 'block';
    
    // Add change listeners to enable/disable apply button and manage remove button visibility
    var columnSelects = syncMappingsContainer.querySelectorAll('.column-select');
    columnSelects.forEach(function(select) {
        select.addEventListener('change', function() {
            updateSyncApplyButtonState();
            updateSyncRemoveButtonVisibility(select);
            // Don't call updateApplyButtonTooltips here - let license system handle it
        });
        // Initialize remove button visibility
        updateSyncRemoveButtonVisibility(select);
    });
    
    // Force clear any existing inline styles first
    syncApplyButton.style.removeProperty('opacity');
    syncApplyButton.style.removeProperty('pointer-events');
    syncApplyButton.style.removeProperty('cursor');
    syncApplyButton.style.removeProperty('background-color');
    syncApplyButton.style.removeProperty('background');
    
    // Set initial button state - tooltips handled by license system
    updateSyncApplyButtonState();
}

function updateSyncApplyButtonState() {
    // Don't disable the button based on column selections - let the tooltip system handle restrictions
    // The button will only be disabled by quota limitations in updateButtonTooltip()
    var hasSelections = Array.from(syncMappingsContainer.querySelectorAll('.column-select')).some(function(select) {
        return select.value !== '';
    });
    // We still track hasSelections for potential validation logic, but don't disable the button
}

// Update sync remove button visibility based on column selection
function updateSyncRemoveButtonVisibility(select) {
    var syncMappingItem = select.closest('.sync-mapping-item');
    if (!syncMappingItem) return;
    
    var removeBtn = syncMappingItem.querySelector('.sync-remove-btn');
    if (!removeBtn) return;
    
    // Show remove button when no column is selected, hide when column is selected
    if (select.value === '') {
        removeBtn.style.display = 'flex';
    } else {
        removeBtn.style.display = 'none';
    }
}

// Handle sync mapping removal
function handleSyncRemoveMapping(layerName) {
    console.log('🗑️ Removing sync mapping for layer:', layerName);
    
    // Preserve current column selections before removing and re-rendering
    var currentSelections = {};
    var columnSelects = syncMappingsContainer.querySelectorAll('.column-select');
    columnSelects.forEach(function(select) {
        var mappingItem = select.closest('.sync-mapping-item');
        if (mappingItem) {
            var layerNameElement = mappingItem.querySelector('.layer-name');
            if (layerNameElement && layerNameElement.textContent !== layerName) {
                currentSelections[layerNameElement.textContent] = select.value;
            }
        }
    });
    
    // Remove from syncMappings array
    syncMappings = syncMappings.filter(function(mapping) {
        return mapping.layerName !== layerName;
    });
    
    // Re-render the sync mappings
    renderSyncMappings(syncMappings, sheetColumns, sheetDataPreview);
    
    // Restore the column selections
    restoreSyncColumnSelections(currentSelections);
    
    // Show status message
    showStatusMessage('Layer removed from sync mappings');
    
    console.log('✅ Sync mapping removed for layer:', layerName);
}

// Restore column selections after re-rendering sync mappings
function restoreSyncColumnSelections(selections) {
    console.log('🔄 Restoring sync column selections:', selections);
    
    for (var layerName in selections) {
        var selectedColumn = selections[layerName];
        if (selectedColumn) {
            // Find the sync mapping item for this layer
            var syncMappingItems = syncMappingsContainer.querySelectorAll('.sync-mapping-item');
            for (var i = 0; i < syncMappingItems.length; i++) {
                var item = syncMappingItems[i];
                var layerNameElement = item.querySelector('.layer-name');
                if (layerNameElement && layerNameElement.textContent === layerName) {
                    var columnSelect = item.querySelector('.column-select');
                    if (columnSelect) {
                        columnSelect.value = selectedColumn;
                        // Update remove button visibility for this restored selection
                        updateSyncRemoveButtonVisibility(columnSelect);
                    }
                    break;
                }
            }
        }
    }
    
    // Update apply button state after restoration
    updateSyncApplyButtonState();
    
    console.log('✅ Sync column selections restored');
}

// Helper function to escape HTML
function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Generate layer type icon for sync mappings (matching the main renderMappings function)
function getLayerTypeIcon(layerType) {
    var layerTypeIndicator = '';
    var layerTypeClass = '';
    
    switch (layerType) {
        case 'TEXT':
            layerTypeIndicator = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 1.5C9.76522 1.5 10.0195 1.60543 10.207 1.79297C10.3946 1.98051 10.5 2.23478 10.5 2.5V3.5C10.5 3.77614 10.2761 4 10 4C9.72386 4 9.5 3.77614 9.5 3.5V2.5H6.5V9.5H7.5C7.77614 9.5 8 9.72386 8 10C8 10.2761 7.77614 10.5 7.5 10.5H4.5C4.22386 10.5 4 10.2761 4 10C4 9.72386 4.22386 9.5 4.5 9.5H5.5V2.5H2.5V3.5C2.5 3.77614 2.27614 4 2 4C1.72386 4 1.5 3.77614 1.5 3.5V2.5C1.5 2.23478 1.60543 1.9805 1.79297 1.79297C1.9805 1.60543 2.23478 1.5 2.5 1.5H9.5Z" /></svg>';
            layerTypeClass = 'layer-type-text';
            break;
        case 'OTHER':
            layerTypeIndicator = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_781_4798)"><path d="M9.56445 6.89746C9.70003 6.65698 10.0056 6.57153 10.2461 6.70703L10.9961 7.12988H10.9971C11.1508 7.21709 11.2792 7.34436 11.3682 7.49707C11.457 7.64973 11.5039 7.82339 11.5039 8C11.5039 8.17681 11.4572 8.35113 11.3682 8.50391C11.2795 8.65602 11.151 8.78103 10.998 8.86816L10.999 8.86914L6.75 11.3018L6.75098 11.3027C6.52321 11.4342 6.26397 11.5037 6.00098 11.5039C5.73817 11.5039 5.47966 11.4339 5.25195 11.3027V11.3037L1.00195 8.86914V8.86816C0.849263 8.78108 0.7214 8.65576 0.632812 8.50391C0.543766 8.35109 0.496107 8.17687 0.496094 8C0.496108 7.8233 0.543934 7.64978 0.632812 7.49707C0.721868 7.3443 0.85006 7.21707 1.00391 7.12988H1.00488L1.75488 6.70703C1.99542 6.57177 2.30105 6.65698 2.43652 6.89746C2.57146 7.13779 2.48611 7.44257 2.24609 7.57812L1.49707 8L1.49902 8.00098L5.74902 10.4365L5.75098 10.4375C5.82677 10.481 5.91356 10.5039 6.00098 10.5039C6.08843 10.5037 6.17523 10.4812 6.25098 10.4375L6.25195 10.4365L10.502 8.00098L10.5029 8L9.75488 7.57812C9.5146 7.4426 9.42929 7.13791 9.56445 6.89746ZM6.00098 0.496094C6.2634 0.496255 6.52162 0.565341 6.74902 0.696289L10.9971 3.12988C11.1508 3.21709 11.2792 3.34436 11.3682 3.49707C11.457 3.64973 11.5039 3.82338 11.5039 4C11.5039 4.17681 11.4572 4.35112 11.3682 4.50391C11.2795 4.65602 11.151 4.78103 10.998 4.86816L10.999 4.86914L6.75 7.30176L6.75098 7.30273C6.52321 7.43423 6.26396 7.50374 6.00098 7.50391C5.73817 7.50391 5.47966 7.4339 5.25195 7.30273V7.30371L1.00195 4.86914V4.86816C0.84926 4.78108 0.721402 4.65576 0.632812 4.50391C0.543763 4.35108 0.496104 4.17687 0.496094 4C0.496106 3.8233 0.543935 3.64978 0.632812 3.49707C0.721867 3.34431 0.850067 3.21707 1.00391 3.12988L5.25195 0.696289V0.697266C5.47966 0.566101 5.73817 0.496094 6.00098 0.496094ZM6.00098 1.49609C5.9134 1.49609 5.82687 1.51978 5.75098 1.56348H5.74902L1.49902 3.99902L1.49707 4L1.49902 4.00098L5.74902 6.43652L5.75098 6.4375C5.82677 6.48104 5.91356 6.50391 6.00098 6.50391C6.08843 6.50375 6.17523 6.48123 6.25098 6.4375L6.25195 6.43652L10.502 4.00098L10.5039 4L10.502 3.99902L6.25195 1.56348H6.25098C6.17523 1.51975 6.08843 1.49626 6.00098 1.49609Z" /></g><defs><clipPath id="clip0_781_4798"><rect width="12" height="12" /></clipPath></defs></svg>';
            layerTypeClass = 'layer-type-image';
            break;
        case 'MIXED':
            layerTypeIndicator = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_781_4798)"><path d="M9.56445 6.89746C9.70003 6.65698 10.0056 6.57153 10.2461 6.70703L10.9961 7.12988H10.9971C11.1508 7.21709 11.2792 7.34436 11.3682 7.49707C11.457 7.64973 11.5039 7.82339 11.5039 8C11.5039 8.17681 11.4572 8.35113 11.3682 8.50391C11.2795 8.65602 11.151 8.78103 10.998 8.86816L10.999 8.86914L6.75 11.3018L6.75098 11.3027C6.52321 11.4342 6.26397 11.5037 6.00098 11.5039C5.73817 11.5039 5.47966 11.4339 5.25195 11.3027V11.3037L1.00195 8.86914V8.86816C0.849263 8.78108 0.7214 8.65576 0.632812 8.50391C0.543766 8.35109 0.496107 8.17687 0.496094 8C0.496108 7.8233 0.543934 7.64978 0.632812 7.49707C0.721868 7.3443 0.85006 7.21707 1.00391 7.12988H1.00488L1.75488 6.70703C1.99542 6.57177 2.30105 6.65698 2.43652 6.89746C2.57146 7.13779 2.48611 7.44257 2.24609 7.57812L1.49707 8L1.49902 8.00098L5.74902 10.4365L5.75098 10.4375C5.82677 10.481 5.91356 10.5039 6.00098 10.5039C6.08843 10.5037 6.17523 10.4812 6.25098 10.4375L6.25195 10.4365L10.502 8.00098L10.5029 8L9.75488 7.57812C9.5146 7.4426 9.42929 7.13791 9.56445 6.89746ZM6.00098 0.496094C6.2634 0.496255 6.52162 0.565341 6.74902 0.696289L10.9971 3.12988C11.1508 3.21709 11.2792 3.34436 11.3682 3.49707C11.457 3.64973 11.5039 3.82338 11.5039 4C11.5039 4.17681 11.4572 4.35112 11.3682 4.50391C11.2795 4.65602 11.151 4.78103 10.998 4.86816L10.999 4.86914L6.75 7.30176L6.75098 7.30273C6.52321 7.43423 6.26396 7.50374 6.00098 7.50391C5.73817 7.50391 5.47966 7.4339 5.25195 7.30273V7.30371L1.00195 4.86914V4.86816C0.84926 4.78108 0.721402 4.65576 0.632812 4.50391C0.543763 4.35108 0.496104 4.17687 0.496094 4C0.496106 3.8233 0.543935 3.64978 0.632812 3.49707C0.721867 3.34431 0.850067 3.21707 1.00391 3.12988L5.25195 0.696289V0.697266C5.47966 0.566101 5.73817 0.496094 6.00098 0.496094ZM6.00098 1.49609C5.9134 1.49609 5.82687 1.51978 5.75098 1.56348H5.74902L1.49902 3.99902L1.49707 4L1.49902 4.00098L5.74902 6.43652L5.75098 6.4375C5.82677 6.48104 5.91356 6.50391 6.00098 6.50391C6.08843 6.50375 6.17523 6.48123 6.25098 6.4375L6.25195 6.43652L10.502 4.00098L10.5039 4L10.502 3.99902L6.25195 1.56348H6.25098C6.17523 1.51975 6.08843 1.49626 6.00098 1.49609Z" /></g><defs><clipPath id="clip0_781_4798"><rect width="12" height="12" /></clipPath></defs></svg>';
            layerTypeClass = 'layer-type-mixed';
            break;
        default:
            layerTypeIndicator = '';
            layerTypeClass = '';
    }
    
    return '<span class="layer-type-indicator ' + layerTypeClass + '">' + layerTypeIndicator + '</span>';
}

// Listen for messages from the main plugin code
window.addEventListener('message', function(event) {
    var msg = event.data.pluginMessage;
    if (!msg) return;
    
    if (msg.type === 'layers-scanned') {
        setLoadingState(scanButton, scanText, scanLoading, false);
        hideSelectionScreen(); // Ensure selection screen is hidden after scan
        renderMappings(msg.data.mappings, msg.data.savedConfigurations, msg.data.detailedConfigurations);
        
        var preconfiguredCount = msg.data.mappings.filter(function(m) { return m.isPreConfigured; }).length;
        var statusMsg = 'Found ' + msg.data.mappings.length + ' layer mapping' + (msg.data.mappings.length > 1 ? 's' : '');
        if (preconfiguredCount > 0) {
            statusMsg += ' (' + preconfiguredCount + ' pre-configured)';
        }
        
        if (msg.data.mappings.length > 0) {
            showStatusMessage(statusMsg);
        } else {
            showStatusMessage('No layers with % prefixes found in selection', 'error');
        }
    } else if (msg.type === 'selection-changed') {
        // Show selection screen when layers are selected
        showSelectionScreen(msg.hasSelection);
        
        // Also update sync selection screen if it's active
        var currentTab = document.querySelector('.tab-button.active');
        if (currentTab && currentTab.getAttribute('data-tab') === 'sync' && !hasSyncedSheet) {
            showSyncSelectionScreen(msg.hasSelection);
        }
    } else if (msg.type === 'selection-state') {
        // Handle selection state for sync tab
        var currentTab = document.querySelector('.tab-button.active');
        if (currentTab && currentTab.getAttribute('data-tab') === 'sync' && !hasSyncedSheet) {
            showSyncSelectionScreen(msg.hasSelection);
        }
    } else if (msg.type === 'integer-settings-loaded') {
        // Restore integer settings from storage
        if (msg.data && Object.keys(msg.data).length > 0) {
            integerSettings = msg.data;
            console.log('📥 Integer settings restored:', integerSettings);
            // Populate the UI controls with loaded settings
            populateIntegerControlsFromSettings();
        }
    } else if (msg.type === 'mapping-removed') {
        currentMappings = currentMappings.filter(function(m) { return m.layerName !== msg.data.layerName; });
        renderMappings(currentMappings, {}, detailedConfigurations);
        showStatusMessage('Mapping removed');
    } else if (msg.type === 'data-applied') {
        setLoadingState(applyButton, applyText, applyLoading, false);
        hideProgressScreen();
        // showStatusMessage(msg.message); // Removed success message display
    } else if (msg.type === 'progress-update') {
        updateProgress(msg.completed, msg.total);
    } else if (msg.type === 'error') {
        setLoadingState(scanButton, scanText, scanLoading, false);
        setLoadingState(applyButton, applyText, applyLoading, false);
        setLoadingState(syncApplyButton, syncApplyText, syncApplyLoading, false);
        hideProgressScreen();
        showStatusMessage(msg.message, 'error');
    } else if (msg.type === 'long-texts-loaded') {
        // Store longTexts data globally for use in content generation
        window.longTextsData = msg.data;
        console.log('📥 LongTexts data loaded:', msg.data ? 'Successfully' : 'Failed');
    } else if (msg.type === 'generate-data') {
        // Generate data and send back to main code
        Promise.resolve(generateData(msg.dataTypeId, msg.count, msg.layerName))
            .then(function(data) {
                parent.postMessage({
                    pluginMessage: {
                        type: 'data-generated',
                        requestId: msg.requestId,
                        data: data
                    }
                }, '*');
            })
            .catch(function(error) {
                console.error('Data generation failed:', error);
                parent.postMessage({
                    pluginMessage: {
                        type: 'data-generated',
                        requestId: msg.requestId,
                        data: Array(msg.count).fill('Generation failed')
                    }
                }, '*');
            });
    } else if (msg.type === 'load-image') {
        // Load image and send back to main code
        console.log('📨 Received image load request:', msg.requestId, msg.url);
        loadImageData(msg.url)
            .then(function(imageData) {
                console.log('📤 Sending image data response:', msg.requestId, imageData ? 'Success' : 'Failed');
                parent.postMessage({
                    pluginMessage: {
                        type: 'image-loaded',
                        requestId: msg.requestId,
                        data: imageData
                    }
                }, '*');
            })
            .catch(function(error) {
                console.error('❌ Image loading failed:', error);
                parent.postMessage({
                    pluginMessage: {
                        type: 'image-loaded',
                        requestId: msg.requestId,
                        data: null
                    }
                }, '*');
            });
    } else if (msg.type === 'sheet-sync-complete') {
        // Google Sheets sync completed
        setLoadingState(syncSheetButton, syncText, syncLoading, false);
        hasSyncedSheet = true; // Mark that a sheet has been synced
        needsRescan = false; // Reset rescan flag since we just did a fresh sync
        hideSyncSelectionScreen(); // Hide the pre-sync screen
        renderSyncMappings(msg.data.layers, msg.data.columns, msg.data.dataPreview);
        showStatusMessage('Google Sheets synced successfully! Found ' + msg.data.layers.length + ' layer(s) and ' + msg.data.columns.length + ' column(s).');
    } else if (msg.type === 'sync-data-restored') {
        // Google Sheets sync data was restored from storage
        setLoadingState(syncSheetButton, syncText, syncLoading, false);
        
        // Keep hasSyncedSheet true to prevent selection screen, but set needsRescan flag
        hasSyncedSheet = true; // Keep true to prevent sync selection screen from showing
        needsRescan = true; // Force fresh scan instead of using cached mappings
        hideSyncSelectionScreen(); // Hide the pre-sync screen
        
        // Update the URL input with the saved URL for convenience
        if (sheetUrlInput && msg.data.url) {
            sheetUrlInput.value = msg.data.url;
        }
        
        // Show the sheet preview (keep this functionality)
        renderSheetPreview(msg.data.columns, msg.data.dataPreview);
        
        // Show "Rescan layers" message instead of cached layer mappings
        syncMappingsContainer.innerHTML = '<div class="empty-state" style="text-align: center; padding: 20px; color: var(--figma-color-text); opacity: 0.5; font-size: 11px">Re-scan layers to populate data.</div>';
        
        // Hide apply section until fresh scan
        syncApplySection.style.display = 'none';
        
        // Optional: Show a subtle status message
        showStatusMessage('Please re-scan layers to ensure data is up to date');
    } else if (msg.type === 'sync-data-cleared') {
        // Google Sheets sync data was cleared
        hasSyncedSheet = false;
        needsRescan = false; // Reset rescan flag
        if (sheetUrlInput) {
            sheetUrlInput.value = '';
        }
        hideSheetPreview();
        syncMappingsContainer.innerHTML = '<div class="empty-state">Paste a Google Sheets URL and click "Sync & Scan Layers" to get started</div>';
        syncApplySection.style.display = 'none';
        showStatusMessage(msg.message);
    } else if (msg.type === 'error') {
        // Handle errors and show them in sync selection screen if applicable
        var currentTab = document.querySelector('.tab-button.active');
        if (currentTab && currentTab.getAttribute('data-tab') === 'sync' && !hasSyncedSheet && msg.message.includes('Google Sheets')) {
            setLoadingState(syncSheetButton, syncText, syncLoading, false);
            showSyncUrlError(msg.message);
        }
    } else if (msg.type === 'license-status') {
        updateLicenseStatus(msg.data);
    } else if (msg.type === 'license-validation-result') {
        handleLicenseValidationResult(msg.data);
    } else if (msg.type === 'feature-blocked') {
        showStatusMessage(msg.data.message, 'error');
    } else if (msg.type === 'license-data-cleared') {
        console.log('License data cleared for testing');
        // Reset license status
        updateLicenseStatus({
            isLicensed: false,
            remainingUses: 15,
            canUse: true,
            quotaMessage: '15 requests left today. Get unlimited'
        });
    } else if (msg.type === 'verify-license') {
        // Handle license verification request from main thread
        verifyLicenseWithGumroad(msg.requestId, msg.licenseKey, msg.productId);
    } else if (msg.type === 'success') {
        // Success message (for sheet data applied)
        setLoadingState(syncApplyButton, syncApplyText, syncApplyLoading, false);
        showStatusMessage(msg.message);
    }
});

// Initialize everything on plugin load
window.addEventListener('load', function() {
    initializeTabs(); // Set up tab functionality
    
    // Initialize sync button state properly
    var syncApplyButton = document.getElementById('sync-apply-button');
    if (syncApplyButton) {
        // Start with button enabled - only quota limitations should disable it
        syncApplyButton.disabled = false;
        syncApplyButton.style.removeProperty('opacity');
        syncApplyButton.style.removeProperty('pointer-events');
        syncApplyButton.style.removeProperty('cursor');
        syncApplyButton.style.removeProperty('background-color');
        syncApplyButton.style.removeProperty('background');
    }
    
    initializeLicenseSystem(); // Set up license system
    // Don't show selection screen immediately - wait for initial selection state from backend
});
    </script>
</body>
</html> 