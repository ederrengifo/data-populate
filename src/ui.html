<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: #f8f9fa;
            font-size: 13px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .scan-button, .apply-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .scan-button {
            background: #0066ff;
            color: white;
        }

        .scan-button:hover {
            background: #0052cc;
        }

        .apply-button {
            background: #00aa00;
            color: white;
        }

        .apply-button:hover {
            background: #008800;
        }

        .apply-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mapping-item {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .layer-name {
            font-weight: 500;
            color: #1a1a1a;
        }

        .layer-count {
            color: #666;
            font-size: 12px;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .data-type-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .category-select, .type-select {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .type-select:disabled {
            background: #f8f9fa;
            color: #666;
        }

        .status-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .mappings-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Scan Section -->
        <div class="section">
            <div class="section-title">üîç Scan Layers</div>
            <button id="scan-button" class="scan-button">
                <span id="scan-text">Scan for % layers</span>
                <div id="scan-loading" class="loading-spinner" style="display: none;"></div>
            </button>
        </div>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Mappings Section -->
        <div class="section">
            <div class="section-title">üìù Layer Mappings</div>
            <div id="mappings-container" class="mappings-container">
                <div class="empty-state">
                    Click "Scan for % layers" to find layers that need data
                </div>
            </div>
        </div>

        <!-- Apply Section -->
        <div class="section">
            <div class="section-title">‚ú® Apply Data</div>
            <button id="apply-button" class="apply-button" disabled>
                <span id="apply-text">Apply Data to Layers</span>
                <div id="apply-loading" class="loading-spinner" style="display: none;"></div>
            </button>
        </div>
    </div>

    <!-- Embedded Faker.js Implementation for Figma Plugin -->
    <script>
        console.log('üöÄ Loading embedded Faker.js implementation...');
        
        // Create a minimal but functional Faker.js implementation
        window.faker = {
            person: {
                fullName: function() {
                    var firstNames = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra'];
                    var lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson'];
                    return firstNames[Math.floor(Math.random() * firstNames.length)] + ' ' + lastNames[Math.floor(Math.random() * lastNames.length)];
                },
                firstName: function() {
                    var names = ['James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'David', 'Elizabeth', 'William', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra'];
                    return names[Math.floor(Math.random() * names.length)];
                },
                lastName: function() {
                    var names = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson'];
                    return names[Math.floor(Math.random() * names.length)];
                }
            },
            location: {
                city: function() {
                    var cities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose', 'Austin', 'Jacksonville', 'Fort Worth', 'Columbus', 'Charlotte', 'San Francisco', 'Indianapolis', 'Seattle', 'Denver', 'Washington', 'Boston', 'El Paso', 'Nashville', 'Detroit', 'Oklahoma City', 'Portland', 'Las Vegas', 'Memphis', 'Louisville', 'Baltimore'];
                    return cities[Math.floor(Math.random() * cities.length)];
                },
                country: function() {
                    var countries = ['United States', 'Canada', 'Mexico', 'Brazil', 'Argentina', 'United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Russia', 'China', 'Japan', 'India', 'Australia', 'South Africa', 'Egypt', 'Nigeria', 'Kenya', 'Morocco', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Poland', 'Greece'];
                    return countries[Math.floor(Math.random() * countries.length)];
                },
                streetAddress: function() {
                    var streets = ['Main Street', 'First Street', 'Second Street', 'Third Street', 'Park Avenue', 'Oak Street', 'Pine Street', 'Maple Avenue', 'Cedar Street', 'Elm Street', 'Washington Street', 'Lake Street', 'Hill Street', 'Church Street', 'Sunset Boulevard', 'Broadway', 'Fifth Avenue', 'Madison Avenue', 'Lincoln Street', 'Jefferson Avenue'];
                    var number = Math.floor(Math.random() * 9999) + 1;
                    return number + ' ' + streets[Math.floor(Math.random() * streets.length)];
                }
            },
            internet: {
                email: function() {
                    var domains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'company.com', 'example.com', 'test.com', 'mail.com', 'email.com', 'service.com'];
                    var names = ['john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'mark', 'anna', 'chris', 'emma', 'alex', 'maria', 'james', 'laura', 'robert', 'helen', 'paul', 'kate', 'steve', 'amy'];
                    return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 999) + '@' + domains[Math.floor(Math.random() * domains.length)];
                },
                userName: function() {
                    var names = ['user', 'admin', 'guest', 'john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'mark', 'anna', 'chris', 'emma', 'alex', 'maria', 'james', 'laura', 'robert', 'helen', 'paul'];
                    return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 9999);
                }
            },
            company: {
                name: function() {
                    var companies = ['TechCorp', 'InnovateLtd', 'GlobalSolutions', 'DataSystems', 'CloudTech', 'DigitalWorks', 'SmartSolutions', 'TechVision', 'FutureWorks', 'NextGen', 'ProTech', 'EliteServices', 'PrimeTech', 'CoreSystems', 'MegaCorp', 'UltraTech', 'PowerSolutions', 'SpeedTech', 'FlexiCorp', 'DynamicSystems'];
                    return companies[Math.floor(Math.random() * companies.length)];
                }
            },
            commerce: {
                productName: function() {
                    var products = ['Smartphone', 'Laptop', 'Tablet', 'Headphones', 'Camera', 'Watch', 'Speaker', 'Monitor', 'Keyboard', 'Mouse', 'Printer', 'Scanner', 'Router', 'Hard Drive', 'Memory Card', 'Cable', 'Charger', 'Case', 'Stand', 'Dock'];
                    var adjectives = ['Smart', 'Pro', 'Ultra', 'Premium', 'Advanced', 'Digital', 'Wireless', 'Portable', 'Compact', 'High-Tech'];
                    return adjectives[Math.floor(Math.random() * adjectives.length)] + ' ' + products[Math.floor(Math.random() * products.length)];
                }
            },
            lorem: {
                sentence: function() {
                    var sentences = [
                        'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
                        'Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',
                        'Ut enim ad minim veniam, quis nostrud exercitation ullamco.',
                        'Duis aute irure dolor in reprehenderit in voluptate velit esse.',
                        'Excepteur sint occaecat cupidatat non proident, sunt in culpa.',
                        'Nulla facilisi morbi tempus iaculis urna id volutpat lacus.',
                        'Pellentesque habitant morbi tristique senectus et netus.',
                        'Mauris blandit aliquet elit, eget tincidunt nibh pulvinar.',
                        'Vestibulum ante ipsum primis in faucibus orci luctus.',
                        'Curabitur pretium tincidunt lacus nulla gravida orci.'
                    ];
                    return sentences[Math.floor(Math.random() * sentences.length)];
                },
                paragraph: function() {
                    var paragraphs = [
                        'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.',
                        'Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
                        'Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.',
                        'Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt neque porro quisquam est.',
                        'At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.'
                    ];
                    return paragraphs[Math.floor(Math.random() * paragraphs.length)];
                },
                words: function() {
                    var words = ['lorem', 'ipsum', 'dolor', 'sit', 'amet', 'consectetur', 'adipiscing', 'elit', 'sed', 'eiusmod', 'tempor', 'incididunt', 'labore', 'dolore', 'magna', 'aliqua', 'enim', 'minim', 'veniam', 'nostrud'];
                    var count = Math.floor(Math.random() * 5) + 3; // 3-7 words
                    var result = [];
                    for (var i = 0; i < count; i++) {
                        result.push(words[Math.floor(Math.random() * words.length)]);
                    }
                    return result.join(' ');
                }
            },
            number: {
                int: function(options) {
                    var min = (options && options.min !== undefined) ? options.min : 0;
                    var max = (options && options.max !== undefined) ? options.max : 100;
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                },
                float: function(options) {
                    var min = (options && options.min !== undefined) ? options.min : 0;
                    var max = (options && options.max !== undefined) ? options.max : 100;
                    var fractionDigits = (options && options.fractionDigits !== undefined) ? options.fractionDigits : 2;
                    var value = Math.random() * (max - min) + min;
                    return parseFloat(value.toFixed(fractionDigits));
                }
            },
            date: {
                anytime: function() {
                    var now = new Date();
                    var pastDays = Math.floor(Math.random() * 365 * 2); // Random date within 2 years
                    return new Date(now.getTime() - (pastDays * 24 * 60 * 60 * 1000));
                },
                recent: function() {
                    var now = new Date();
                    var daysAgo = Math.floor(Math.random() * 30);
                    return new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
                }
            },
            phone: {
                number: function() {
                    var formats = [
                        function() { return '+1-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return '(' + (Math.floor(Math.random() * 900) + 100) + ') ' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return (Math.floor(Math.random() * 900) + 100) + '.' + (Math.floor(Math.random() * 900) + 100) + '.' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 900) + 100) + '-' + (Math.floor(Math.random() * 9000) + 1000); },
                        function() { return '+44 ' + (Math.floor(Math.random() * 9000) + 1000) + ' ' + (Math.floor(Math.random() * 900000) + 100000); },
                        function() { return '+33 ' + (Math.floor(Math.random() * 9) + 1) + ' ' + (Math.floor(Math.random() * 90000000) + 10000000); },
                        function() { return '+49 ' + (Math.floor(Math.random() * 900) + 100) + ' ' + (Math.floor(Math.random() * 9000000) + 1000000); },
                        function() { return '+61 ' + (Math.floor(Math.random() * 9) + 1) + ' ' + (Math.floor(Math.random() * 90000000) + 10000000); }
                    ];
                    return formats[Math.floor(Math.random() * formats.length)]();
                }
            },
            finance: {
                amount: function() {
                    return (Math.random() * 999 + 1).toFixed(2);
                }
            }
        };
        
        // Set the loaded flag
        window.fakerLoaded = true;
        
        console.log('‚úÖ Embedded Faker.js successfully loaded!');
        console.log('Available modules:', Object.keys(window.faker));
        console.log('Sample test:', window.faker.person.fullName());
        
        // Emit ready event
        window.dispatchEvent(new CustomEvent('fakerReady', { detail: { faker: window.faker } }));
    </script>

    <script>
// Global variables
var currentMappings = [];
var scanButton = document.getElementById('scan-button');
var scanText = document.getElementById('scan-text');
var scanLoading = document.getElementById('scan-loading');
var applyButton = document.getElementById('apply-button');
var applyText = document.getElementById('apply-text');
var applyLoading = document.getElementById('apply-loading');
var mappingsContainer = document.getElementById('mappings-container');
var statusContainer = document.getElementById('status-container');

// Data type configurations with external APIs
var dataTypes = {
    text: [
        { id: 'name', label: 'üë§ Full Name', description: 'Random person names (faker.js)' },
        { id: 'username', label: 'üî§ Username', description: 'Random usernames (faker.js)' },
        { id: 'city', label: 'üèôÔ∏è City', description: 'Random city names (faker.js)' },
        { id: 'country', label: 'üåç Country', description: 'Random country names (faker.js)' },
        { id: 'company', label: 'üè¢ Company', description: 'Random company names (faker.js)' },
        { id: 'email', label: 'üìß Email', description: 'Random email addresses (faker.js)' },
        { id: 'product_name', label: 'üì¶ Product Name', description: 'Random product names (faker.js)' },
        { id: 'post_title', label: 'üì∞ Post Title', description: 'Random article titles (faker.js)' },
        { id: 'description', label: 'üìù Description', description: 'Random paragraphs (faker.js)' },
        { id: 'lorem', label: 'üìñ Lorem Ipsum', description: 'Random words (faker.js)' },
        { id: 'product_api', label: 'üõí Products', description: 'Real products (DummyJSON API)' },
        { id: 'user_api', label: 'üë• User Names', description: 'Real people (RandomUser API)' }
    ],
    number: [
        { id: 'integer', label: 'üî¢ Random Numbers', description: 'Random integers (faker.js)' },
        { id: 'decimal', label: 'üíØ Decimal Numbers', description: 'Random decimals (faker.js)' },
        { id: 'currency', label: 'üí∞ Currency', description: 'Random prices (faker.js)' },
        { id: 'date', label: 'üìÖ Random Dates', description: 'Random dates (faker.js)' },
        { id: 'phone', label: 'üìû Phone Numbers', description: 'Random phone numbers (faker.js)' },
        { id: 'percentage', label: 'üìä Percentages', description: 'Random percentages (faker.js)' }
    ],
    image: [
        { id: 'avatar_dicebear', label: 'üë§ Avatar (DiceBear)', description: 'Cartoon avatars - reliable ‚úÖ' },
        { id: 'avatar_randomuser', label: 'üë• Real People Photos', description: 'Actual photos with CORS proxy üîß' },
        { id: 'avatar_randomuser_male', label: 'üë® Male Photos', description: 'Real male photos (RandomUser + CORS proxy)' },
        { id: 'avatar_randomuser_female', label: 'üë© Female Photos', description: 'Real female photos (RandomUser + CORS proxy)' },
        { id: 'avatar_pravatar', label: 'üë§ Profile Avatars', description: 'Real profile photos (Pravatar + CORS proxy)' },
        { id: 'avatar_multiavatar', label: 'üé® Multiavatar', description: 'Unique generated avatars (CORS proxy)' },
        { id: 'avatar_robohash', label: 'ü§ñ Robot Avatars', description: 'Fun robot/monster avatars (CORS proxy)' },
        { id: 'image_picsum', label: 'üé≤ Random Images', description: 'Random photos (Picsum) - reliable ‚úÖ' },
        { id: 'product_image', label: 'üõçÔ∏è Product Images', description: 'Product photos (DummyJSON API)' },
        // Enhanced Unsplash categories using Picsum
        { id: 'unsplash_nature', label: 'üåø Nature Photos', description: 'Random nature photos' },
        { id: 'unsplash_people', label: 'üë• People Photos', description: 'Random portrait photos' },
        { id: 'unsplash_business', label: 'üíº Business Photos', description: 'Random business photos' },
        { id: 'unsplash_food', label: 'üçΩÔ∏è Food Photos', description: 'Random food photos' },
        { id: 'unsplash_travel', label: '‚úàÔ∏è Travel Photos', description: 'Random travel photos' },
        { id: 'unsplash_tech', label: 'üíª Tech Photos', description: 'Random tech photos' }
    ]
};

// Event listeners
scanButton.addEventListener('click', function() {
    setLoadingState(scanButton, scanText, scanLoading, true);
    parent.postMessage({ pluginMessage: { type: 'scan-layers' } }, '*');
});

applyButton.addEventListener('click', function() {
    if (currentMappings.length === 0) {
        showStatusMessage('No mappings to apply', 'error');
        return;
    }
    
    // Collect mappings with selected data types
    var mappingsToApply = [];
    for (var i = 0; i < currentMappings.length; i++) {
        var mapping = currentMappings[i];
        if (mapping.dataTypeId) {
            mappingsToApply.push({
                layerName: mapping.layerName,
                dataTypeId: mapping.dataTypeId
            });
        }
    }
    
    if (mappingsToApply.length === 0) {
        showStatusMessage('Please select data types for at least one mapping', 'error');
        return;
    }
    
    setLoadingState(applyButton, applyText, applyLoading, true);
    parent.postMessage({ 
        pluginMessage: { 
            type: 'apply-data', 
            mappings: mappingsToApply 
        } 
    }, '*');
});

// Utility functions
function setLoadingState(button, textElement, loadingElement, isLoading) {
    if (isLoading) {
        textElement.style.display = 'none';
        loadingElement.style.display = 'block';
        button.disabled = true;
    } else {
        textElement.style.display = 'block';
        loadingElement.style.display = 'none';
        button.disabled = false;
    }
}

function showStatusMessage(message, type) {
    var messageDiv = document.createElement('div');
    messageDiv.className = 'status-message status-' + (type || 'success');
    messageDiv.textContent = message;
    
    statusContainer.innerHTML = '';
    statusContainer.appendChild(messageDiv);
    
    setTimeout(function() {
        if (statusContainer.contains(messageDiv)) {
            statusContainer.removeChild(messageDiv);
        }
    }, 5000);
}

// Get available categories based on layer type
function getAvailableCategoriesForLayerType(layerType) {
    switch (layerType) {
        case 'TEXT':
            return ['text', 'number']; // Text layers get text and number options
        case 'OTHER':
            return ['image']; // Non-text layers get image options
        case 'MIXED':
            return ['text', 'number', 'image']; // Mixed layers get all options
        default:
            return ['text', 'number', 'image']; // Default fallback
    }
}

// Auto-populate a mapping with saved configuration
function autoPopulateMapping(layerName, dataTypeId, layerType) {
    // Find the mapping item in DOM
    var mappingItems = document.querySelectorAll('.mapping-item');
    var targetItem = null;
    
    for (var i = 0; i < mappingItems.length; i++) {
        var item = mappingItems[i];
        var nameElement = item.querySelector('.layer-name');
        if (nameElement && nameElement.textContent === layerName) {
            targetItem = item;
            break;
        }
    }
    
    if (!targetItem) return;
    
    // Determine which category this dataTypeId belongs to
    var category = null;
    for (var cat in dataTypes) {
        for (var j = 0; j < dataTypes[cat].length; j++) {
            if (dataTypes[cat][j].id === dataTypeId) {
                category = cat;
                break;
            }
        }
        if (category) break;
    }
    
    if (!category) return;
    
    // Set the category dropdown
    var categorySelect = targetItem.querySelector('.category-select');
    if (categorySelect) {
        categorySelect.value = category;
        
        // Trigger the category change to populate type dropdown
        handleCategoryChange(layerName, category);
        
        // Set the type dropdown
        setTimeout(function() {
            var typeSelect = targetItem.querySelector('.type-select');
            if (typeSelect) {
                typeSelect.value = dataTypeId;
                handleTypeChange(layerName, dataTypeId);
                
                // Show integer controls if this is an integer type
                if (dataTypeId === 'integer') {
                    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
                    var integerControls = document.getElementById('integer-controls-' + cleanLayerName);
                    if (integerControls) {
                        integerControls.style.display = 'block';
                        
                        // Populate controls with saved settings if available
                        setTimeout(function() {
                            populateIntegerControlsFromSettings();
                        }, 100);
                    }
                }
            }
        }, 50); // Small delay to ensure category change has processed
    }
}

function renderMappings(mappings, savedConfigurations) {
    currentMappings = mappings;
    savedConfigurations = savedConfigurations || {};
    
    if (mappings.length === 0) {
        mappingsContainer.innerHTML = '<div class="empty-state">No layers with % prefixes found</div>';
        applyButton.disabled = true;
        return;
    }
    
    var html = '';
    for (var i = 0; i < mappings.length; i++) {
        var mapping = mappings[i];
        
        // Get available categories for this layer type
        var availableCategories = getAvailableCategoriesForLayerType(mapping.layerType);
        
        // Create category options HTML
        var categoryOptionsHTML = '<option value="">Select Category</option>';
        if (availableCategories.indexOf('text') !== -1) {
            categoryOptionsHTML += '<option value="text">üìù Text</option>';
        }
        if (availableCategories.indexOf('number') !== -1) {
            categoryOptionsHTML += '<option value="number">üî¢ Numbers</option>';
        }
        if (availableCategories.indexOf('image') !== -1) {
            categoryOptionsHTML += '<option value="image">üñºÔ∏è Images</option>';
        }
        
        // Add layer type indicator
        var layerTypeIndicator = '';
        switch (mapping.layerType) {
            case 'TEXT':
                layerTypeIndicator = '<div style="color: #0066ff; font-size: 11px; margin-bottom: 6px;">üìù Text layers</div>';
                break;
            case 'OTHER':
                layerTypeIndicator = '<div style="color: #ff6600; font-size: 11px; margin-bottom: 6px;">üñºÔ∏è Image layers</div>';
                break;
            case 'MIXED':
                layerTypeIndicator = '<div style="color: #9933cc; font-size: 11px; margin-bottom: 6px;">üéØ Mixed layers</div>';
                break;
        }
        
        // Add saved configuration indicator
        var savedConfigIndicator = '';
        if (mapping.isPreConfigured) {
            savedConfigIndicator = '<div style="color: #00aa00; font-size: 11px; margin-bottom: 6px;">üíæ Previously configured</div>';
        }
        
        html += '<div class="mapping-item">';
        html += '<div class="mapping-header">';
        html += '<div>';
        html += '<div class="layer-name">' + mapping.layerName + '</div>';
        html += '<div class="layer-count">' + mapping.count + ' layer' + (mapping.count > 1 ? 's' : '') + '</div>';
        html += '</div>';
        html += '<button class="remove-btn" onclick="handleRemoveMapping(\'' + mapping.layerName + '\')">Remove</button>';
        html += '</div>';
        html += layerTypeIndicator;
        html += savedConfigIndicator;
        html += '<div class="data-type-selector">';
        
        // Category selector with filtered options
        html += '<select class="category-select" onchange="handleCategoryChange(\'' + mapping.layerName + '\', this.value)">';
        html += categoryOptionsHTML;
        html += '</select>';
        
        // Type selector
        html += '<select class="type-select" disabled onchange="handleTypeChange(\'' + mapping.layerName + '\', this.value)">';
        html += '<option value="">Select Type</option>';
        html += '</select>';
        
        html += '</div>';
        
        // Integer-specific controls (initially hidden)
        html += '<div class="integer-controls" id="integer-controls-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" style="display: none; margin-top: 12px; padding: 12px; background: #f0f4f8; border-radius: 6px; border: 1px solid #e1e8ed;">';
        html += '<div style="font-weight: 500; margin-bottom: 8px; color: #1a1a1a;">üî¢ Number Generation Settings</div>';
        
        // Checkboxes row
        html += '<div style="display: flex; gap: 16px; margin-bottom: 12px;">';
        html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">';
        html += '<input type="checkbox" id="decimals-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" onchange="updateIntegerSettings(\'' + mapping.layerName + '\')">';
        html += '<span style="font-size: 12px;">Include 2 decimals</span>';
        html += '</label>';
        html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">';
        html += '<input type="checkbox" id="format-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" onchange="updateIntegerSettings(\'' + mapping.layerName + '\')">';
        html += '<span style="font-size: 12px;">Format with commas</span>';
        html += '</label>';
        html += '</div>';
        
        // Range inputs row
        html += '<div style="display: flex; gap: 12px; margin-bottom: 12px;">';
        html += '<div style="flex: 1;">';
        html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Min Value</label>';
        html += '<input type="number" id="min-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" value="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="updateIntegerSettings(\'' + mapping.layerName + '\')">';
        html += '</div>';
        html += '<div style="flex: 1;">';
        html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Max Value</label>';
        html += '<input type="number" id="max-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" value="1000" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="updateIntegerSettings(\'' + mapping.layerName + '\')">';
        html += '</div>';
        html += '</div>';
        
        // Prefix and Sort row
        html += '<div style="display: flex; gap: 12px; margin-bottom: 12px;">';
        html += '<div style="flex: 1;">';
        html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Prefix (optional)</label>';
        html += '<input type="text" id="prefix-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" placeholder="e.g., $, #, etc." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="updateIntegerSettings(\'' + mapping.layerName + '\')">';
        html += '</div>';
        html += '<div style="flex: 1;">';
        html += '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #666;">Sort Order</label>';
        html += '<select id="sort-' + mapping.layerName.replace(/[^a-zA-Z0-9]/g, '') + '" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="updateIntegerSettings(\'' + mapping.layerName + '\')">';
        html += '<option value="none">None (Random)</option>';
        html += '<option value="ascending">Ascending ‚ÜóÔ∏è</option>';
        html += '<option value="descending">Descending ‚ÜòÔ∏è</option>';
        html += '</select>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
    }
    
    mappingsContainer.innerHTML = html;
    
    // Auto-populate saved configurations
    for (var i = 0; i < mappings.length; i++) {
        var mapping = mappings[i];
        if (mapping.dataTypeId) {
            autoPopulateMapping(mapping.layerName, mapping.dataTypeId, mapping.layerType);
        }
    }
    
    applyButton.disabled = false;
    
    // Load integer settings after rendering
    loadIntegerSettings();
}

function handleRemoveMapping(layerName) {
    parent.postMessage({ 
        pluginMessage: { 
            type: 'remove-mapping', 
            layerName: layerName 
        } 
    }, '*');
}

function handleCategoryChange(layerName, category) {
    var mappingItem = document.querySelector('[data-layer="' + layerName + '"]');
    if (!mappingItem) {
        // Find by layer name in the DOM
        var mappingItems = document.querySelectorAll('.mapping-item');
        for (var i = 0; i < mappingItems.length; i++) {
            var item = mappingItems[i];
            var nameElement = item.querySelector('.layer-name');
            if (nameElement && nameElement.textContent === layerName) {
                mappingItem = item;
                break;
            }
        }
    }
    
    if (!mappingItem) return;
    
    var typeSelect = mappingItem.querySelector('.type-select');
    
    // Clear and populate type select
    typeSelect.innerHTML = '<option value="">Select Type</option>';
    
    if (category && dataTypes[category]) {
        typeSelect.disabled = false;
        var types = dataTypes[category];
        for (var i = 0; i < types.length; i++) {
            var type = types[i];
            var option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.label;
            typeSelect.appendChild(option);
        }
    } else {
        typeSelect.disabled = true;
    }
    
    // Update mapping
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            currentMappings[i].dataTypeId = null;
            break;
        }
    }
}

function handleTypeChange(layerName, dataTypeId) {
    for (var i = 0; i < currentMappings.length; i++) {
        if (currentMappings[i].layerName === layerName) {
            currentMappings[i].dataTypeId = dataTypeId;
            break;
        }
    }
    
    // Show/hide integer controls based on selection
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    var integerControls = document.getElementById('integer-controls-' + cleanLayerName);
    
    if (integerControls) {
        if (dataTypeId === 'integer') {
            integerControls.style.display = 'block';
        } else {
            integerControls.style.display = 'none';
        }
    }
}

// Store integer settings for each mapping
var integerSettings = {};

// Configuration storage key for integer settings
var INTEGER_SETTINGS_STORAGE_KEY = 'integerSettings';

// Store integer generation context
var currentIntegerGenerationContext = {
    layerName: null,
    count: 0,
    generatedNumbers: []
};

function generateCustomIntegerArray(count, layerName) {
    // Get settings for the layer
    var settings = integerSettings[layerName] || {
        includeDecimals: false,
        formatWithCommas: false,
        minValue: 1,
        maxValue: 1000,
        prefix: '',
        sortOrder: 'none'
    };
    
    var minVal = settings.minValue;
    var maxVal = settings.maxValue;
    
    // Ensure min is less than max
    if (minVal >= maxVal) {
        maxVal = minVal + 1000;
    }
    
    var numbers = [];
    var generatedSet = new Set();
    var maxAttempts = Math.min(1000, (maxVal - minVal + 1) * 2); // Reasonable limit for unique attempts
    
    // Generate the required number of values
    for (var i = 0; i < count; i++) {
        var number;
        var attempts = 0;
        
        // Try to generate a unique number
        do {
            if (settings.includeDecimals) {
                // Generate with 2 decimal places
                var baseNumber = Math.random() * (maxVal - minVal) + minVal;
                number = Math.round(baseNumber * 100) / 100;
            } else {
                // Generate integer
                number = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
            }
            attempts++;
        } while (generatedSet.has(number) && attempts < maxAttempts);
        
        // Add to set to track uniqueness
        generatedSet.add(number);
        numbers.push(number);
    }
    
    // Apply sorting if specified
    if (settings.sortOrder === 'ascending') {
        numbers.sort(function(a, b) { return a - b; });
    } else if (settings.sortOrder === 'descending') {
        numbers.sort(function(a, b) { return b - a; });
    }
    // 'none' means no sorting - keep random order
    
    // Format all numbers
    var formattedNumbers = numbers.map(function(number) {
        var formattedNumber = number.toString();
        
        if (settings.formatWithCommas && !settings.includeDecimals) {
            // Add comma formatting for integers
            formattedNumber = number.toLocaleString();
        } else if (settings.formatWithCommas && settings.includeDecimals) {
            // Add comma formatting for decimals (ensure 2 decimal places)
            formattedNumber = number.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } else if (settings.includeDecimals) {
            // Ensure 2 decimal places without comma formatting
            formattedNumber = number.toFixed(2);
        }
        
        // Add prefix if specified
        if (settings.prefix) {
            formattedNumber = settings.prefix + formattedNumber;
        }
        
        return formattedNumber;
    });
    
    return formattedNumbers;
}

// Legacy function for single number generation (fallback)
function generateCustomInteger() {
    // This function is kept for backwards compatibility but shouldn't be used
    // in the new array-based generation approach
    console.warn('‚ö†Ô∏è Using legacy single integer generation - should use array generation instead');
    var settings = integerSettings[currentIntegerGenerationContext.layerName] || {
        includeDecimals: false,
        formatWithCommas: false,
        minValue: 1,
        maxValue: 1000,
        prefix: '',
        sortOrder: 'none'
    };
    
    var minVal = settings.minValue;
    var maxVal = settings.maxValue;
    
    if (minVal >= maxVal) {
        maxVal = minVal + 1000;
    }
    
    var number;
    if (settings.includeDecimals) {
        var baseNumber = Math.random() * (maxVal - minVal) + minVal;
        number = Math.round(baseNumber * 100) / 100;
    } else {
        number = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
    }
    
    var formattedNumber = number.toString();
    
    if (settings.formatWithCommas && !settings.includeDecimals) {
        formattedNumber = number.toLocaleString();
    } else if (settings.formatWithCommas && settings.includeDecimals) {
        formattedNumber = number.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } else if (settings.includeDecimals) {
        formattedNumber = number.toFixed(2);
    }
    
    if (settings.prefix) {
        formattedNumber = settings.prefix + formattedNumber;
    }
    
    return formattedNumber;
}

function updateIntegerSettings(layerName) {
    var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
    
    var decimalsCheckbox = document.getElementById('decimals-' + cleanLayerName);
    var formatCheckbox = document.getElementById('format-' + cleanLayerName);
    var minInput = document.getElementById('min-' + cleanLayerName);
    var maxInput = document.getElementById('max-' + cleanLayerName);
    var prefixInput = document.getElementById('prefix-' + cleanLayerName);
    var sortSelect = document.getElementById('sort-' + cleanLayerName);
    
    if (!integerSettings[layerName]) {
        integerSettings[layerName] = {};
    }
    
    integerSettings[layerName] = {
        includeDecimals: decimalsCheckbox ? decimalsCheckbox.checked : false,
        formatWithCommas: formatCheckbox ? formatCheckbox.checked : false,
        minValue: minInput ? parseInt(minInput.value) || 1 : 1,
        maxValue: maxInput ? parseInt(maxInput.value) || 1000 : 1000,
        prefix: prefixInput ? prefixInput.value || '' : '',
        sortOrder: sortSelect ? sortSelect.value || 'none' : 'none'
    };
    
    console.log('Updated integer settings for', layerName, ':', integerSettings[layerName]);
    
    // Auto-save integer settings
    saveIntegerSettings();
}

// Save integer settings to storage
function saveIntegerSettings() {
    try {
        parent.postMessage({
            pluginMessage: {
                type: 'store-integer-settings',
                data: integerSettings
            }
        }, '*');
        console.log('üíæ Integer settings saved');
    } catch (error) {
        console.error('Error saving integer settings:', error);
    }
}

// Load integer settings from storage  
function loadIntegerSettings() {
    try {
        parent.postMessage({
            pluginMessage: {
                type: 'load-integer-settings'
            }
        }, '*');
    } catch (error) {
        console.error('Error loading integer settings:', error);
    }
}

// Populate integer controls with loaded settings
function populateIntegerControlsFromSettings() {
    // Go through all current mappings and populate integer controls
    for (var layerName in integerSettings) {
        var settings = integerSettings[layerName];
        var cleanLayerName = layerName.replace(/[^a-zA-Z0-9]/g, '');
        
        // Check if controls exist for this layer
        var decimalsCheckbox = document.getElementById('decimals-' + cleanLayerName);
        if (decimalsCheckbox) {
            decimalsCheckbox.checked = settings.includeDecimals || false;
        }
        
        var formatCheckbox = document.getElementById('format-' + cleanLayerName);
        if (formatCheckbox) {
            formatCheckbox.checked = settings.formatWithCommas || false;
        }
        
        var minInput = document.getElementById('min-' + cleanLayerName);
        if (minInput) {
            minInput.value = settings.minValue || 1;
        }
        
        var maxInput = document.getElementById('max-' + cleanLayerName);
        if (maxInput) {
            maxInput.value = settings.maxValue || 1000;
        }
        
        var prefixInput = document.getElementById('prefix-' + cleanLayerName);
        if (prefixInput) {
            prefixInput.value = settings.prefix || '';
        }
        
        var sortSelect = document.getElementById('sort-' + cleanLayerName);
        if (sortSelect) {
            sortSelect.value = settings.sortOrder || 'none';
        }
        
        console.log('üîß Populated integer controls for', layerName, 'with settings:', settings);
    }
}

// Data generation using faker.js and external APIs
function generateData(dataTypeId, count, layerName) {
    // Check if bundled Faker.js is available
    if (window.fakerLoaded && window.faker) {
        console.log('‚úÖ Using bundled real Faker.js for data generation');
        return Promise.resolve(generateDataWithFaker(dataTypeId, count, window.faker, layerName));
    } else {
        console.warn('‚ö†Ô∏è Bundled Faker.js not available, using fallback generators');
        return Promise.resolve(generateDataFallback(dataTypeId, count, layerName));
    }
}

// Generate data with Faker.js
function generateDataWithFaker(dataTypeId, count, fakerLib, layerName) {
    // Use custom array generation for integers
    if (dataTypeId === 'integer') {
        console.log('üî¢ Using custom integer array generation for:', layerName, 'count:', count);
        return generateCustomIntegerArray(count, layerName);
    }
    
    // External API generators
    if (dataTypeId === 'user_api') {
        return fetch('https://randomuser.me/api/?results=' + count)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                return data.results.map(function(user) {
                    return user.name.first + ' ' + user.name.last;
                });
            })
            .catch(function(error) {
                console.error('RandomUser API failed:', error);
                // Fallback to faker
                var fallback = [];
                for (var i = 0; i < count; i++) {
                    fallback.push(window.faker ? window.faker.person.fullName() : 'API Error');
                }
                return fallback;
            });
    }
    
    if (dataTypeId === 'product_api') {
        return fetch('https://dummyjson.com/products?limit=' + Math.min(count, 100))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var products = data.products.map(function(product) {
                    return product.title;
                });
                // Repeat if we need more than available
                var result = [];
                for (var i = 0; i < count; i++) {
                    result.push(products[i % products.length]);
                }
                return result;
            })
            .catch(function(error) {
                console.error('DummyJSON API failed:', error);
                // Fallback to faker
                var fallback = [];
                for (var i = 0; i < count; i++) {
                    fallback.push(window.faker ? window.faker.commerce.productName() : 'API Error');
                }
                return fallback;
            });
    }
    
    if (dataTypeId === 'avatar_randomuser') {
        // Mixed gender real people photos
        console.log('üë• Fetching mixed gender real people photos');
        return fetchRandomUserPhotos(count);
    }
    
    if (dataTypeId === 'avatar_randomuser_male') {
        // Male-only real people photos
        console.log('üë® Fetching male real people photos');
        return fetchRandomUserPhotos(count, 'male');
    }
    
    if (dataTypeId === 'avatar_randomuser_female') {
        // Female-only real people photos
        console.log('üë© Fetching female real people photos');
        return fetchRandomUserPhotos(count, 'female');
    }
    
    if (dataTypeId === 'avatar_pravatar') {
        // Pravatar real profile photos
        console.log('üë§ Fetching Pravatar profile photos');
        return fetchPravatarPhotos(count);
    }
    
    if (dataTypeId === 'avatar_multiavatar') {
        // Multiavatar unique generated avatars
        console.log('üé® Generating Multiavatar unique avatars');
        return fetchMultiavatarPhotos(count);
    }
    
    if (dataTypeId === 'avatar_robohash') {
        // RoboHash robot/monster avatars
        console.log('ü§ñ Generating RoboHash robot avatars');
        return fetchRobohashPhotos(count);
    }
    
         // Helper function to generate DiceBear avatars
     function generateDiceBearAvatars(count) {
         var results = [];
         var styles = ['avataaars', 'big-smile', 'fun-emoji', 'personas'];
         for (var i = 0; i < count; i++) {
             var style = styles[Math.floor(Math.random() * styles.length)];
             var seed = Math.random().toString(36).substring(7);
             results.push('https://api.dicebear.com/7.x/' + style + '/png?seed=' + seed + '&backgroundColor=transparent&size=200');
         }
         console.log('‚úÖ Generated', results.length, 'DiceBear avatars as fallback');
         return results;
     }
     
     // RandomUser.me photos with gender selection and CORS proxy
     function fetchRandomUserPhotos(count, gender) {
         return new Promise(function(resolve) {
             var genderParam = gender ? '&gender=' + gender : '';
             var apiUrl = 'https://randomuser.me/api/?results=' + count + '&inc=picture' + genderParam;
             
             console.log('üîÑ Trying RandomUser.me directly...');
             fetch(apiUrl)
                 .then(function(response) {
                     if (!response.ok) throw new Error('RandomUser direct failed');
                     return response.json();
                 })
                 .then(function(data) {
                     var results = data.results.map(function(user) {
                         return user.picture.large;
                     });
                     console.log('‚úÖ RandomUser.me direct SUCCESS!');
                     resolve(results);
                 })
                 .catch(function(error) {
                     console.log('‚ùå Direct failed, trying CORS proxy...');
                     fetch('https://corsproxy.io/?' + encodeURIComponent(apiUrl))
                         .then(function(response) {
                             if (!response.ok) throw new Error('CORS proxy failed');
                             return response.json();
                         })
                         .then(function(data) {
                             var results = data.results.map(function(user) {
                                 return user.picture.large;
                             });
                             console.log('‚úÖ RandomUser.me CORS proxy SUCCESS!');
                             resolve(results);
                         })
                         .catch(function(proxyError) {
                             console.log('‚ùå All RandomUser methods failed, using DiceBear fallback');
                             resolve(generateDiceBearAvatars(count));
                         });
                 });
         });
     }
     
     // Pravatar real profile photos with CORS proxy
     function fetchPravatarPhotos(count) {
         return new Promise(function(resolve) {
             var results = [];
             for (var i = 0; i < count; i++) {
                 var userId = Math.floor(Math.random() * 70) + 1; // They have about 70 users
                 results.push('https://i.pravatar.cc/200?img=' + userId);
             }
             console.log('‚úÖ Generated', results.length, 'Pravatar URLs (will use CORS proxy if needed)');
             resolve(results);
         });
     }
     
     // Multiavatar unique generated avatars with CORS proxy
     function fetchMultiavatarPhotos(count) {
         return new Promise(function(resolve) {
             var results = [];
             for (var i = 0; i < count; i++) {
                 var seed = Math.random().toString(36).substring(7);
                 results.push('https://api.multiavatar.com/' + seed + '.png');
             }
             console.log('‚úÖ Generated', results.length, 'Multiavatar URLs (will use CORS proxy if needed)');
             resolve(results);
         });
     }
     
     // RoboHash robot/monster avatars with CORS proxy
     function fetchRobohashPhotos(count) {
         return new Promise(function(resolve) {
             var results = [];
             for (var i = 0; i < count; i++) {
                 var seed = Math.random().toString(36).substring(7);
                 var sets = ['set1', 'set2', 'set3', 'set4']; // robots, monsters, heads, cats
                 var randomSet = sets[Math.floor(Math.random() * sets.length)];
                 results.push('https://robohash.org/' + seed + '.png?size=200x200&set=' + randomSet);
             }
             console.log('‚úÖ Generated', results.length, 'RoboHash URLs (will use CORS proxy if needed)');
             resolve(results);
         });
     }
    

    
    if (dataTypeId === 'product_image') {
        return fetch('https://dummyjson.com/products?limit=' + Math.min(count, 100))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var images = data.products.map(function(product) {
                    return product.thumbnail;
                });
                // Repeat if we need more than available
                var result = [];
                for (var i = 0; i < count; i++) {
                    result.push(images[i % images.length]);
                }
                return result;
            })
            .catch(function(error) {
                console.error('DummyJSON API failed:', error);
                // Fallback to Picsum
                var fallback = [];
                for (var i = 0; i < count; i++) {
                    fallback.push('https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000));
                }
                return fallback;
            });
    }
    

    
    // Static URL generators (no API calls needed)
    var staticGenerators = {
        avatar_dicebear: function() {
            // Use PNG format instead of SVG because Figma doesn't support SVG in createImage()
            return 'https://api.dicebear.com/7.x/avataaars/png?seed=' + Math.random().toString(36).substring(7) + '&size=200&backgroundColor=transparent';
        },
        image_picsum: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000);
        },
        image_unsplash: function() {
            // Using Lorem Picsum as fallback since Unsplash Source API was shut down in June 2024
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        },
        // Enhanced Unsplash categories using Lorem Picsum
        unsplash_nature: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        },
        unsplash_people: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        },
        unsplash_business: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        },
        unsplash_food: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        },
        unsplash_travel: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        },
        unsplash_tech: function() {
            return 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 10000);
        }
    };
    
    if (staticGenerators[dataTypeId]) {
        console.log('üñºÔ∏è Using static image generator for:', dataTypeId);
        var results = [];
        for (var i = 0; i < count; i++) {
            results.push(staticGenerators[dataTypeId]());
        }
        console.log('‚úÖ Generated', results.length, 'image URLs:', results.slice(0, 3));
        return Promise.resolve(results);
    }
    
    // Faker.js generators
    var generators = {
        name: function() { return window.faker.person.fullName(); },
        username: function() { return window.faker.internet.userName(); },
        city: function() { return window.faker.location.city(); },
        country: function() { return window.faker.location.country(); },
        company: function() { return window.faker.company.name(); },
        email: function() { return window.faker.internet.email(); },
        product_name: function() { return window.faker.commerce.productName(); },
        post_title: function() { return window.faker.lorem.sentence(); },
        description: function() { return window.faker.lorem.paragraph(); },
        lorem: function() { return window.faker.lorem.words(); },
        integer: function() { 
            // Custom integer generation - replaced faker.js
            return generateCustomInteger();
        },
        decimal: function() { return window.faker.number.float({ min: 0, max: 100, fractionDigits: 2 }); },
        currency: function() { return '$' + window.faker.finance.amount(); },
        date: function() { return window.faker.date.anytime().toLocaleDateString(); },
        phone: function() { return window.faker.phone.number(); },
        percentage: function() { return window.faker.number.int({ min: 0, max: 100 }) + '%'; }
    };
    
    var generator = generators[dataTypeId];
    if (generator) {
        var results = [];
        for (var i = 0; i < count; i++) {
            results.push(String(generator()));
        }
        console.log('‚úÖ Successfully generated', results.length, 'items using REAL Faker.js data for:', dataTypeId);
        console.log('Sample data:', results.slice(0, 3));
        return results;
    }
    
    // If data type not supported with Faker.js, use fallback
    return generateDataFallback(dataTypeId, count);
}

// Fallback data generation without Faker.js
function generateDataFallback(dataTypeId, count, layerName) {
    // Use custom array generation for integers
    if (dataTypeId === 'integer') {
        console.log('üî¢ Using custom integer array generation (fallback) for:', layerName, 'count:', count);
        return generateCustomIntegerArray(count, layerName);
    }
    var results = [];
    
    // Simple hardcoded data generators (fallback when Faker.js isn't available)
    var fallbackGenerators = {
        name: function() { 
            var firstNames = ['John', 'Jane', 'Alex', 'Sarah', 'Mike', 'Emma', 'David', 'Lisa'];
            var lastNames = ['Smith', 'Johnson', 'Brown', 'Wilson', 'Davis', 'Miller', 'Moore', 'Taylor'];
            return firstNames[Math.floor(Math.random() * firstNames.length)] + ' ' + 
                   lastNames[Math.floor(Math.random() * lastNames.length)];
        },
        username: function() { return 'user' + Math.floor(Math.random() * 10000); },
        city: function() { 
            var cities = ['New York', 'London', 'Paris', 'Tokyo', 'Sydney', 'Berlin', 'Toronto', 'San Francisco'];
            return cities[Math.floor(Math.random() * cities.length)];
        },
        country: function() { 
            var countries = ['United States', 'United Kingdom', 'France', 'Japan', 'Australia', 'Germany', 'Canada'];
            return countries[Math.floor(Math.random() * countries.length)];
        },
        company: function() { 
            var companies = ['TechCorp', 'InnovateLabs', 'FutureSoft', 'DesignStudio', 'BuildCo'];
            return companies[Math.floor(Math.random() * companies.length)];
        },
        email: function() { 
            var names = ['john', 'jane', 'alex', 'sarah'];
            var domains = ['example.com', 'test.org', 'demo.net'];
            return names[Math.floor(Math.random() * names.length)] + '@' + 
                   domains[Math.floor(Math.random() * domains.length)];
        },
        product_name: function() { 
            var products = ['Awesome Widget', 'Super Tool', 'Magic Device', 'Smart Gadget', 'Pro Equipment'];
            return products[Math.floor(Math.random() * products.length)];
        },
        post_title: function() { 
            var titles = ['How to Build Amazing Products', 'The Future of Design', '10 Tips for Success', 'Getting Started with Code'];
            return titles[Math.floor(Math.random() * titles.length)];
        },
        description: function() { return 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore.'; },
        lorem: function() { 
            var words = ['lorem ipsum', 'dolor sit amet', 'consectetur adipiscing', 'elit sed do', 'eiusmod tempor'];
            return words[Math.floor(Math.random() * words.length)];
        },
        integer: function() { 
            // Custom integer generation - replaced faker.js
            return generateCustomInteger();
        },
        decimal: function() { return (Math.random() * 100).toFixed(2); },
        currency: function() { return '$' + (Math.random() * 999 + 1).toFixed(2); },
        date: function() { return new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toLocaleDateString(); },
        phone: function() { return '+1-' + Math.floor(Math.random() * 900 + 100) + '-' + Math.floor(Math.random() * 900 + 100) + '-' + Math.floor(Math.random() * 9000 + 1000); },
        percentage: function() { return Math.floor(Math.random() * 100) + '%'; }
    };
    
    var generator = fallbackGenerators[dataTypeId];
    if (generator) {
        for (var i = 0; i < count; i++) {
            results.push(String(generator()));
        }
        console.log('‚ö†Ô∏è Generated', results.length, 'items using FALLBACK generators (not Faker.js) for:', dataTypeId);
        console.log('Sample data:', results.slice(0, 3));
        return results;
    }
    
    // If no generator found, return placeholder
    for (var i = 0; i < count; i++) {
        results.push('Data type not supported: ' + dataTypeId);
    }
    return results;
}

// Load image data using fetch with CORS workarounds
function loadImageData(imageUrl) {
    console.log('üîÑ Loading image from URL:', imageUrl);
    
    return tryImageWithCorsWorkarounds(imageUrl);
}

// Try multiple methods to load images with CORS workarounds
function tryImageWithCorsWorkarounds(imageUrl) {
    return new Promise(function(resolve) {
        // Method 1: Direct fetch
        console.log('üîÑ Image Method 1: Direct fetch...');
        fetch(imageUrl)
            .then(function(response) {
                if (!response.ok) throw new Error('Direct fetch failed: ' + response.status);
                return response.arrayBuffer();
            })
            .then(function(arrayBuffer) {
                console.log('‚úÖ Image Method 1 SUCCESS: Direct fetch worked!');
                resolve(new Uint8Array(arrayBuffer));
            })
            .catch(function(error) {
                console.log('‚ùå Image Method 1 failed:', error.message);
                
                // Method 2: Try with no-cors mode (for some services)
                console.log('üîÑ Image Method 2: Trying no-cors mode...');
                fetch(imageUrl, { mode: 'no-cors' })
                    .then(function(response) {
                        // no-cors mode returns opaque response, we can't read the body
                        // but we can at least check if the request succeeded
                        if (response.type === 'opaque') {
                            // For no-cors, we can't get the actual image data
                            // So we'll try a CORS proxy instead
                            throw new Error('No-cors mode returned opaque response');
                        }
                        return response.arrayBuffer();
                    })
                    .then(function(arrayBuffer) {
                        console.log('‚úÖ Image Method 2 SUCCESS: No-cors mode worked!');
                        resolve(new Uint8Array(arrayBuffer));
                    })
                    .catch(function(noCorsError) {
                        console.log('‚ùå Image Method 2 failed:', noCorsError.message);
                        
                        // Method 3: Try with CORS proxy
                        console.log('üîÑ Image Method 3: Trying CORS proxy...');
                        var proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(imageUrl);
                        fetch(proxyUrl)
                            .then(function(response) {
                                if (!response.ok) throw new Error('CORS proxy failed: ' + response.status);
                                return response.arrayBuffer();
                            })
                            .then(function(arrayBuffer) {
                                console.log('‚úÖ Image Method 3 SUCCESS: CORS proxy worked!');
                                resolve(new Uint8Array(arrayBuffer));
                            })
                            .catch(function(proxyError) {
                                console.log('‚ùå Image Method 3 failed:', proxyError.message);
                                
                                // Method 4: Generate a fallback based on the original URL type
                                console.log('üîÑ Image Method 4: Generating fallback...');
                                var fallbackUrl;
                                
                                                                 if (imageUrl.includes('randomuser.me') || imageUrl.includes('ui-avatars.com') || imageUrl.includes('pravatar.cc') || imageUrl.includes('multiavatar.com') || imageUrl.includes('robohash.org')) {
                                     // Avatar fallback
                                     fallbackUrl = 'https://api.dicebear.com/7.x/avataaars/png?seed=' + Math.random().toString(36).substring(7) + '&size=200&backgroundColor=transparent';
                                 } else {
                                     // General image fallback
                                     fallbackUrl = 'https://picsum.photos/400/300?random=' + Math.floor(Math.random() * 1000);
                                 }
                                
                                fetch(fallbackUrl)
                                    .then(function(response) {
                                        if (!response.ok) throw new Error('Fallback failed');
                                        return response.arrayBuffer();
                                    })
                                    .then(function(arrayBuffer) {
                                        console.log('‚úÖ Image Method 4 SUCCESS: Fallback image loaded!');
                                        resolve(new Uint8Array(arrayBuffer));
                                    })
                                    .catch(function(fallbackError) {
                                        console.log('‚ùå Image Method 4 failed:', fallbackError.message);
                                        console.error('‚ùå All image loading methods failed for:', imageUrl);
                                        resolve(null);
                                    });
                            });
                    });
            });
    });
}

// Listen for messages from the main plugin code
window.addEventListener('message', function(event) {
    var msg = event.data.pluginMessage;
    if (!msg) return;
    
    if (msg.type === 'layers-scanned') {
        setLoadingState(scanButton, scanText, scanLoading, false);
        renderMappings(msg.data.mappings, msg.data.savedConfigurations);
        
        var preconfiguredCount = msg.data.mappings.filter(function(m) { return m.isPreConfigured; }).length;
        var statusMsg = 'Found ' + msg.data.mappings.length + ' layer mapping' + (msg.data.mappings.length > 1 ? 's' : '');
        if (preconfiguredCount > 0) {
            statusMsg += ' (' + preconfiguredCount + ' pre-configured)';
        }
        
        if (msg.data.mappings.length > 0) {
            showStatusMessage(statusMsg);
        } else {
            showStatusMessage('No layers with % prefixes found in selection', 'error');
        }
    } else if (msg.type === 'integer-settings-loaded') {
        // Restore integer settings from storage
        if (msg.data && Object.keys(msg.data).length > 0) {
            integerSettings = msg.data;
            console.log('üì• Integer settings restored:', integerSettings);
            // Populate the UI controls with loaded settings
            populateIntegerControlsFromSettings();
        }
    } else if (msg.type === 'mapping-removed') {
        currentMappings = currentMappings.filter(function(m) { return m.layerName !== msg.data.layerName; });
        renderMappings(currentMappings);
        showStatusMessage('Mapping removed');
    } else if (msg.type === 'data-applied') {
        setLoadingState(applyButton, applyText, applyLoading, false);
        showStatusMessage(msg.message);
    } else if (msg.type === 'error') {
        setLoadingState(scanButton, scanText, scanLoading, false);
        setLoadingState(applyButton, applyText, applyLoading, false);
        showStatusMessage(msg.message, 'error');
    } else if (msg.type === 'generate-data') {
        // Generate data and send back to main code
        Promise.resolve(generateData(msg.dataTypeId, msg.count, msg.layerName))
            .then(function(data) {
                parent.postMessage({
                    pluginMessage: {
                        type: 'data-generated',
                        requestId: msg.requestId,
                        data: data
                    }
                }, '*');
            })
            .catch(function(error) {
                console.error('Data generation failed:', error);
                parent.postMessage({
                    pluginMessage: {
                        type: 'data-generated',
                        requestId: msg.requestId,
                        data: Array(msg.count).fill('Generation failed')
                    }
                }, '*');
            });
    } else if (msg.type === 'load-image') {
        // Load image and send back to main code
        console.log('üì® Received image load request:', msg.requestId, msg.url);
        loadImageData(msg.url)
            .then(function(imageData) {
                console.log('üì§ Sending image data response:', msg.requestId, imageData ? 'Success' : 'Failed');
                parent.postMessage({
                    pluginMessage: {
                        type: 'image-loaded',
                        requestId: msg.requestId,
                        data: imageData
                    }
                }, '*');
            })
            .catch(function(error) {
                console.error('‚ùå Image loading failed:', error);
                parent.postMessage({
                    pluginMessage: {
                        type: 'image-loaded',
                        requestId: msg.requestId,
                        data: null
                    }
                }, '*');
            });
    }
});
    </script>
</body>
</html> 